Ext.define("Extensible",{singleton:true,version:"1.6.0-rc.1",versionDetails:{major:1,minor:6,patch:0},extVersion:"4.0.1",hasBorderRadius:Ext.supports.CSS3BorderRadius,log:function(e){console.log(e)},getScrollWidth:function(){return Ext.getScrollbarSize?Ext.getScrollbarSize().width:Ext.getScrollBarWidth()},constructor:function(){Ext.onReady(function(){if(this.getScrollWidth()<3){Ext.getBody().addCls("x-no-scrollbar")}if(Ext.isWindows){Ext.getBody().addCls("x-win")}if(Ext.getVersion("extjs").isLessThan("4.1")){Ext.getBody().addCls("x-4-0")}},this)},Date:{use24HourTime:false,diff:function(e,t,n){var r=1,i=t.getTime()-e.getTime();if(n==="s"||n==="seconds"){r=1e3}else if(n==="m"||n==="minutes"){r=1e3*60}else if(n==="h"||n==="hours"){r=1e3*60*60}return Math.round(i/r)},diffDays:function(e,t){var n=1e3*60*60*24,r=Ext.Date.clearTime,i=(e.getTimezoneOffset()-t.getTimezoneOffset())*60*1e3,s=r(t,true).getTime()-r(e,true).getTime()+i,o=Math.round(s/n);return o},copyTime:function(e,t){var n=Ext.Date.clone(t);n.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds());return n},compare:function(e,t,n){var r=e,i=t;if(n!==true){r=Ext.Date.clone(e);r.setMilliseconds(0);i=Ext.Date.clone(t);i.setMilliseconds(0)}return i.getTime()-r.getTime()},maxOrMin:function(e){var t=e?0:Number.MAX_VALUE,n=0,r=arguments[1],i=r.length;for(;n<i;n++){t=Math[e?"max":"min"](t,r[n].getTime())}return new Date(t)},max:function(){return this.maxOrMin.apply(this,[true,arguments])},min:function(){return this.maxOrMin.apply(this,[false,arguments])},isInRange:function(e,t,n){return e>=t&&e<=n},rangesOverlap:function(e,t,n,r){var i=e>=n&&e<=r,s=t>=n&&t<=r,o=e<=n&&t>=r;return i||s||o},isWeekend:function(e){return e.getDay()%6===0},isWeekday:function(e){return e.getDay()%6!==0},isMidnight:function(e){return e.getHours()===0&&e.getMinutes()===0},isToday:function(e){return this.diffDays(e,this.today())===0},today:function(){return Ext.Date.clearTime(new Date)},add:function(e,t){if(!t){return e}var n=Ext.Date,r=n.add,i=n.clone(e);if(t.years){i=r(i,n.YEAR,t.years)}if(t.months){i=r(i,n.MONTH,t.months)}if(t.weeks){t.days=(t.days||0)+t.weeks*7}if(t.days){i=r(i,n.DAY,t.days)}if(t.hours){i=r(i,n.HOUR,t.hours)}if(t.minutes){i=r(i,n.MINUTE,t.minutes)}if(t.seconds){i=r(i,n.SECOND,t.seconds)}if(t.millis){i=r(i,n.MILLI,t.millis)}return t.clearTime?n.clearTime(i):i},clearTime:function(e,t){return Ext.Date.clearTime(e,t)}}});Ext.require(["Ext.picker.Color","Ext.form.Basic","Ext.data.proxy.Memory"]);Extensible.applyOverrides=function(){var e=Ext.getVersion("extjs");if(Ext.layout.container.AbstractCard){Ext.layout.container.AbstractCard.override({renderChildren:function(){if(!this.deferredRender){this.getActiveItem();this.callParent()}}})}Ext.Component.override({getId:function(){var e=this,t;if(!e.id){t=e.getXType();t=t?t.replace(/[\.,\s]/g,"-"):"ext-comp";e.id=t+"-"+e.getAutoId()}return e.id}});if(Ext.picker&&Ext.picker.Color){Ext.picker.Color.override({constructor:function(){this.renderTpl=this.renderTpl||Ext.create("Ext.XTemplate",'<tpl for="colors"><a href="#" '+'class="color-{.}" hidefocus="on"><em><span style="background:#{.}" '+'unselectable="on">&#160;</span></em></a></tpl>');this.callParent(arguments)}})}if(e.isLessThan("4.1")){if(Ext.data&&Ext.data.reader&&Ext.data.reader.Reader){Ext.data.reader.Reader.override({extractData:function(e){var t=this,n=[],r=[],i=t.model,s=0,o=e.length,u,a,f;if(!e.length&&Ext.isObject(e)){e=[e];o=1}for(;s<o;s++){u=e[s];n=t.extractValues(u);a=t.getId(n);f=new i(n,a,u);r.push(f);if(t.implicitIncludes){t.readAssociated(f,u)}}return r}})}}if(Ext.form&&Ext.form.Basic){Ext.form.Basic.override({reset:function(){var e=this;e.getFields().each(function(e){e.reset()});return e}})}if(Ext.data&&Ext.data.proxy&&Ext.data.proxy.Memory){Ext.data.proxy.Memory.override({updateOperation:function(e,t,n){Ext.each(e.records,function(e){e.commit()});e.setCompleted();e.setSuccessful();Ext.callback(t,n||this,[e])},create:function(){this.updateOperation.apply(this,arguments)},update:function(){this.updateOperation.apply(this,arguments)},destroy:function(){this.updateOperation.apply(this,arguments)}})}if(e.isLessThan("4.1")&&Ext.form&&Ext.form.CheckboxGroup){Ext.form.CheckboxGroup.override({resetOriginalValue:function(){var e=this;e.eachBox(function(e){e.resetOriginalValue()});e.originalValue=e.getValue();e.checkDirty()}})}Ext.tip.QuickTipManager.init();Extensible.calendar.view.DayBody.override({getEventTemplate:function(){if(!this.eventTpl){this.eventTpl=!(Ext.isIE||Ext.isOpera)?Ext.create("Ext.XTemplate",'<div data-qtip="<b>{Title}</b><br/>{Notes}" id="{_elId}" class="{_extraCls} ext-cal-evt ext-cal-evr" style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">','<div class="ext-evt-bd">',this.getEventBodyMarkup(),"</div>",this.enableEventResize?'<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>':"","</div>"):Ext.create("Ext.XTemplate",'<div data-qtip="<b>{Title}</b><br/>{Notes}" id="{_elId}" class="ext-cal-evt {_extraCls}" style="left: {_left}%; width: {_width}%; top: {_top}px;">','<div class="ext-cal-evb">&#160;</div>','<dl style="height: {_height}px;" class="ext-cal-evdm">','<dd class="ext-evt-bd">',this.getEventBodyMarkup(),"</dd>",this.enableEventResize?'<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>':"","</dl>",'<div class="ext-cal-evb">&#160;</div>',"</div>");this.eventTpl.compile()}return this.eventTpl}});Extensible.calendar.view.Month.override({getEventTemplate:function(){if(!this.eventTpl){var e,t=this.getEventBodyMarkup();e=!(Ext.isIE||Ext.isOpera)?Ext.create("Ext.XTemplate",'<div data-qtip="<b>{Title}</b><br/>{Notes}" class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evr">',t,"</div>"):Ext.create("Ext.XTemplate",'<tpl if="_renderAsAllDay">','<div data-qtip="<b>{Title}</b><br/>{Notes}" class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evo">','<div class="ext-cal-evm">','<div class="ext-cal-evi">',"</tpl>",'<tpl if="!_renderAsAllDay">','<div data-qtip="<b>{Title}</b><br/>{Notes}" class="{_extraCls} ext-cal-evt ext-cal-evr">',"</tpl>",t,'<tpl if="_renderAsAllDay">',"</div>","</div>","</tpl>","</div>");e.compile();this.eventTpl=e}return this.eventTpl}})};Ext.onReady(Extensible.applyOverrides);Ext.define("Extensible.lang.Number",{statics:{getOrdinalSuffix:function(e){if(!Ext.isNumber(e)){return""}switch(e){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}}}},function(){Extensible.Number=Extensible.lang.Number});Ext.define("Extensible.data.Model",{extend:"Ext.data.Model",requires:["Ext.util.MixedCollection"],mappingClass:null,mappingIdProperty:null,inheritableStatics:{reconfigure:function(){var e=this.prototype,t=Ext.ClassManager.get(e.mappingClass||""),n=e.mappingIdProperty,r,i=[],s=0,o=0;if(!t){throw"The mappingClass for "+this.$className+" is undefined or invalid"}e.idProperty=n||e.idProperty||"id";for(r in t){if(t.hasOwnProperty(r)){i.push(t[r])}}e.fields.clear();o=i.length;for(;s<o;s++){e.fields.add(Ext.create("Ext.data.Field",i[s]))}return this}},clone:function(e){var t=Ext.create(this.$className),n=this.persistenceProperty;t[n]=Ext.Object.merge({},this[n]);if(e!==true){delete t[n][this.idProperty]}return t}});Ext.define("Extensible.form.recurrence.Rule",{config:{dateValueFormat:"Ymd\\THis\\Z",rule:null,startDate:null,frequency:null,count:null,until:null,interval:1,byDay:null,byDayWeekdays:null,byMonthDay:null,byMonth:null,strings:{dayNamesShort:{SU:"Sun",MO:"Mon",TU:"Tue",WE:"Wed",TH:"Thu",FR:"Fri",SA:"Sat"},dayNamesShortByIndex:{0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"},dayNamesLong:{SU:"Sunday",MO:"Monday",TU:"Tuesday",WE:"Wednesday",TH:"Thursday",FR:"Friday",SA:"Saturday"},ordinals:{1:"first",2:"second",3:"third",4:"fourth",5:"fifth",6:"sixth"},frequency:{none:"Does not repeat",daily:"Daily",weekly:"Weekly",weekdays:"Every weekday (Mon-Fri)",monthly:"Monthly",yearly:"Yearly"},every:"Every",days:"days",weeks:"weeks",weekdays:"weekdays",months:"months",years:"years",time:"time",times:"times",until:"until",untilFormat:"M j, Y",and:"and",on:"on",onDay:"on day",onDayPostfix:"",onThe:"on the",onTheLast:"on the last",onTheLastDay:"on the last day",of:"of",monthFormat:"F",monthDayFormat:"F j"}},byDayNames:["SU","MO","TU","WE","TH","FR","SA"],constructor:function(e){return this.initConfig(e)},init:function(){var e=this;e.startDate=null;e.frequency=null;e.count=null;e.until=null;e.interval=1;e.byDay=null;e.byDayWeekdays=null;e.byDayNthWeekday=null;e.byMonthDay=null;e.byMonth=null},applyStartDate:function(e){this.startDate=new Date(e)},applyFrequency:function(e){this.init();this.frequency=e},applyCount:function(e){this.until=null;this.count=e},applyUntil:function(e){this.count=this.until=null;if(Ext.isDate(e)){this.until=e}else if(typeof e==="string"){this.until=this.parseDate(e)}},parseDate:function(e,t){t=t||{};try{var n=Ext.Date.parse(e,t.format||this.dateValueFormat,t.strict);if(n){return n}}catch(r){}return t.defaultValue||new Date},formatDate:function(e){return Ext.Date.format(e,this.dateValueFormat)},applyByDay:function(e){var t=this;t.byMonthDay=null;t.byDayWeekdays=null;t.byDayNthWeekday=null;if(typeof e==="string"){t.byDay=e;var n=parseInt(e,10);if(Ext.isNumber(n)){if(n===-1){t.byDayNthWeekday={number:n,weekday:e.substr(2,2)}}else{t.byDayNthWeekday={number:n,weekday:e.substr(1,2)}}}else{t.byDayWeekdays=e.split(",")}}else if(Array.isArray(e)){t.byDay=e.join(",");t.byDayWeekdays=e}else if(Ext.isObject(e)){t.byDay=e.number+e.weekday;t.byDayNthWeekday=e}},getByDayNthWeekday:function(){return this.byDayNthWeekday},applyByMonthDay:function(e){this.byDay=null;this.byDayWeekdays=null;this.byDayNthWeekday=null;this.byMonthDay=e},getRule:function(){var e=[],t=this;if(!t.frequency){return""}e.push("FREQ="+t.frequency);if(t.interval!==1){e.push("INTERVAL="+t.interval)}if(t.byDay){e.push("BYDAY="+t.byDay)}if(t.byMonthDay){e.push("BYMONTHDAY="+t.byMonthDay)}if(t.byMonth){e.push("BYMONTH="+t.byMonth)}if(t.count){e.push("COUNT="+t.count)}if(t.until){e.push("UNTIL="+Ext.Date.format(t.until,t.dateValueFormat))}return e.join(";")+";"},applyRule:function(e){var t,n,r,i,s=0,o=this;if(!e){this.init();return}t=e.split(";");n=t.length;for(;s<n;s++){r=t[s].split("=");if(r[0]==="FREQ"){o.setFrequency(r[1]);break}}for(s=0;s<n;s++){r=t[s].split("=");i=r[1];switch(r[0]){case"INTERVAL":o.setInterval(parseInt(i,10));break;case"COUNT":o.setCount(parseInt(i,10));break;case"UNTIL":o.setUntil(i);break;case"BYDAY":o.setByDay(i);break;case"BYMONTHDAY":o.setByMonthDay(parseInt(i,10));break;case"BYMONTH":o.setByMonth(parseInt(i,10));break}}},getDescription:function(e){var t=this,n=[],r=t.frequency?Ext.String.capitalize(t.frequency.toLowerCase()):"";e=e||this.startDate;if(r&&t["getDescription"+r]){t["getDescription"+r](n,e)}t.getDescriptionCount(n,e);t.getDescriptionUntil(n,e);return n.join("")},getDescriptionDaily:function(e,t){var n=this,r=n.strings;if(n.interval===1){e.push(r.frequency.daily)}else{e.push(r.every," ",n.interval," ",r.days)}},getDescriptionWeekly:function(e,t){var n=this,r=n.strings;if(n.interval===1){e.push(r.frequency.weekly)}else{e.push(r.every," ",n.interval," ",r.weeks)}if(n.byDayWeekdays){var i=n.byDayWeekdays.length;e.push(" ",r.on," ");for(var s=0;s<i;s++){if(s>0&&s<i-1){e.push(", ")}else if(i>1&&s===i-1){e.push(" ",r.and," ")}if(i>2){e.push(r.dayNamesShort[n.byDayWeekdays[s]])}else{e.push(r.dayNamesLong[n.byDayWeekdays[s]])}}}else if(t){e.push(" ",r.on," ",r.dayNamesLong[n.byDayNames[t.getDay()]])}},getDescriptionWeekdays:function(e,t){if(this.interval===1){e.push(this.strings.frequency.weekdays)}else{e.push(this.strings.every," ",this.interval," ",this.strings.weekdays)}},getDescriptionMonthly:function(e,t){var n=this,r=n.strings;if(n.interval===1){e.push(r.frequency.monthly)}else{e.push(r.every," ",n.interval," ",r.months)}if(n.byMonthDay>0){e.push(" "+r.onDay+" "+n.byMonthDay+r.onDayPostfix)}else if(n.byMonthDay===-1){e.push(" "+r.onTheLastDay)}else if(n.byDayNthWeekday){if(n.byDayNthWeekday.number>0){e.push(" ",r.onThe," ",r.ordinals[n.byDayNthWeekday.number]," ",r.dayNamesLong[n.byDayNthWeekday.weekday])}else{e.push(" "+r.onTheLast+" "+r.dayNamesLong[n.byDayNthWeekday.weekday])}}},getDescriptionYearly:function(e,t){var n=this,r=n.strings;if(n.interval===1){e.push(r.frequency.yearly)}else{e.push(r.every," ",n.interval," ",r.years)}if(!t){return}if(n.byMonthDay===-1){e.push(" ",r.onTheLastDay," ",r.of," ",Ext.Date.format(t,r.monthFormat))}else if(n.byDayNthWeekday){if(n.byDayNthWeekday.number>0){e.push(" ",r.onThe," ",r.ordinals[n.byDayNthWeekday.number]," ",r.dayNamesLong[n.byDayNthWeekday.weekday]," ",r.of," ",Ext.Date.format(t,r.monthFormat))}else{e.push(" ",r.onTheLast," ",r.dayNamesLong[n.byDayNthWeekday.weekday]," ",r.of," ",Ext.Date.format(t,r.monthFormat))}}else{e.push(" ",r.on," ",Ext.Date.format(t,r.monthDayFormat))}},getDescriptionCount:function(e,t){if(this.count){e.push(", ",this.count," ",this.count===1?this.strings.time:this.strings.times)}},getDescriptionUntil:function(e,t){if(this.until){e.push(", ",this.strings.until," ",Ext.Date.format(this.until,this.strings.untilFormat))}}});Ext.define("Extensible.form.recurrence.Parser",{extend:"Extensible.form.recurrence.Rule",singleton:true});Ext.define("Extensible.form.recurrence.AbstractOption",{extend:"Ext.form.FieldContainer",requires:["Extensible.form.recurrence.Rule"],mixins:{field:"Ext.form.field.Field"},layout:"hbox",defaults:{margins:"0 5 0 0"},rrule:undefined,startDate:undefined,startDay:0,maxEndDate:new Date("12/31/9999"),key:undefined,optionDelimiter:";",initComponent:function(){var e=this;e.addEvents("change");e.initRRule();e.items=e.getItemConfigs();e.callParent(arguments);e.initRefs();e.initField()},initRRule:function(){var e=this;e.rrule=e.rrule||Ext.create("Extensible.form.recurrence.Rule");e.startDate=e.startDate||e.rrule.startDate||Extensible.Date.today();if(!e.rrule.startDate){e.rrule.setStartDate(e.startDate)}},afterRender:function(){this.callParent(arguments);this.updateLabel()},initRefs:Ext.emptyFn,setFrequency:function(e){this.frequency=e},setStartDate:function(e){this.startDate=e;return this},getStartDate:function(){return this.startDate||Extensible.Date.today()},getDefaultValue:function(){return""},preSetValue:function(e,t){var n=this;if(!e){e=n.getDefaultValue()}if(!t){n.on("afterrender",function(){n.setValue(e)},n,{single:true});return false}n.value=e;return true}});Ext.define("Extensible.form.recurrence.option.Duration",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-duration",requires:["Ext.form.Label","Ext.form.field.ComboBox","Ext.form.field.Number","Ext.form.field.Date"],minOccurrences:1,maxOccurrences:999,defaultEndDateOffset:5,minDateOffset:1,endDateWidth:120,strings:{andContinuing:"and continuing",occurrences:"occurrences",forever:"forever",forText:"for",until:"until"},cls:"extensible-recur-duration",getItemConfigs:function(){var e=this;return[e.getContinuingLabelConfig(),e.getDurationComboConfig(),e.getDurationDateFieldConfig(),e.getDurationNumberFieldConfig(),e.getOccurrencesLabelConfig()]},getContinuingLabelConfig:function(){return{xtype:"label",text:this.strings.andContinuing}},getDurationComboConfig:function(){var e=this;return{xtype:"combo",itemId:e.id+"-duration-combo",mode:"local",width:85,triggerAction:"all",forceSelection:true,value:e.strings.forever,store:[e.strings.forever,e.strings.forText,e.strings.until],listeners:{change:Ext.bind(e.onComboChange,e)}}},getDurationDateFieldConfig:function(){var e=this,t=e.getStartDate();return{xtype:"datefield",itemId:e.id+"-duration-date",showToday:false,width:e.endDateWidth,format:e.endDateFormat||Ext.form.field.Date.prototype.format,startDay:this.startDay,maxValue:e.maxEndDate,allowBlank:false,hidden:true,minValue:Ext.Date.add(t,Ext.Date.DAY,e.minDateOffset),value:e.getDefaultEndDate(t),listeners:{change:Ext.bind(e.onEndDateChange,e)}}},getDurationNumberFieldConfig:function(){var e=this;return{xtype:"numberfield",itemId:e.id+"-duration-num",value:5,width:55,minValue:e.minOccurrences,maxValue:e.maxOccurrences,allowBlank:false,hidden:true,listeners:{change:Ext.bind(e.onOccurrenceCountChange,e)}}},getOccurrencesLabelConfig:function(){return{xtype:"label",itemId:this.id+"-duration-num-label",text:this.strings.occurrences,hidden:true}},initRefs:function(){var e=this;e.untilCombo=e.down("#"+e.id+"-duration-combo");e.untilDateField=e.down("#"+e.id+"-duration-date");e.untilNumberField=e.down("#"+e.id+"-duration-num");e.untilNumberLabel=e.down("#"+e.id+"-duration-num-label")},onComboChange:function(e,t){this.toggleFields(t);this.checkChange()},toggleFields:function(e){var t=this;t.untilCombo.setValue(e);if(e===t.strings.until){if(!t.untilDateField.getValue()){t.initUntilDate()}t.untilDateField.show()}else{t.untilDateField.hide();t.untilDateIsSet=false}if(e===t.strings.forText){t.untilNumberField.show();t.untilNumberLabel.show()}else{t.untilNumberField.hide();t.untilNumberLabel.hide()}},onOccurrenceCountChange:function(e,t,n){this.checkChange()},onEndDateChange:function(e,t,n){this.checkChange()},setStartDate:function(e){var t=this,n=t.getValue();if(e.getTime()!==t.startDate.getTime()){t.callParent(arguments);t.untilDateField.setMinValue(e);if(!n||t.untilDateField.getValue()<e){t.initUntilDate(e)}}return t},setFrequency:function(){this.callParent(arguments);this.initUntilDate();return this},initUntilDate:function(e){if(!this.untilDateIsSet){this.untilDateIsSet=true;var t=this.getDefaultEndDate(e||this.getStartDate());this.untilDateField.setValue(t)}return this},getDefaultEndDate:function(e){var t={},n;switch(this.frequency){case"WEEKLY":case"WEEKDAYS":n="weeks";break;case"MONTHLY":n="months";break;case"YEARLY":n="years";break;default:n="days"}t[n]=this.defaultEndDateOffset;return Extensible.Date.add(e,t)},getValue:function(){var e=this;if(e.untilCombo){if(e.untilNumberField.isVisible()){return"COUNT="+e.untilNumberField.getValue()}if(e.untilDateField.isVisible()){return"UNTIL="+e.rrule.formatDate(this.adjustUntilDateValue(e.untilDateField.getValue()))}}return""},adjustUntilDateValue:function(e){return Extensible.Date.add(e,{days:1,seconds:-1})},setValue:function(e){var t=this;if(!t.preSetValue(e,t.untilCombo)){return t}if(!e){t.toggleFields(t.strings.forever);return t}var n=Ext.isArray(e)?e:e.split(t.optionDelimiter),r=false,i;Ext.each(n,function(e){i=e.split("=");if(i[0]==="COUNT"){t.untilNumberField.setValue(i[1]);t.toggleFields(t.strings.forText);r=true;return}if(i[0]==="UNTIL"){t.untilDateField.setValue(t.rrule.parseDate(i[1]));t.untilDateField.validate();t.toggleFields(t.strings.until);r=true;return}},t);if(!r){t.toggleFields(t.strings.forever)}return t}});Ext.define("Extensible.form.recurrence.option.Interval",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-interval",dateLabelFormat:"l, F j",unit:"day",minValue:1,maxValue:999,startDateWidth:120,strings:{repeatEvery:"Repeat every",beginning:"beginning",day:"day",days:"days",week:"week",weeks:"weeks",month:"month",months:"months",year:"year",years:"years"},cls:"extensible-recur-interval",initComponent:function(){this.addEvents("startchange");this.callParent(arguments)},getItemConfigs:function(){return[this.getRepeatEveryLabelConfig(),this.getIntervalComboConfig(),this.getBeginDateLabelConfig(),this.getBeginDateFieldConfig()]},getRepeatEveryLabelConfig:function(){return{xtype:"label",text:this.strings.repeatEvery}},getIntervalComboConfig:function(){var e=this;return{xtype:"numberfield",itemId:e.id+"-interval",value:1,width:55,minValue:e.minValue,maxValue:e.maxValue,allowBlank:false,enableKeyEvents:true,listeners:{change:Ext.bind(e.onIntervalChange,e)}}},getBeginDateLabelConfig:function(){return{xtype:"label",itemId:this.id+"-date-label"}},getBeginDateFieldConfig:function(){var e=this,t=e.getStartDate();return{xtype:"datefield",itemId:e.id+"-start-date",width:e.startDateWidth,startDay:this.startDay,maxValue:e.maxEndDate,allowBlank:false,value:t,listeners:{change:Ext.bind(e.onStartDateChange,e)}}},initRefs:function(){var e=this;e.intervalField=e.down("#"+e.id+"-interval");e.dateLabel=e.down("#"+e.id+"-date-label");e.startDateField=e.down("#"+e.id+"-start-date")},onIntervalChange:function(e,t,n){this.checkChange();this.updateLabel()},onStartDateChange:function(e,t,n){this.checkChange();this.fireEvent("startchange",this,t,n)},getValue:function(){if(this.intervalField){return"INTERVAL="+this.intervalField.getValue()}return""},setValue:function(e){var t=this;if(!t.preSetValue(e,t.intervalField)){return t}if(!e){t.intervalField.setValue(t.minValue);return t}var n=Ext.isArray(e)?e:e.split(t.optionDelimiter),r;Ext.each(n,function(e){r=e.split("=");if(r[0]==="INTERVAL"){t.intervalField.setValue(r[1]);t.updateLabel();return}},t);return t},setStartDate:function(e){this.startDate=e;this.startDateField.setValue(e);return this},setUnit:function(e){this.unit=e;this.updateLabel();return this},updateLabel:function(e){var t=this;if(t.intervalField){var n=t.intervalField.getValue()===1?"":"s";t.unit=e?e.toLowerCase():t.unit||"day";if(t.dateLabel){t.dateLabel.update(t.strings[t.unit+n]+" "+t.strings.beginning)}}return t}});Ext.define("Extensible.form.recurrence.option.Monthly",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-monthly",requires:["Ext.form.field.ComboBox","Extensible.lang.Number"],cls:"extensible-recur-monthly",nthComboWidth:150,strings:{onThe:"on the",ofEach:"of each",inText:"in",day:"day",month:"month",year:"year",last:"last",lastDay:"last day",monthDayDateFormat:"jS",nthWeekdayDateFormat:"S"},afterRender:function(){this.callParent(arguments);this.initNthCombo()},getItemConfigs:function(){return[this.getOnTheLabelConfig(),this.getNthComboConfig(),this.getOfEachLabelConfig()]},getOnTheLabelConfig:function(){return{xtype:"label",text:this.strings.onThe}},getNthComboConfig:function(){return{xtype:"combobox",itemId:this.id+"-nth-combo",queryMode:"local",width:this.nthComboWidth,triggerAction:"all",forceSelection:true,displayField:"text",valueField:"value",store:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],idIndex:0,data:[]}),listeners:{change:Ext.bind(this.onComboChange,this)}}},getPeriodString:function(){return this.strings.month},getOfEachLabelConfig:function(){return{xtype:"label",text:this.strings.ofEach+" "+this.getPeriodString()}},initRefs:function(){this.nthCombo=this.down("#"+this.id+"-nth-combo")},onComboChange:function(e,t){this.checkChange()},setStartDate:function(e){if(e.getTime()!==this.startDate.getTime()){this.callParent(arguments);this.initNthCombo()}return this},initNthCombo:function(){if(!this.rendered){return}var e=this,t=e.nthCombo,n=t.store,r=e.getStartDate(),i=Ext.Date.getLastDateOfMonth(r).getDate(),s=Ext.Date.format(r,e.strings.monthDayDateFormat)+" "+e.strings.day,o=r.getDate(),u=Math.ceil(o/7),a=Extensible.form.recurrence.Parser.byDayNames[r.getDay()],f=new Date(2e3,0,u),l=u+Ext.Date.format(f,e.strings.nthWeekdayDateFormat)+Ext.Date.format(r," l"),c=e.isYearly?" "+e.strings.inText+" "+Ext.Date.format(r,"F"):"",h=e.isYearly?"BYMONTH="+Ext.Date.format(r,"n"):"",p=e.isYearly?e.optionDelimiter:"",d=[[s+c,e.isYearly?h:"BYMONTHDAY="+o],[l+c,h+p+"BYDAY="+u+a]],v=n.find("value",t.getValue());if(i-o<7){d.push([e.strings.last+" "+Ext.Date.format(r,"l")+c,h+p+"BYDAY=-1"+a])}if(i===o){d.push([e.strings.lastDay+c,h+p+"BYMONTHDAY=-1"])}n.removeAll();t.clearValue();n.loadData(d);if(v>d.length-1){v=d.length-1}t.setValue(n.getAt(v>-1?v:0).data.value);return e},getValue:function(){var e=this;if(e.nthCombo){return e.nthCombo.getValue()}return""},setValue:function(e){var t=this;if(!t.preSetValue(e,t.nthCombo)){return t}if(!e){var n=t.nthCombo.store.getAt(0);if(n){t.nthCombo.setValue(n.data.value)}return t}var r=Ext.isArray(e)?e:e.split(t.optionDelimiter),i,s=[];Ext.each(r,function(e){i=e.split("=");if(i[0]==="BYMONTH"){s.unshift(e)}if(i[0]==="BYMONTHDAY"||i[0]==="BYDAY"){s.push(e)}},t);if(s.length){t.nthCombo.setValue(s.join(t.optionDelimiter))}return t}});Ext.define("Extensible.form.recurrence.option.Weekly",{extend:"Extensible.form.recurrence.AbstractOption",alias:"widget.extensible.recurrence-weekly",requires:["Ext.form.field.Checkbox","Ext.form.CheckboxGroup","Extensible.form.recurrence.Parser"],startDay:0,dayValueDelimiter:",",cls:"extensible-recur-weekly",strings:{on:"on"},getCheckboxGroupItems:function(){var e=Extensible.form.recurrence.Parser.byDayNames,t=Extensible.form.recurrence.Parser.strings.dayNamesShortByIndex,n=[],r=this.startDay;for(var i=0;i<7;i++){n[i]={boxLabel:t[r],name:e[r],id:this.id+"-"+e[r]};r=r===6?0:r+1}return n},getItemConfigs:function(){var e=this.id;return[{xtype:"label",text:this.strings.on+":"},{xtype:"checkboxgroup",itemId:e+"-days",flex:1,items:this.getCheckboxGroupItems(),listeners:{change:Ext.bind(this.onSelectionChange,this)}}]},initValue:function(){this.callParent(arguments);if(!this.value){this.selectByDate()}},initRefs:function(){this.daysCheckboxGroup=this.down("#"+this.id+"-days")},onSelectionChange:function(e,t,n){this.checkChange();this.updateLabel()},selectByDate:function(e){var t=Ext.Date.format(e||this.getStartDate(),"D").substring(0,2).toUpperCase();this.setValue("BYDAY="+t)},clearValue:function(){this.value=undefined;if(this.daysCheckboxGroup){this.daysCheckboxGroup.setValue({SU:0,MO:0,TU:0,WE:0,TH:0,FR:0,SA:0})}},getValue:function(){var e=this;if(e.daysCheckboxGroup){var t=e.daysCheckboxGroup.getValue(),n=[],r;for(r in t){if(t.hasOwnProperty(r)){n.push(r)}}return n.length>0?"BYDAY="+n.join(e.dayValueDelimiter):""}return""},setValue:function(e){var t=this;if(!t.preSetValue(e,t.daysCheckboxGroup)){return t}t.daysCheckboxGroup.setValue(null);if(!e){return t}var n=Ext.isArray(e)?e:e.split(t.optionDelimiter),r={},i,s;Ext.each(n,function(e){i=e.split("=");if(i[0]==="BYDAY"){s=i[1].split(t.dayValueDelimiter);Ext.each(s,function(e){r[e]=true},t);t.daysCheckboxGroup.setValue(r);return}},t);return t}});Ext.define("Extensible.form.recurrence.option.Yearly",{extend:"Extensible.form.recurrence.option.Monthly",alias:"widget.extensible.recurrence-yearly",cls:"extensible-recur-yearly",nthComboWidth:200,isYearly:true,getPeriodString:function(){return this.strings.year}});Ext.define("Extensible.form.recurrence.FrequencyCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.recurrence-frequency",requires:["Ext.data.ArrayStore","Extensible.form.recurrence.Parser"],fieldLabel:"Repeats",queryMode:"local",triggerAction:"all",forceSelection:true,displayField:"pattern",valueField:"id",cls:"extensible-recur-frequency",initComponent:function(){var e=this;e.addEvents("frequencychange");var t=Extensible.form.recurrence.Parser.strings.frequency;e.frequencyOptions=e.frequencyOptions||[["NONE",t.none],["DAILY",t.daily],["WEEKDAYS",t.weekdays],["WEEKLY",t.weekly],["MONTHLY",t.monthly],["YEARLY",t.yearly]];e.store=e.store||Ext.create("Ext.data.ArrayStore",{fields:["id","pattern"],idIndex:0,data:e.frequencyOptions});e.on("select",e.onSelect,e);e.callParent(arguments)},onSelect:function(e,t){this.fireEvent("frequencychange",t[0].data.id)}});Ext.define("Extensible.form.recurrence.Fieldset",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.recurrencefield",mixins:{field:"Ext.form.field.Field"},requires:["Ext.form.Label","Extensible.form.recurrence.Rule","Extensible.form.recurrence.FrequencyCombo","Extensible.form.recurrence.option.Interval","Extensible.form.recurrence.option.Weekly","Extensible.form.recurrence.option.Monthly","Extensible.form.recurrence.option.Yearly","Extensible.form.recurrence.option.Duration"],rrule:undefined,startDate:undefined,startDay:0,options:["daily","weekly","weekdays","monthly","yearly"],displayStyle:"field",fieldLabel:"Repeats",fieldContainerWidth:400,monitorChanges:true,cls:"extensible-recur-field",frequencyWidth:null,layout:"anchor",defaults:{anchor:"100%"},initComponent:function(){var e=this;if(!e.height||e.displayStyle==="field"){delete e.height;e.autoHeight=true}this.addEvents("startchange");e.initRRule();e.items=[{xtype:"extensible.recurrence-frequency",hideLabel:true,width:this.frequencyWidth,itemId:this.id+"-frequency",listeners:{frequencychange:{fn:this.onFrequencyChange,scope:this}}},{xtype:"container",itemId:this.id+"-inner-ct",cls:"extensible-recur-inner-ct",autoHeight:true,layout:"anchor",hideMode:"offsets",hidden:true,width:this.fieldContainerWidth,defaults:{hidden:true,rrule:e.rrule},items:[{xtype:"extensible.recurrence-interval",itemId:this.id+"-interval"},{xtype:"extensible.recurrence-weekly",itemId:this.id+"-weekly",startDay:this.startDay},{xtype:"extensible.recurrence-monthly",itemId:this.id+"-monthly"},{xtype:"extensible.recurrence-yearly",itemId:this.id+"-yearly"},{xtype:"extensible.recurrence-duration",itemId:this.id+"-duration",startDay:this.startDay}]}];e.callParent(arguments);e.initField()},initRRule:function(){var e=this;e.rrule=e.rrule||Ext.create("Extensible.form.recurrence.Rule");e.startDate=e.startDate||e.rrule.startDate||Extensible.Date.today();if(!e.rrule.startDate){e.rrule.setStartDate(e.startDate)}},afterRender:function(){this.callParent(arguments);this.initRefs()},initRefs:function(){var e=this,t=e.id;e.innerContainer=e.down("#"+t+"-inner-ct");e.frequencyCombo=e.down("#"+t+"-frequency");e.intervalField=e.down("#"+t+"-interval");e.weeklyField=e.down("#"+t+"-weekly");e.monthlyField=e.down("#"+t+"-monthly");e.yearlyField=e.down("#"+t+"-yearly");e.durationField=e.down("#"+t+"-duration");e.initChangeEvents()},initChangeEvents:function(){var e=this;e.intervalField.on("startchange",e.onStartDateChange,e);e.intervalField.on("change",e.onChange,e);e.weeklyField.on("change",e.onChange,e);e.monthlyField.on("change",e.onChange,e);e.yearlyField.on("change",e.onChange,e);e.durationField.on("change",e.onChange,e)},onStartDateChange:function(e,t,n){this.fireEvent("startchange",this,t,n)},onChange:function(){this.fireEvent("change",this,this.getValue())},onFrequencyChange:function(e){this.setFrequency(e);this.onChange()},initValue:function(){var e=this;e.originalValue=e.lastValue=e.value;e.suspendCheckChange++;e.setStartDate(e.startDate);if(e.value!==undefined){e.setValue(e.value)}else if(e.frequency!==undefined){e.setValue("FREQ="+e.frequency)}else{e.setValue("")}e.suspendCheckChange--;Ext.defer(e.doLayout,1,e);e.onChange()},setStartDate:function(e){var t=this;t.startDate=e;if(t.innerContainer){t.innerContainer.items.each(function(t){if(t.setStartDate){t.setStartDate(e)}})}else{t.on("afterrender",function(){t.setStartDate(e)},t,{single:true})}return t},getStartDate:function(){return this.startDate},isRecurring:function(){return this.getValue()!==""},getValue:function(){if(!this.innerContainer){return this.value}if(this.frequency==="NONE"){return""}var e,t;if(this.frequency==="WEEKDAYS"){e=["FREQ=WEEKLY","BYDAY=MO,TU,WE,TH,FR"]}else{e=["FREQ="+this.frequency]}this.innerContainer.items.each(function(n){if(n.isVisible()&&n.getValue){t=n.getValue();if(this.includeItemValue(t)){e.push(t)}}},this);return e.length>1?e.join(";"):e[0]},includeItemValue:function(e){if(e){if(e==="INTERVAL=1"){return false}var t=Ext.Date.format(this.startDate,"D").substring(0,2).toUpperCase();if(e==="BYDAY="+t){return false}return true}return false},getDescription:function(){return this.rrule.setRule(this.getValue()).getDescription()},setValue:function(e){var t=this;t.value=!e||e==="NONE"?"":e;if(!t.frequencyCombo||!t.innerContainer){t.on("afterrender",function(){t.setValue(e)},t,{single:true});return}var n=t.value.split(";");if(t.value===""){t.setFrequency("NONE")}else{Ext.each(n,function(e){if(e.indexOf("FREQ")>-1){var n=e.split("=")[1];t.setFrequency(n);t.checkChange();return}},t)}t.innerContainer.items.each(function(e){if(e.setValue){e.setValue(t.value)}});t.checkChange();return t},setFrequency:function(e){var t=this;t.frequency=e;if(t.frequencyCombo){t.frequencyCombo.setValue(e);t.showOptions(e);this.innerContainer.items.each(function(t){t.setFrequency(e)})}else{t.on("afterrender",function(){t.frequencyCombo.setValue(e);t.showOptions(e)},t,{single:true})}return t},showOptions:function(e){var t=this,n="day";if(e==="NONE"){t.innerContainer.hide()}else{t.intervalField.show();t.durationField.show();t.innerContainer.show()}switch(e){case"DAILY":case"WEEKDAYS":t.weeklyField.hide();t.monthlyField.hide();t.yearlyField.hide();if(e==="WEEKDAYS"){n="week"}break;case"WEEKLY":t.weeklyField.show();t.monthlyField.hide();t.yearlyField.hide();n="week";break;case"MONTHLY":t.monthlyField.show();t.weeklyField.hide();t.yearlyField.hide();n="month";break;case"YEARLY":t.yearlyField.show();t.weeklyField.hide();t.monthlyField.hide();n="year";break}t.intervalField.updateLabel(n)}});Ext.define("Extensible.form.recurrence.RangeEditPanel",{extend:"Ext.form.Panel",alias:"widget.extensible.recurrence-rangeeditpanel",cls:"extensible-recur-edit-options",headerText:"There are multiple events in this series. How would you like your changes applied?",optionSingleButtonText:"Single",optionSingleDescription:"Apply to this event only. No other events in the series will be affected.",optionFutureButtonText:"Future",optionFutureDescription:"Apply to this and all following events only. Past events will be unaffected.",optionAllButtonText:"All Events",optionAllDescription:"Apply to every event in this series.",editModes:{SINGLE:"single",FUTURE:"future",ALL:"all"},border:false,layout:{type:"vbox",align:"stretch"},initComponent:function(){var e=this;e.editMode=e.editMode||e.editModes.ALL;e.items=[e.getHeaderConfig(),e.getOptionPanelConfig(),e.getSummaryConfig()];e.callParent(arguments)},getHeaderConfig:function(){return{xtype:"component",html:this.headerText,height:55,padding:15}},getSummaryConfig:function(){return{xtype:"component",itemId:this.id+"-summary",html:this.optionAllDescription,flex:1,padding:15}},getOptionPanelConfig:function(){return{xtype:"panel",border:false,layout:{type:"hbox",pack:"center"},items:this.getOptionButtonConfigs()}},getOptionButtonConfigs:function(){var e=this,t={xtype:"button",iconAlign:"top",enableToggle:true,scale:"large",width:80,toggleGroup:"recur-toggle",toggleHandler:e.onToggle,scope:e},n=[Ext.apply({itemId:e.id+"-single",text:e.optionSingleButtonText,iconCls:"recur-edit-single",pressed:e.editMode===e.editModes.SINGLE},t),Ext.apply({itemId:e.id+"-future",text:e.optionFutureButtonText,iconCls:"recur-edit-future",pressed:e.editMode===e.editModes.FUTURE},t),Ext.apply({itemId:e.id+"-all",text:e.optionAllButtonText,iconCls:"recur-edit-all",pressed:e.editMode===e.editModes.ALL},t)];return n},getEditMode:function(){return this.editMode},showEditModes:function(e){e=e||[];var t=this,n=0,r,i=e.length;t.down("#"+t.id+"-single")[i?"hide":"show"]();t.down("#"+t.id+"-future")[i?"hide":"show"]();t.down("#"+t.id+"-all")[i?"hide":"show"]();for(;n<i;n++){r=t.down("#"+t.id+"-"+e[n]);if(r){r.show()}}},onToggle:function(e){var t=this,n=t.getComponent(t.id+"-summary").getEl();if(e.itemId===t.id+"-single"){n.update(t.optionSingleDescription);t.editMode=t.editModes.SINGLE}else if(e.itemId===t.id+"-future"){n.update(t.optionFutureDescription);t.editMode=t.editModes.FUTURE}else{n.update(t.optionAllDescription);t.editMode=t.editModes.ALL}}});Ext.define("Extensible.form.recurrence.RangeEditWindow",{extend:"Ext.window.Window",alias:"widget.extensible.recurrence-rangeeditwindow",id:"ext-cal-rangeeditwin",requires:["Extensible.form.recurrence.RangeEditPanel"],title:"Recurring Event Options",width:350,height:240,saveButtonText:"保存",cancelButtonText:"キャンセル",closeAction:"hide",modal:true,resizable:false,constrain:true,buttonAlign:"right",layout:"fit",formPanelConfig:{border:false},initComponent:function(){this.items=[{xtype:"extensible.recurrence-rangeeditpanel",itemId:this.id+"-recur-panel"}];this.fbar=this.getFooterBarConfig();this.callParent(arguments)},getRangeEditPanel:function(){return this.down("#"+this.id+"-recur-panel")},prompt:function(e){this.callbackFunction=Ext.bind(e.callback,e.scope||this);this.getRangeEditPanel().showEditModes(e.editModes);this.show()},getFooterBarConfig:function(){var e=["->",{text:this.saveButtonText,itemId:this.id+"-save-btn",disabled:false,handler:this.onSaveAction,scope:this},{text:this.cancelButtonText,itemId:this.id+"-cancel-btn",disabled:false,handler:this.onCancelAction,scope:this}];return e},onSaveAction:function(){var e=this.getComponent(this.id+"-recur-panel").getEditMode();this.callbackFunction(e);this.close()},onCancelAction:function(){this.callbackFunction(false);this.close()}});Ext.ns("Extensible.calendar.data");Extensible.calendar.data.EventMappings={EventId:{name:"EventId",mapping:"id",type:"string"},CalendarId:{name:"CalendarId",mapping:"cid",type:"string"},Title:{name:"Title",mapping:"title",type:"string"},StartDate:{name:"StartDate",mapping:"start",type:"date",dateFormat:"c"},EndDate:{name:"EndDate",mapping:"end",type:"date",dateFormat:"c"},ScheduleType:{name:"ScheduleType",mapping:"type",type:"number"},Room:{name:"Room",mapping:"room",type:"number"},ScheduleStatus:{name:"ScheduleStatus",mapping:"status",type:"number"},EditEnable:{name:"EditEnable",mapping:"edit",type:"number"},ProjectName:{name:"ProjectName",mapping:"project",type:"string"},MemberSchedule:{name:"MemberSchedule",mapping:"member",type:"string"},PrivacySchedule:{name:"PrivacySchedule",mapping:"privacy",type:"number"},Location:{name:"Location",mapping:"loc",type:"string"},Notes:{name:"Notes",mapping:"notes",type:"string"},Url:{name:"Url",mapping:"url",type:"string"},IsAllDay:{name:"IsAllDay",mapping:"ad",type:"boolean"},Reminder:{name:"Reminder",mapping:"rem",type:"string"},RRule:{name:"RRule",mapping:"rrule",type:"string",useNull:true},Duration:{name:"Duration",mapping:"duration",defaultValue:-1,useNull:true,type:"int"},OriginalEventId:{name:"OriginalEventId",mapping:"origid",type:"string",useNull:true},RSeriesStartDate:{name:"RSeriesStartDate",mapping:"rsstart",type:"date",dateFormat:"c",useNull:true},RInstanceStartDate:{name:"RInstanceStartDate",mapping:"ristart",type:"date",dateFormat:"c",useNull:true},REditMode:{name:"REditMode",mapping:"redit",type:"string",useNull:true}};Ext.ns("Extensible.calendar.data");Extensible.calendar.data.CalendarMappings={CalendarId:{name:"CalendarId",mapping:"id",type:"string"},Title:{name:"Title",mapping:"title",type:"string"},Description:{name:"Description",mapping:"desc",type:"string"},ColorId:{name:"ColorId",mapping:"color",type:"int"},IsHidden:{name:"IsHidden",mapping:"hidden",type:"boolean"}};Ext.define("Extensible.calendar.template.BoxLayout",{extend:"Ext.XTemplate",requires:["Ext.Date"],firstWeekDateFormat:"D j",otherWeeksDateFormat:"j",singleDayDateFormat:"l, F j, Y",multiDayFirstDayFormat:"M j, Y",multiDayMonthStartFormat:"M j",constructor:function(e){Ext.apply(this,e);var t=this.showWeekLinks?'<div id="{weekLinkId}" class="ext-cal-week-link">{weekNum}</div>':"";Extensible.calendar.template.BoxLayout.superclass.constructor.call(this,'<tpl for="weeks">','<div id="{[this.id]}-wk-{[xindex-1]}" class="ext-cal-wk-ct" style="top:{[this.getRowTop(xindex, xcount)]}%; height:{[this.getRowHeight(xcount)]}%;">',t,'<table class="ext-cal-bg-tbl" cellpadding="0" cellspacing="0">',"<tbody>","<tr>",'<tpl for=".">','<td id="{[this.id]}-day-{date:date("Ymd")}" class="{cellCls}">&#160;</td>',"</tpl>","</tr>","</tbody>","</table>",'<table class="ext-cal-evt-tbl" cellpadding="0" cellspacing="0">',"<tbody>","<tr>",'<tpl for=".">','<td id="{[this.id]}-ev-day-{date:date("Ymd")}" class="{titleCls}"><div>{title}</div></td>',"</tpl>","</tr>","</tbody>","</table>","</div>","</tpl>",{getRowTop:function(e,t){return(e-1)*(100/t)},getRowHeight:function(e){return 100/e}})},applyTemplate:function(e){Ext.apply(this,e);var t=0,n="",r=true,i=false,s=false,o=false,u=false,a=false,f=e.weekendCls,l=e.prevMonthCls,c=e.nextMonthCls,h=e.todayCls,p=[[]],d=Extensible.Date.today(),v=Ext.Date.clone(this.viewStart),m=this.startDate.getMonth();for(;t<this.weekCount||this.weekCount===-1;t++){if(v>this.viewEnd){break}p[t]=[];for(var g=0;g<this.dayCount;g++){i=v.getTime()===d.getTime();s=r||v.getDate()===1;o=v.getMonth()<m&&this.weekCount===-1;u=v.getMonth()>m&&this.weekCount===-1;a=v.getDay()%6===0;if(v.getDay()===1){p[t].weekNum=this.showWeekNumbers?Ext.Date.format(v,"W"):"&#160;";p[t].weekLinkId="ext-cal-week-"+Ext.Date.format(v,"Ymd")}if(s){if(i){n=this.getTodayText()}else{n=Ext.Date.format(v,this.dayCount===1?this.singleDayDateFormat:r?this.multiDayFirstDayFormat:this.multiDayMonthStartFormat)}}else{var y=t===0&&this.showHeader!==true?this.firstWeekDateFormat:this.otherWeeksDateFormat;n=i?this.getTodayText():Ext.Date.format(v,y)}p[t].push({title:n,date:Ext.Date.clone(v),titleCls:"ext-cal-dtitle "+(i?" ext-cal-dtitle-today":"")+(t===0?" ext-cal-dtitle-first":"")+(o?" ext-cal-dtitle-prev":"")+(u?" ext-cal-dtitle-next":""),cellCls:"ext-cal-day "+(i?" "+h:"")+(g===0?" ext-cal-day-first":"")+(o?" "+l:"")+(u?" "+c:"")+(a&&f?" "+f:"")});v=Extensible.Date.add(v,{days:1});r=false}}if(Ext.getVersion("extjs").isLessThan("4.1")){return Extensible.calendar.template.BoxLayout.superclass.applyTemplate.call(this,{weeks:p})}else{return this.applyOut({weeks:p},[]).join("")}},getTodayText:function(){var e=Extensible.Date.use24HourTime?"G:i ":"g:ia ",t=this.showTodayText!==false?this.todayText:"",n=this.showTime!==false?' <span id="'+this.id+'-clock" class="ext-cal-dtitle-time" aria-live="off">'+Ext.Date.format(new Date,e)+"</span>":"",r=t.length>0||n.length>0?" &#8212; ":"";if(this.dayCount===1){return Ext.Date.format(new Date,this.singleDayDateFormat)+r+t+n}var i=this.weekCount===1?this.firstWeekDateFormat:this.otherWeeksDateFormat;return t.length>0?t+n:Ext.Date.format(new Date,i)+n}},function(){this.createAlias("apply","applyTemplate")});Ext.define("Extensible.calendar.template.DayHeader",{extend:"Ext.XTemplate",requires:["Extensible.calendar.template.BoxLayout"],constructor:function(e){Ext.apply(this,e);this.allDayTpl=Ext.create("Extensible.calendar.template.BoxLayout",e);this.allDayTpl.compile();Extensible.calendar.template.DayHeader.superclass.constructor.call(this,'<div class="ext-cal-hd-ct">','<table class="ext-cal-hd-days-tbl" cellspacing="0" cellpadding="0">',"<tbody>","<tr>",'<td class="ext-cal-gutter"></td>','<td class="ext-cal-hd-days-td"><div class="ext-cal-hd-ad-inner">{allDayTpl}</div></td>','<td class="ext-cal-gutter-rt"></td>',"</tr>","</tbody>","</table>","</div>")},applyTemplate:function(e){var t={allDayTpl:this.allDayTpl.apply(e)};if(Ext.getVersion("extjs").isLessThan("4.1")){return Extensible.calendar.template.DayHeader.superclass.applyTemplate.call(this,t)}else{return this.applyOut(t,[]).join("")}}},function(){this.createAlias("apply","applyTemplate")});Ext.define("Extensible.calendar.template.DayBody",{extend:"Ext.XTemplate",constructor:function(e){Ext.apply(this,e);Extensible.calendar.template.DayBody.superclass.constructor.call(this,'<table class="ext-cal-bg-tbl" cellspacing="0" cellpadding="0" style="height:{dayHeight}px;">'+"<tbody>",'<tr height="1">','<td class="ext-cal-gutter"></td>','<td colspan="{dayCount}">','<div class="ext-cal-bg-rows">','<div class="ext-cal-bg-rows-inner">','<tpl for="times">','<div class="ext-cal-bg-row ext-row-{[xindex]}" style="height:{parent.hourHeight}px;">','<div class="ext-cal-bg-row-div {parent.hourSeparatorCls}" style="height:{parent.hourSeparatorHeight}px;"></div>',"</div>","</tpl>","</div>","</div>",'<div class="ext-cal-bg-rows">','<div class="ext-cal-bg-rows-inner">','<tpl for="times">','<div class="ext-cal-bg-row ext-row-{[xindex]}" style="height:{parent.hourHeight}px;">','<div class="ext-cal-bg-row-div {parent.hourSeparatorCls}" style="height:{parent.hourSeparatorHeight*2}px;"></div>',"</div>","</tpl>","</div>","</div>",'<div class="ext-cal-bg-rows">','<div class="ext-cal-bg-rows-inner">','<tpl for="times">','<div class="ext-cal-bg-row ext-row-{[xindex]}" style="height:{parent.hourHeight}px;">','<div class="ext-cal-bg-row-div {parent.hourSeparatorCls}" style="height:{parent.hourSeparatorHeight*3}px;"></div>',"</div>","</tpl>","</div>","</div>",'<div class="ext-cal-bg-rows">','<div class="ext-cal-bg-rows-inner">','<tpl for="times">','<div class="ext-cal-bg-row ext-row-{[xindex]}" style="height:{parent.hourHeight}px;">','<div class="ext-cal-bg-row-div {parent.hourSeparatorCls}" style="height:{parent.hourSeparatorHeight*4}px;"></div>',"</div>","</tpl>","</div>","</div>",'<div class="ext-cal-bg-rows">','<div class="ext-cal-bg-rows-inner">','<tpl for="times">','<div class="ext-cal-bg-row ext-row-{[xindex]}" style="height:{parent.hourHeight}px;">','<div class="ext-cal-bg-row-div {parent.hourSeparatorCls}" style="height:{parent.hourSeparatorHeight*5}px;"></div>',"</div>","</tpl>","</div>","</div>","</td>","</tr>","<tr>",'<td class="ext-cal-day-times">','<tpl for="times">','<div class="ext-cal-bg-row" style="height:{parent.hourHeight}px;">','<div class="ext-cal-day-time-inner"  style="height:{parent.hourHeight-1}px;">{.}</div>',"</div>","</tpl>","</td>",'<tpl for="days">','<td class="ext-cal-day-col">','<div class="ext-cal-day-col-inner">','<div id="{[this.id]}-day-col-{.:date("Ymd")}" class="ext-cal-day-col-gutter" style="height:{parent.dayHeight}px;"></div>',"</div>","</td>","</tpl>","</tr>","</tbody>","</table>")},applyTemplate:function(e){this.today=Extensible.Date.today();this.dayCount=this.dayCount||1;var t=0,n=[],r=Ext.Date.clone(e.viewStart);for(;t<this.dayCount;t++){n[t]=Extensible.Date.add(r,{days:t})}var i=[],s=this.viewStartHour,o=this.viewEndHour,u=this.hourIncrement,a=this.hourHeight*(o-s),f=Extensible.Date.use24HourTime?"G:i":"ga",l;r=Extensible.Date.add(new Date("5/26/1972"),{hours:s});for(t=s;t<o;t++){i.push(Ext.Date.format(r,f));r=Extensible.Date.add(r,{minutes:u})}var c=60/this.ddIncrement;l={days:n,dayCount:n.length,times:i,hourHeight:this.hourHeight,hourSeparatorCls:this.showHourSeparator?"":"no-sep",dayHeight:a,hourSeparatorHeight:this.hourHeight/c};if(Ext.getVersion("extjs").isLessThan("4.1")){return Extensible.calendar.template.DayBody.superclass.applyTemplate.call(this,l)}else{return this.applyOut(l,[]).join("")}}},function(){this.createAlias("apply","applyTemplate")});Ext.define("Extensible.calendar.template.Month",{extend:"Ext.XTemplate",requires:["Extensible.calendar.template.BoxLayout"],dayHeaderFormat:"D",dayHeaderTitleFormat:"l, F j, Y",constructor:function(e){Ext.apply(this,e);this.weekTpl=Ext.create("Extensible.calendar.template.BoxLayout",e);this.weekTpl.compile();var t=this.showWeekLinks?'<div class="ext-cal-week-link-hd">&#160;</div>':"";Extensible.calendar.template.Month.superclass.constructor.call(this,'<div class="ext-cal-inner-ct {extraClasses}">','<div class="ext-cal-hd-ct ext-cal-month-hd">',t,'<table class="ext-cal-hd-days-tbl" cellpadding="0" cellspacing="0">',"<tbody>","<tr>",'<tpl for="days">','<th class="ext-cal-hd-day{[xindex==1 ? " ext-cal-day-first" : ""]}" title="{title}">{name}</th>',"</tpl>","</tr>","</tbody>","</table>","</div>",'<div class="ext-cal-body-ct">{weeks}</div>',"</div>")},applyTemplate:function(e){var t=[],n=this.weekTpl.apply(e),r=e.viewStart,i=Extensible.Date,s;for(var o=0;o<7;o++){var u=i.add(r,{days:o});t.push({name:Ext.Date.format(u,this.dayHeaderFormat),title:Ext.Date.format(u,this.dayHeaderTitleFormat)})}var a=this.showHeader===true?"":"ext-cal-noheader";if(this.showWeekLinks){a+=" ext-cal-week-links"}s={days:t,weeks:n,extraClasses:a};if(Ext.getVersion("extjs").isLessThan("4.1")){return Extensible.calendar.template.Month.superclass.applyTemplate.call(this,s)}else{return this.applyOut(s,[]).join("")}}},function(){this.createAlias("apply","applyTemplate")});Ext.define("Ext.dd.ScrollManager",{singleton:true,requires:["Ext.dd.DragDropManager"],constructor:function(){var e=Ext.dd.DragDropManager;e.fireEvents=Ext.Function.createSequence(e.fireEvents,this.onFire,this);e.stopDrag=Ext.Function.createSequence(e.stopDrag,this.onStop,this);this.doScroll=Ext.Function.bind(this.doScroll,this);this.ddmInstance=e;this.els={};this.dragEl=null;this.proc={}},onStop:function(e){this.dragEl=null;this.clearProc()},triggerRefresh:function(){if(this.ddmInstance.dragCurrent){this.ddmInstance.refreshCache(this.ddmInstance.dragCurrent.groups)}},doScroll:function(){if(this.ddmInstance.dragCurrent){var e=this.proc,t=e.el,n=e.el.ddScrollConfig,r=n?n.increment:this.increment;if(!this.animate){if(t.scroll(e.dir,r)){this.triggerRefresh()}}else{t.scroll(e.dir,r,true,this.animDuration,this.triggerRefresh)}}},clearProc:function(){var e=this.proc;if(e.id){clearInterval(e.id)}e.id=0;e.el=null;e.dir=""},startProc:function(e,t){this.clearProc();this.proc.el=e;this.proc.dir=t;var n=e.ddScrollConfig?e.ddScrollConfig.ddGroup:undefined,r=e.ddScrollConfig&&e.ddScrollConfig.frequency?e.ddScrollConfig.frequency:this.frequency;if(n===undefined||this.ddmInstance.dragCurrent.ddGroup===n){this.proc.id=setInterval(this.doScroll,r)}},onFire:function(e,t){if(t||!this.ddmInstance.dragCurrent){return}if(!this.dragEl||this.dragEl!==this.ddmInstance.dragCurrent){this.dragEl=this.ddmInstance.dragCurrent;this.refreshCache()}var n=e.getXY(),r=e.getPoint(),i=this.proc,s=this.els;for(var o in s){var u=s[o],a=u._region;var f=u.ddScrollConfig?u.ddScrollConfig:this;if(a&&a.contains(r)&&u.isScrollable()){if(a.bottom-r.y<=f.vthresh){if(i.el!==u){this.startProc(u,"down")}return}else if(a.right-r.x<=f.hthresh){if(i.el!==u){this.startProc(u,"left")}return}else if(r.y-a.top<=f.vthresh){if(i.el!==u){this.startProc(u,"up")}return}else if(r.x-a.left<=f.hthresh){if(i.el!==u){this.startProc(u,"right")}return}}}this.clearProc()},register:function(e){if(Ext.isArray(e)){for(var t=0,n=e.length;t<n;t++){this.register(e[t])}}else{e=Ext.get(e);this.els[e.id]=e}},unregister:function(e){if(Ext.isArray(e)){for(var t=0,n=e.length;t<n;t++){this.unregister(e[t])}}else{e=Ext.get(e);delete this.els[e.id]}},vthresh:25,hthresh:25,increment:100,frequency:500,animate:true,animDuration:.4,ddGroup:undefined,refreshCache:function(){var e=this.els,t;for(t in e){if(typeof e[t]==="object"){e[t]._region=e[t].getRegion()}}}});Ext.define("Extensible.calendar.dd.StatusProxy",{extend:"Ext.dd.StatusProxy",moveEventCls:"ext-cal-dd-move",addEventCls:"ext-cal-dd-add",renderTpl:['<div class="'+Ext.baseCSSPrefix+'dd-drop-icon"></div>','<div class="ext-dd-ghost-ct">','<div id="{id}-ghost" class="'+Ext.baseCSSPrefix+'dd-drag-ghost"></div>','<div id="{id}-message" class="ext-dd-msg"></div>',"</div>"],childEls:["ghost","message"],constructor:function(e){if(Ext.getVersion("extjs").isLessThan("4.1")){this.preComponentConstructor(e)}else{this.callParent(arguments)}},preComponentConstructor:function(e){var t=this;Ext.apply(t,e);t.id=t.id||Ext.id();t.proxy=Ext.createWidget("component",{floating:true,id:t.id||Ext.id(),html:t.renderTpl.join(""),cls:Ext.baseCSSPrefix+"dd-drag-proxy "+t.dropNotAllowed,shadow:!e||e.shadow!==false,renderTo:document.body});t.el=t.proxy.el;t.el.show();t.el.setVisibilityMode(Ext.Element.VISIBILITY);t.el.hide();t.ghost=Ext.get(t.el.dom.childNodes[1].childNodes[0]);t.message=Ext.get(t.el.dom.childNodes[1].childNodes[1]);t.dropStatus=t.dropNotAllowed},update:function(e){this.callParent(arguments);var t=this.ghost.dom.firstChild;if(t){Ext.fly(t).setHeight("auto")}},updateMsg:function(e){this.message.update(e)}});Ext.define("Extensible.calendar.dd.DragZone",{extend:"Ext.dd.DragZone",requires:["Ext.util.Point","Extensible.calendar.dd.StatusProxy","Extensible.calendar.data.EventMappings"],ddGroup:"CalendarDD",eventSelector:".ext-cal-evt",eventSelectorDepth:10,constructor:function(e,t){if(!Extensible.calendar._statusProxyInstance){Extensible.calendar._statusProxyInstance=Ext.create("Extensible.calendar.dd.StatusProxy")}this.proxy=Extensible.calendar._statusProxyInstance;this.callParent(arguments)},getDragData:function(e){var t=e.getTarget(this.eventSelector,this.eventSelectorDepth);if(t){var n=this.view.getEventRecordFromEl(t);if(!n){return}return{type:"eventdrag",ddel:t,eventStart:n.data[Extensible.calendar.data.EventMappings.StartDate.name],eventEnd:n.data[Extensible.calendar.data.EventMappings.EndDate.name],proxy:this.proxy}}t=this.view.getDayAt(e.getX(),e.getY());if(t.el){return{type:"caldrag",start:t.date,proxy:this.proxy}}return null},onInitDrag:function(e,t){if(this.dragData.ddel){var n=this.dragData.ddel.cloneNode(true),r=Ext.fly(n).down("dl");Ext.fly(n).setWidth("auto");if(r){r.setHeight("auto")}this.proxy.update(n);this.onStartDrag(e,t)}else if(this.dragData.start){this.onStartDrag(e,t)}this.view.onInitDrag();return true},afterRepair:function(){if(Ext.enableFx&&this.dragData.ddel){Ext.fly(this.dragData.ddel).highlight(this.hlColor||"c3daf9")}this.dragging=false},getRepairXY:function(e){if(this.dragData.ddel){return Ext.fly(this.dragData.ddel).getXY()}},afterInvalidDrop:function(e,t){Ext.select(".ext-dd-shim").hide()},destroy:function(){this.callParent(arguments);delete Extensible.calendar._statusProxyInstance}});Ext.define("Extensible.calendar.dd.DropZone",{extend:"Ext.dd.DropZone",requires:["Ext.Layer","Extensible.calendar.data.EventMappings"],ddGroup:"CalendarDD",eventSelector:".ext-cal-evt",dateRangeFormat:"{0}-{1}",dateFormat:"n/j",shims:[],getTargetFromEvent:function(e){var t=this.dragOffset||0,n=e.getPageY()-t,r=this.view.getDayAt(e.getPageX(),n);return r.el?r:null},onNodeOver:function(e,t,n,r){alert("tren");var i=Extensible.Date,s=n.ctrlKey||n.altKey?this.copyText:this.moveText,o=r.type==="eventdrag"?e.date:i.min(r.start,e.date),u=r.type==="eventdrag"?i.add(e.date,{days:i.diffDays(r.eventStart,r.eventEnd)}):i.max(r.start,e.date);if(!this.dragStartDate||!this.dragEndDate||i.diffDays(o,this.dragStartDate)!==0||i.diffDays(u,this.dragEndDate)!==0){this.dragStartDate=o;this.dragEndDate=i.add(u,{days:1,millis:-1,clearTime:true});this.shim(o,u);var a=Ext.Date.format(o,this.dateFormat);if(i.diffDays(o,u)>0){u=Ext.Date.format(u,this.dateFormat);a=Ext.String.format(this.dateRangeFormat,a,u)}this.currentRange=a}r.proxy.updateMsg(Ext.String.format(r.type==="eventdrag"?s:this.createText,this.currentRange));return this.dropAllowed},shim:function(e,t){this.DDMInstance.notifyOccluded=true;this.currWeek=-1;var n=Ext.Date.clone(e),r=0,i,s,o=Extensible.Date,u=o.diffDays(n,t)+1;Ext.each(this.shims,function(e){if(e){e.isActive=false}});while(r++<u){var a=this.view.getDayEl(n);if(a){var f=this.view.getWeekIndex(n);i=this.shims[f];if(!i){i=this.createShim();this.shims[f]=i}if(f!==this.currWeek){i.boxInfo=a.getBox();this.currWeek=f}else{s=a.getBox();i.boxInfo.right=s.right;i.boxInfo.width=s.right-i.boxInfo.x}i.isActive=true}n=o.add(n,{days:1})}Ext.each(this.shims,function(e){if(e){if(e.isActive){e.show();e.setBox(e.boxInfo)}else if(e.isVisible()){e.hide()}}})},createShim:function(){var e=this.view.ownerCalendarPanel?this.view.ownerCalendarPanel:this.view;if(!this.shimCt){this.shimCt=Ext.get("ext-dd-shim-ct-"+e.id);if(!this.shimCt){this.shimCt=document.createElement("div");this.shimCt.id="ext-dd-shim-ct-"+e.id;e.getEl().parent().appendChild(this.shimCt)}}var t=document.createElement("div");t.className="ext-dd-shim";this.shimCt.appendChild(t);return Ext.create("Ext.Layer",{shadow:false,useDisplay:true,constrain:false},t)},clearShims:function(){Ext.each(this.shims,function(e){if(e){e.hide()}});this.DDMInstance.notifyOccluded=false},onContainerOver:function(e,t,n){return this.dropAllowed},onCalendarDragComplete:function(){delete this.dragStartDate;delete this.dragEndDate;this.clearShims()},onNodeDrop:function(e,t,n,r){if(e&&r){if(r.type==="eventdrag"){var i=this.view.getEventRecordFromEl(r.ddel),s=Extensible.Date.copyTime(i.data[Extensible.calendar.data.EventMappings.StartDate.name],e.date);this.view.onEventDrop(i,s,n.ctrlKey||n.altKey?"copy":"move");this.onCalendarDragComplete();return true}if(r.type==="caldrag"){if(!this.dragEndDate){this.dragStartDate=Ext.Date.clearTime(r.start);this.dragEndDate=Extensible.Date.add(this.dragStartDate,{days:1,millis:-1,clearTime:true})}this.view.onCalendarEndDrag(this.dragStartDate,this.dragEndDate,Ext.bind(this.onCalendarDragComplete,this));return true}}this.onCalendarDragComplete();return false},onContainerDrop:function(e,t,n){this.onCalendarDragComplete();return false},destroy:function(){Ext.each(this.shims,function(e){if(e){Ext.destroy(e)}});Ext.removeNode(this.shimCt);delete this.shimCt;this.shims.length=0}});Ext.define("Extensible.calendar.dd.DayDragZone",{extend:"Extensible.calendar.dd.DragZone",ddGroup:"DayViewDD",resizeSelector:".ext-evt-rsz",getDragData:function(e){var t=e.getTarget(this.resizeSelector,2,true),n,r;if(t){r=t.parent(this.eventSelector);n=this.view.getEventRecordFromEl(r);if(!n){return}return{type:"eventresize",xy:e.getXY(),ddel:r.dom,eventStart:n.data[Extensible.calendar.data.EventMappings.StartDate.name],eventEnd:n.data[Extensible.calendar.data.EventMappings.EndDate.name],proxy:this.proxy}}t=e.getTarget(this.eventSelector,this.eventSelectorDepth);if(t){n=this.view.getEventRecordFromEl(t);if(!n){return}return{type:"eventdrag",xy:e.getXY(),ddel:t,eventStart:n.data[Extensible.calendar.data.EventMappings.StartDate.name],eventEnd:n.data[Extensible.calendar.data.EventMappings.EndDate.name],proxy:this.proxy}}t=this.view.getDayAt(e.getX(),e.getY());if(t.el){return{type:"caldrag",dayInfo:t,proxy:this.proxy}}return null}});Ext.define("Extensible.calendar.dd.DayDropZone",{extend:"Extensible.calendar.dd.DropZone",ddGroup:"DayViewDD",dateRangeFormat:"{0}-{1}",dateFormat:"n/j",onNodeOver:function(e,t,n,r){var i,s,o,u,a=this.createText,f=Extensible.Date.use24HourTime?"G:i":"g:ia";if(r.type==="caldrag"){if(!this.dragStartMarker){this.dragStartMarker=e.el.parent().createChild({style:"position:absolute;"});this.dragStartMarker.setBox(r.dayInfo.timeBox);this.dragCreateDt=r.dayInfo.date}var l;s=this.dragStartMarker.getBox();s.height=Math.ceil(Math.abs(n.getY()-s.y)/e.timeBox.height)*e.timeBox.height;if(n.getY()<s.y){s.height+=e.timeBox.height;s.y=s.y-s.height+e.timeBox.height;l=Extensible.Date.add(this.dragCreateDt,{minutes:this.ddIncrement})}else{e.date=Extensible.Date.add(e.date,{minutes:this.ddIncrement})}this.shim(this.dragCreateDt,s);o=Extensible.Date.diff(this.dragCreateDt,e.date);u=Extensible.Date.add(this.dragCreateDt,{millis:o});this.dragStartDate=Extensible.Date.min(this.dragCreateDt,u);this.dragEndDate=l||Extensible.Date.max(this.dragCreateDt,u);i=Ext.String.format(this.dateRangeFormat,Ext.Date.format(this.dragStartDate,f),Ext.Date.format(this.dragEndDate,f))}else{var c=Ext.get(r.ddel),h=c.parent().parent();s=c.getBox();s.width=h.getWidth();if(r.type==="eventdrag"){if(this.dragOffset===undefined){var p=this.view.getDayAt(r.xy[0],r.xy[1]).timeBox;this.dragOffset=p.y-s.y}else{s.y=e.timeBox.y}i=Ext.Date.format(e.date,this.dateFormat+" "+f);s.x=e.el.getLeft();this.shim(e.date,s);a=n.ctrlKey||n.altKey?this.copyText:this.moveText}if(r.type==="eventresize"){if(!this.resizeDt){this.resizeDt=e.date}s.x=h.getLeft();s.height=Math.ceil(Math.abs(n.getY()-s.y)/e.timeBox.height)*e.timeBox.height;if(n.getY()<s.y){s.y-=s.height}else{e.date=Extensible.Date.add(e.date,{minutes:this.ddIncrement})}this.shim(this.resizeDt,s);o=Extensible.Date.diff(this.resizeDt,e.date);u=Extensible.Date.add(this.resizeDt,{millis:o});var d=Extensible.Date.min(r.eventStart,u),v=Extensible.Date.max(r.eventStart,u),m=Extensible.calendar.data.EventMappings.StartDate.name,g=Extensible.calendar.data.EventMappings.EndDate.name;r.resizeDates={};r.resizeDates[m]=d;r.resizeDates[g]=v;i=Ext.String.format(this.dateRangeFormat,Ext.Date.format(d,f),Ext.Date.format(v,f));a=this.resizeText}}r.proxy.updateMsg(Ext.String.format(a,i));return this.dropAllowed},shim:function(e,t){this.DDMInstance.notifyOccluded=true;Ext.each(this.shims,function(e){if(e){e.isActive=false;e.hide()}});var n=this.shims[0];if(!n){n=this.createShim();this.shims[0]=n}n.isActive=true;n.show();n.setBox(t)},onNodeDrop:function(e,t,n,r){if(e&&r){var i;if(r.type==="eventdrag"){i=this.view.getEventRecordFromEl(r.ddel);this.view.onEventDrop(i,e.date,n.ctrlKey||n.altKey?"copy":"move");this.onCalendarDragComplete();delete this.dragOffset;return true}if(r.type==="eventresize"){i=this.view.getEventRecordFromEl(r.ddel);this.view.onEventResize(i,r.resizeDates);this.onCalendarDragComplete();delete this.resizeDt;return true}if(r.type==="caldrag"){Ext.destroy(this.dragStartMarker);delete this.dragStartMarker;delete this.dragCreateDt;this.view.onCalendarEndDrag(this.dragStartDate,this.dragEndDate,Ext.bind(this.onCalendarDragComplete,this));return true}}this.onCalendarDragComplete();return false}});Ext.define("Extensible.calendar.data.EventModel",{extend:"Extensible.data.Model",requires:["Extensible.calendar.data.EventMappings"],mappingClass:"Extensible.calendar.data.EventMappings",mappingIdProperty:"EventId",inheritableStatics:{resolution:"minutes"},isRecurring:function(){var e=Extensible.calendar.data.EventMappings.RRule;if(e){return!!this.get(e.name)}return false},getStartDate:function(){return this.get(Extensible.calendar.data.EventMappings.StartDate.name)},getEndDate:function(){var e=Extensible.calendar.data.EventMappings,t=e.Duration?this.get(e.Duration.name):null;if(t!==null&&t>-1){var n={};n[Extensible.calendar.data.EventModel.resolution]=t;return Extensible.Date.add(this.getStartDate(),n)}return this.get(e.EndDate.name)},clearRecurrence:function(){var e=this,t=Extensible.calendar.data.EventMappings;delete e.data[t.OriginalEventId.name];delete e.data[t.RRule.name];delete e.data[t.RInstanceStartDate.name];delete e.data[t.REditMode.name];return e},getId:function(){return this.get(this.idProperty)}},function(){this.reconfigure()});Ext.define("Extensible.calendar.data.EventStore",{extend:"Ext.data.Store",model:"Extensible.calendar.data.EventModel",constructor:function(e){e=e||{};this.deferLoad=e.autoLoad;e.autoLoad=false;this.callParent(arguments)},load:function(e){Extensible.log("store load");e=e||{};if(e.params){delete this.initialParams}if(this.initialParams){e.params=e.params||{};Ext.apply(e.params,this.initialParams);delete this.initialParams}this.callParent(arguments)}});Ext.define("Extensible.calendar.data.CalendarModel",{extend:"Extensible.data.Model",requires:["Extensible.calendar.data.CalendarMappings"],mappingClass:"Extensible.calendar.data.CalendarMappings",mappingIdProperty:"CalendarId"},function(){this.reconfigure()});Ext.define("Extensible.calendar.data.MemoryCalendarStore",{extend:"Ext.data.Store",model:"Extensible.calendar.data.CalendarModel",requires:["Ext.data.proxy.Memory","Ext.data.reader.Json","Ext.data.writer.Json","Extensible.calendar.data.CalendarModel","Extensible.calendar.data.CalendarMappings"],proxy:{type:"memory",reader:{type:"json",root:"calendars"},writer:{type:"json"}},autoLoad:true,initComponent:function(){this.sorters=this.sorters||[{property:Extensible.calendar.data.CalendarMappings.Title.name,direction:"ASC"}];this.idProperty=this.idProperty||Extensible.calendar.data.CalendarMappings.CalendarId.name||"id";this.fields=Extensible.calendar.data.CalendarModel.prototype.fields.getRange();this.callParent(arguments)}});Ext.define("Extensible.calendar.data.MemoryEventStore",{extend:"Ext.data.Store",model:"Extensible.calendar.data.EventModel",requires:["Ext.data.proxy.Memory","Ext.data.reader.Json","Ext.data.writer.Json","Extensible.calendar.data.EventModel","Extensible.calendar.data.EventMappings"],proxy:{type:"memory",reader:{type:"json",root:"evts"},writer:{type:"json"}},idSeed:2e3,constructor:function(e){e=e||{};this.callParent(arguments);this.sorters=this.sorters||[{property:Extensible.calendar.data.EventMappings.StartDate.name,direction:"ASC"}];this.idProperty=this.idProperty||Extensible.calendar.data.EventMappings.EventId.mapping||"id";this.fields=Extensible.calendar.data.EventModel.prototype.fields.getRange();if(e.autoMsg!==false){this.on("write",this.onWrite,this)}this.autoMsg=e.autoMsg;this.onCreateRecords=Ext.Function.createInterceptor(this.onCreateRecords,this.interceptCreateRecords);this.initRecs()},interceptCreateRecords:function(e,t,n){if(n){var r=0,i,s=e.length;for(;r<s;r++){e[r].data[Extensible.calendar.data.EventMappings.EventId.name]=this.idSeed++}}},initRecs:function(){this.each(function(e){e.store=this;e.phantom=false},this)},onWrite:function(e,t){var n=this;if(Extensible.example&&Extensible.example.msg){var r=t.wasSuccessful(),i=t.records[0],s=i.data[Extensible.calendar.data.EventMappings.Title.name];switch(t.action){case"create":Extensible.example.msg("Add",'Added "'+Ext.value(s,"(No title)")+'"');break;case"update":Extensible.example.msg("Update",'Updated "'+Ext.value(s,"(No title)")+'"');break;case"destroy":Extensible.example.msg("Delete",'Deleted "'+Ext.value(s,"(No title)")+'"');break}}},onProxyLoad:function(e){var t=this,n=e.wasSuccessful(),r=e.getResultSet(),i=[];if(t.data&&t.data.length>0){t.totalCount=t.data.length;i=t.data.items}else{if(r){i=r.records;t.totalCount=r.total}if(n){t.loadRecords(i,e)}}t.loading=false;t.fireEvent("load",t,i,n)}});Ext.define("Extensible.calendar.util.WeekEventRenderer",{requires:["Ext.DomHelper"],statics:{getEventRow:function(e,t,n){var r=1,i=Ext.get(e+"-wk-"+t),s,o;if(i){o=i.child(".ext-cal-evt-tbl",true);s=o.tBodies[0].childNodes[n+r];if(!s){s=Ext.DomHelper.append(o.tBodies[0],"<tr></tr>")}}return Ext.get(s)},renderEvent:function(e,t,n,r,i,s,o){var u=Extensible.calendar.data.EventMappings,a=e.data||e.event.data,f=Ext.Date.clone(s),l=Extensible.Date.add(f,{days:i-n,millis:-1}),c=this.getEventRow(o.viewId,t,r),h=(e.event||e).getEndDate(),p=Extensible.Date.diffDays(s,h)+1,d=Math.min(p,i-n);a._weekIndex=t;a._renderAsAllDay=a[u.IsAllDay.name]||e.isSpanStart;a.spanLeft=a[u.StartDate.name].getTime()<f.getTime();a.spanRight=h.getTime()>l.getTime();a.spanCls=a.spanLeft?a.spanRight?"ext-cal-ev-spanboth":"ext-cal-ev-spanleft":a.spanRight?"ext-cal-ev-spanright":"";var v={tag:"td",cls:"ext-cal-ev",cn:o.tpl.apply(o.templateDataFn(a))};if(d>1){v.colspan=d}Ext.DomHelper.append(c,v)},render:function(e){var t=this,n="&#160;",r=0,i=e.eventGrid,s=Ext.Date.clone(e.viewStart),o="",u=e.tpl,a=e.maxEventsPerDay!==undefined?e.maxEventsPerDay:999,f=e.weekCount<1?6:e.weekCount,l=e.weekCount===1?e.dayCount:7,c,h,p,d,v,m,g,y,b,w;for(;r<f;r++){h=0;p=i[r];for(;h<l;h++){o=Ext.Date.format(s,"Ymd");if(p&&p[h]){d=0;v=0;m=p[h];g=m.length;for(;d<g;d++){if(!m[d]){if(d>=a){continue}c=t.getEventRow(e.viewId,r,d);Ext.DomHelper.append(c,{tag:"td",cls:"ext-cal-ev",html:n,id:e.viewId+"-empty-"+g+"-day-"+o})}else{if(d>=a){v++;continue}y=m[d];if(!y.isSpan||y.isSpanStart){t.renderEvent(y,r,h,d,l,s,e)}}}if(v>0){c=t.getEventRow(e.viewId,r,a);Ext.DomHelper.append(c,{tag:"td",cls:"ext-cal-ev-more",id:"ext-cal-ev-more-"+Ext.Date.format(s,"Ymd"),cn:{tag:"a",html:Ext.String.format(e.getMoreText(v),v)}})}else if(g<e.evtMaxCount[r]){c=t.getEventRow(e.viewId,r,g);if(c){b={tag:"td",cls:"ext-cal-ev",html:n,id:e.viewId+"-empty-"+(g+1)+"-day-"+o};var E=e.evtMaxCount[r]-g;if(E>1){b.rowspan=E}Ext.DomHelper.append(c,b)}}}else{c=t.getEventRow(e.viewId,r,0);if(c){b={tag:"td",cls:"ext-cal-ev",html:n,id:e.viewId+"-empty-day-"+o};if(e.evtMaxCount[r]>1){b.rowspan=e.evtMaxCount[r]}Ext.DomHelper.append(c,b)}}s=Extensible.Date.add(s,{days:1})}}}}});Ext.define("Extensible.form.field.TreeDepartmentGroupRange",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.treedepartmentgrouprangefield",requires:["Ext.form.Label","Ext.tree.Panel","Ext.data.proxy.Rest","Ext.data.reader.Json","Ext.data.writer.Json"],data:"",fieldLayout:{type:"hbox",defaultMargins:{top:0,right:0,bottom:0,left:0}},initComponent:function(){var e=this;e.layout=e.fieldLayout;MyApp.util.Utilities.userScheduleName=Global.authData.userEmpInfo.ACEMP_NAME;MyApp.util.Utilities.userScheduleID=Global.authData.userEmpInfo.ACEMP_ID*1;e.items=e.getFieldConfigs();e.callParent(arguments)},getFieldConfigs:function(){var e=this;return[e.getTreeDepartmentConfig(-1,1),e.getGroupNameConfig(),e.getTreeGroupConfig()]},getDepartments:function(){return{xtype:"extensible.departmentcombo",id:this.id+"-department",labelWidth:30,name:"department",listeners:{select:{fn:function(){this.onDepartmentComboChange()},scope:this}}}},onDepartmentComboChange:function(){var e=0;if(Ext.getCmp(this.id+"-department-checkbox-id").getValue())e=1;Ext.getCmp("trpDepartment").getStore("strpDepartment").load({params:{sectionId:Ext.getCmp(this.id+"-department").getValue(),chkOnlyActive:e}})},getIsExecutingConfig:function(){return{xtype:"checkbox",id:this.id+"-department-checkbox-id",boxLabel:"進行中のみ",handler:this.onExcutingChangeDepartment,checked:true,scope:this}},onExcutingChangeDepartment:function(){var e=0;if(Ext.getCmp(this.id+"-department-checkbox-id").getValue())e=1;Ext.getCmp("trpDepartment").getStore("strpDepartment").load({params:{sectionId:Ext.getCmp(this.id+"-department").getValue(),chkOnlyActive:e}})},getTreeDepartmentConfig:function(e,t){var n=this;var r=Ext.create("Ext.data.TreeStore",{autoLoad:false,id:"strpDepartment",itemId:"strpDepartmentItem",storeId:"strpDepartment",proxy:{type:"rest",url:apiUrl+"schedule/GetProjectBySectionExtra",extraParams:{sectionId:e,chkOnlyActive:t},reader:{type:"json"},writer:{type:"json",nameProperty:"mapping"}},scope:this});var i=Ext.create("Ext.tree.Panel",{id:"trpDepartment",itemId:"trpDepartmentItem",width:300,height:250,store:r,setRootNode:function(){if(this.getStore().autoLoad){this.callParent(arguments)}},rootVisible:false,listeners:{itemclick:{fn:function(e,t,n,r,i){if("root"!=t.data.parentId){Ext.getCmp("txtScheduleDepartment").setValue(t.data.text);Ext.getCmp(this.id+"-department-text-id-hidden").setValue(t.data.id)}},scope:this}}});return{xtype:"fieldset",title:"プロジェクト･ジョブ",columnWidth:.2,defaults:{anchor:"100%"},layout:"anchor",items:[{xtype:"container",layout:n.fieldLayout,items:[n.getDepartments(),n.getGroupNameConfigs(),n.getIsExecutingConfig()]},{xtype:"container",layout:n.fieldLayout,items:[n.getSpaceLine2()]},{xtype:"container",layout:n.fieldLayout,items:[i]},{xtype:"container",layout:n.fieldLayout,items:[n.getSpaceLine()]},{xtype:"container",layout:n.fieldLayout,items:[n.getDepartment()]},{xtype:"container",layout:n.fieldLayout,items:[n.getDepartmentHidden()]},{xtype:"container",layout:n.fieldLayout,items:[n.getSpaceLine()]}]}},getGroupNameConfig:function(){return{xtype:"label",id:this.id+"-departments-label",text:"",width:5}},getGroupNameConfigs:function(){return{xtype:"label",id:this.id+"-departments2-label",text:"",width:10}},getDepartment:function(){return{xtype:"textfield",id:"txtScheduleDepartment",itemId:this.id+"-department-text-item",width:300,readOnly:true,labelWidth:100,fieldLabel:"プロジェクト･ジョブ",name:"department"}},getDepartmentHidden:function(){return{xtype:"textfield",id:this.id+"-department-text-id-hidden",itemId:this.id+"-department-text-item-hidden",width:300,hidden:true,readOnly:true,labelWidth:100,name:"department-hidden"}},getSpaceLine:function(){return{xtype:"extensible.spaceline",itemId:this.id+"-spacelinefield",anchor:"100%"}},getSpaceLine2:function(){return{xtype:"extensible.spaceline",itemId:this.id+"-spacelinefield2",anchor:"100%"}},getTreeGroupConfig:function(){var e=this;var t=Ext.create("Ext.data.TreeStore",{autoLoad:false,id:"strpGroup",itemId:"strpGroupItem",storeId:"strpGroup",proxy:{type:"rest",extraParams:{dataMember:JSON.stringify(e.data)},url:apiUrl+"master/LoadMemberBySchedule",reader:{type:"json"},writer:{type:"json",nameProperty:"mapping"}},scope:this});var n=Ext.create("Ext.tree.Panel",{id:"trpGroup",itemId:"trpGroupItem",width:300,height:250,store:t,setRootNode:function(){if(this.getStore().autoLoad){this.callParent(arguments)}},rootVisible:false,viewConfig:{id:"treeviewGroupMember",itemId:"treeviewGroupMember",listeners:{checkchange:{fn:function(e,t,n){this.onSelectMemberChange(e,t,n);MyApp.util.Utilities.userScheduleName=Global.authData.userEmpInfo.ACEMP_NAME;Ext.getCmp("txtSchedulePerson").setValue(Global.authData.userEmpInfo.ACEMP_NAME);var r=[Global.authData.userEmpInfo.ACEMP_ID*1];Ext.getCmp("trpGroup").getView().node.cascadeBy(function(e){if(e.get("checked")===true&e.get("leaf")===true){if(e.get("id")%1===0&&r.indexOf(e.get("id")*1)==-1){r.push(e.get("id")*1);MyApp.util.Utilities.userScheduleID+=","+e.get("id")*1;MyApp.util.Utilities.userScheduleName+=","+e.get("text")}}});Ext.getCmp("txtSchedulePerson").setValue(MyApp.util.Utilities.userScheduleName);Ext.getCmp(this.id+"-person-group-id-hidden").setValue(MyApp.util.Utilities.userScheduleID)},scope:this}}}});return{xtype:"fieldset",title:"グループ",columnWidth:.2,defaults:{anchor:"100%"},layout:"anchor",items:[{xtype:"container",layout:e.fieldLayout,items:[e.getHasEditedConfig()]},{xtype:"container",layout:e.fieldLayout,items:[e.getSpaceLine2()]},{xtype:"container",layout:e.fieldLayout,items:[n]},{xtype:"container",layout:e.fieldLayout,items:[e.getSpaceLine()]},{xtype:"container",layout:e.fieldLayout,items:[e.getPerson()]},{xtype:"container",layout:e.fieldLayout,items:[e.getPersonHidden()]},{xtype:"container",layout:e.fieldLayout,items:[e.getSpaceLine()]}]}},onSelectMemberChange:function(e,t,n){e.eachChild(function(e){if(t){e.set("checked",true)}else{e.set("checked",false)}MyApp.app.common.checkChange(e,t)});this.checkParentNode(e)},checkParentNode:function(e){if(e.getDepth()>1){p=e.parentNode;var t=0;p.suspendEvents();p.eachChild(function(e){if(e.get("checked")){t++}});if(t==p.childNodes.length){p.set("checked",true)}else{p.set("checked",false)}this.checkParentNode(p);p.resumeEvents()}},getHasEditedConfig:function(){return{xtype:"checkbox",id:"chkScheduleEdited",boxLabel:"参加者も編集できる。",handler:this.onEditedChange,scope:this}},getPerson:function(){return{xtype:"textfield",id:"txtSchedulePerson",name:"person",readOnly:true,width:300,labelWidth:28,fieldLabel:"社員"}},getPersonHidden:function(){return{xtype:"textfield",id:this.id+"-person-group-id-hidden",itemId:this.id+"-person-group-item-hidden",name:"person-hidden",width:300,hidden:true,labelWidth:28}}});Ext.define("Extensible.form.field.TreeDepartmentsRange",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.treedepartmentsrangefield",requires:["Ext.form.field.ComboBox","Ext.form.Label","Ext.form.field.Checkbox"],roomText:"Rooms",allDayText:"Has Edited",fieldLayout:{type:"hbox",defaultMargins:{top:0,right:5,bottom:0,left:0}},initComponent:function(){var e=this;e.layout=e.fieldLayout;e.items=e.getFieldConfigs();e.callParent(arguments)},getFieldConfigs:function(){var e=this;return[e.getDepartments(),e.getSpaceConfig(),e.getGroupLabelConfig(),e.getHasEditedConfig()]},getDepartments:function(){return{xtype:"extensible.departmentcombo",itemId:this.id+"-department",name:"department",labelWidth:10}},getHasEditedConfig:function(){return{xtype:"checkbox",id:this.id+"-edited",boxLabel:"参加者も編集できる。",handler:this.onEditedChange,scope:this}},getSpaceConfig:function(){return{xtype:"label",id:this.id+"-spaces-label",text:"",width:4}}});Ext.define("Extensible.form.field.SpaceLine",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.spaceline",requires:["Ext.form.Label"],fieldLayout:{type:"hbox",defaultMargins:{top:0,right:0,bottom:0,left:0}},initComponent:function(){var e=this;e.items=[{xtype:"container",layout:e.fieldLayout,items:[e.getSpaceConfig()]}];e.callParent(arguments)},getSpaceConfig:function(){return{xtype:"label",id:this.id+"-spacesline-label",text:"",height:5,width:200}}});Ext.define("Extensible.form.field.TreeRange",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.treerangefield",requires:["Ext.form.Label","Ext.tree.Panel","Ext.form.field.Radio"],hasEditedText:"Has Edited",fieldLayout:{type:"hbox",defaultMargins:{top:0,right:0,bottom:0,left:0}},initComponent:function(){var e=this;e.items=[{xtype:"container",layout:e.fieldLayout,items:[e.getscopeRadioConfig()]}];e.callParent(arguments)},getscopeRadioConfig:function(){return{xtype:"fieldcontainer",defaultType:"radiofield",defaults:{flex:1},layout:"hbox",items:[{boxLabel:"公開",name:"size",inputValue:"l",width:50,checked:true,id:"rdPublic"},{boxLabel:"個人",name:"size",inputValue:"m",id:"rdPrivate"}]}}});Ext.define("Extensible.calendar.form.field.CalendarCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.calendarcombo",requires:["Extensible.calendar.data.CalendarMappings"],fieldLabel:"Calendar",triggerAction:"all",queryMode:"local",forceSelection:true,selectOnFocus:true,defaultCls:"x-cal-default",hiddenCalendarCls:"ext-cal-hidden",initComponent:function(){this.valueField=Extensible.calendar.data.CalendarMappings.CalendarId.name;this.displayField=Extensible.calendar.data.CalendarMappings.Title.name;this.listConfig=Ext.apply(this.listConfig||{},{getInnerTpl:this.getListItemTpl});this.store.on("update",this.refreshColorCls,this);this.callParent(arguments)},getListItemTpl:function(e){return'<div class="x-combo-list-item x-cal-{'+Extensible.calendar.data.CalendarMappings.ColorId.name+'}"><div class="ext-cal-picker-icon">&#160;</div>{'+e+"}</div>"},afterRender:function(){this.callParent(arguments);this.wrap=this.el.down(".x-form-item-body");this.wrap.addCls("ext-calendar-picker");this.icon=Ext.core.DomHelper.append(this.wrap,{tag:"div",cls:"ext-cal-picker-icon ext-cal-picker-mainicon"})},refreshColorCls:function(){var e=this,t=Extensible.calendar.data.CalendarMappings,n="",r=e.getValue();if(!e.wrap){return e}if(e.currentStyleClss!==undefined){e.wrap.removeCls(e.currentStyleClss)}if(!Ext.isEmpty(r)){if(Ext.isArray(r)){r=r[0]}if(!r.data){r=this.store.findRecord(t.CalendarId.name,r)}n="x-cal-"+(r.data?r.data[t.ColorId.name]:r)}e.currentStyleClss=n;e.wrap.addCls(n);return e},setValue:function(e){if(!e&&this.store.getCount()>0){e=this.store.getAt(0).data[Extensible.calendar.data.CalendarMappings.CalendarId.name]}this.callParent(arguments);this.refreshColorCls()}});Ext.define("Extensible.form.field.DateRange",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.daterangefield",requires:["Ext.form.field.Date","Ext.form.field.Time","Ext.form.Label","Ext.form.field.Checkbox"],toText:"まで:",fromText:"から:",allDayText:"終日として作成",singleLine:true,dateFormat:"Y/m/d",startDay:0,fieldLayout:{type:"hbox",defaultMargins:{top:0,right:0,bottom:0,left:0}},initComponent:function(){var e=this;e.timeFormat=e.timeFormat||(Extensible.Date.use24HourTime?"G:i":"g:i A");e.addCls("ext-dt-range");if(e.singleLine){e.layout=e.fieldLayout;e.items=e.getFieldConfigs()}else{e.items=[{xtype:"container",layout:e.fieldLayout,items:[e.getStartDateConfig(),e.getStartTimeConfig(),e.getDateSeparatorConfig()]},{xtype:"container",layout:e.fieldLayout,items:[e.getEndDateConfig(),e.getEndTimeConfig(),e.getAllDayConfig()]}]}e.callParent(arguments);e.initRefs()},initRefs:function(){var e=this;e.startDate=e.down("#"+e.id+"-start-date");e.startTime=e.down("#"+e.id+"-start-time");e.endTime=e.down("#"+e.id+"-end-time");e.endDate=e.down("#"+e.id+"-end-date");e.allDay=e.down("#"+e.id+"-allday");e.toLabel=e.down("#"+e.id+"-to-label")},getFieldConfigs:function(){var e=this;return[e.getAllDayConfig(),e.getSpace1Config(),e.getStartDateSeparatorConfig(),e.getStartDateConfig(),e.getStartTimeConfig(),e.getDateSeparatorConfig(),e.getEndDateConfig(),e.getEndTimeConfig()]},getSpace1Config:function(){return{xtype:"label",id:this.id+"-spaces1-label",text:"",width:10}},getSpace2Config:function(){return{xtype:"label",id:this.id+"-spaces2-label",text:"",width:2}},getSpace3Config:function(){return{xtype:"label",id:this.id+"-spaces3-label",text:"",width:2}},getLayoutItems:function(e){var t=this;return e?t.items.items:[[t.startDate,t.startTime,t.toLabel],[t.endDate,t.endTime,t.allDay]]},getStartDateConfig:function(){return{xtype:"datefield",id:this.id+"-start-date",format:this.dateFormat,width:100,allowBlank:false,editable:false,margin:{top:0,right:0,bottom:0,left:4},startDay:this.startDay,listeners:{change:{fn:function(){this.onFieldChange("date","start")},scope:this}}}},getStartTimeConfig:function(){return{xtype:"timefield",id:this.id+"-start-time",hidden:this.showTimes===false,labelWidth:0,hideLabel:true,width:80,margin:{top:0,right:0,bottom:0,left:5},minValue:"8:00 AM",maxValue:"10:00 PM",editable:false,format:this.timeFormat,listeners:{select:{fn:function(){this.onFieldChange("time","start")},scope:this}}}},getEndDateConfig:function(){return{xtype:"datefield",id:this.id+"-end-date",format:this.dateFormat,hideLabel:true,allowBlank:false,editable:false,width:100,margin:{top:0,right:0,bottom:0,left:5},startDay:this.startDay,listeners:{change:{fn:function(){this.onFieldChange("date","end")},scope:this}}}},getEndTimeConfig:function(){return{xtype:"timefield",id:this.id+"-end-time",hidden:this.showTimes===false,labelWidth:0,hideLabel:true,width:80,margin:{top:0,right:0,bottom:0,left:5},editable:false,minValue:"8:00 AM",maxValue:"10:00 PM",format:this.timeFormat,listeners:{select:{fn:function(){this.onFieldChange("time","end")},scope:this}}}},getAllDayConfig:function(){return{xtype:"checkbox",id:this.id+"-allday",hidden:this.showTimes===false||this.showAllDay===false,boxLabel:this.allDayText,handler:this.onAllDayChange,scope:this}},onAllDayChange:function(e,t){this.startTime.setVisible(!t);this.endTime.setVisible(!t)},getDateSeparatorConfig:function(){return{xtype:"label",id:this.id+"-to-label",text:this.toText,margins:{top:4,right:5,bottom:0,left:9}}},getStartDateSeparatorConfig:function(){return{xtype:"label",id:this.id+"-from-label",text:this.fromText,margins:{top:4,right:5,bottom:0,left:9}}},isSingleLine:function(){var e=this;if(e.calculatedSingleLine===undefined){if(e.singleLine==="auto"){var t=e.ownerCt.getEl(),n=e.ownerCt.getWidth()-t.getPadding("lr"),r=t.down(".x-panel-body");if(r){n-=r.getPadding("lr")}r=t.down(".x-form-item-label");if(r){n-=r.getWidth()-r.getPadding("lr")}e.calculatedSingleLine=n<=e.singleLineMinWidth?false:true}else{e.calculatedSingleLine=e.singleLine!==undefined?e.singleLine:true}}return e.calculatedSingleLine},onFieldChange:function(e,t){this.checkDates(e,t);this.fireEvent("change",this,this.getValue())},checkDates:function(e,t){var n=this,r=e==="date"?"Date":"Time",i=this["start"+r],s=this["end"+r],o=n.getDT("start"),u=n.getDT("end");if(o>u){if(t==="start"){s.setValue(o)}else{i.setValue(u);n.checkDates(e,"start")}}if(e==="date"){n.checkDates("time",t)}},getValue:function(){return[this.getDT("start"),this.getDT("end"),this.allDay.getValue()]},getDT:function(e){var t=this[e+"Time"].getValue(),n=this[e+"Date"].getValue();if(Ext.isDate(n)){n=Ext.Date.format(n,this[e+"Date"].format)}else{return null}if(t&&t!==""){t=Ext.Date.format(t,this[e+"Time"].format);var r=Ext.Date.parseDate(n+" "+t,this[e+"Date"].format+" "+this[e+"Time"].format);return r}return Ext.Date.parseDate(n,this[e+"Date"].format)},setValue:function(e){if(!e){return}var t=this,n=Extensible.calendar.data.EventMappings,r=n.StartDate.name;if(Ext.isArray(e)){t.setDT(e[0],"start");t.setDT(e[1],"end");t.allDay.setValue(!!e[2])}else if(Ext.isDate(e)){t.setDT(e,"start");t.setDT(e,"end");t.allDay.setValue(false)}else if(e[r]){t.setDT(e[r],"start");if(!t.setDT(e[n.EndDate.name],"end")){t.setDT(e[r],"end")}t.allDay.setValue(!!e[n.IsAllDay.name])}},setDT:function(e,t){if(e&&Ext.isDate(e)){this[t+"Date"].setValue(e);this[t+"Time"].setValue(Ext.Date.format(e,this[t+"Time"].format));return true}},isDirty:function(){var e=false;if(this.rendered&&!this.disabled){this.items.each(function(t){if(t.isDirty()){e=true;return false}})}return e},reset:function(){this.delegateFn("reset")},delegateFn:function(e){this.items.each(function(t){if(t[e]){t[e]()}})},beforeDestroy:function(){Ext.destroy(this.fieldCt);this.callParent(arguments)},getRawValue:Ext.emptyFn,setRawValue:Ext.emptyFn});Ext.define("Extensible.form.field.ComboRange",{extend:"Ext.form.FieldContainer",alias:"widget.extensible.comborangefield",requires:["Ext.form.field.ComboBox","Ext.form.Label","Ext.form.field.Checkbox"],roomText:"Rooms",editedText:"Has Edited",fieldLayout:{type:"hbox",defaultMargins:{top:0,right:5,bottom:0,left:0}},initComponent:function(){var e=this;e.layout=e.fieldLayout;e.items=e.getFieldConfigs();e.callParent(arguments)},getFieldConfigs:function(){var e=this;return[e.getPlanType(),e.getSpace1Config(),e.getRoom(),e.getSpace2Config(),e.getStatus()]},getPlanType:function(){return{xtype:"extensible.plantypecombo",itemId:this.id+"-plantype",name:"plantypename",editable:false,width:226,labelWidth:80}},getRoom:function(){return{xtype:"extensible.roomcombo",itemId:"cboScheduleRooms",name:"roomname",editable:false,width:190,labelWidth:40}},getSpace1Config:function(){return{xtype:"label",id:this.id+"-spaces1-label",text:"",width:6}},getSpace2Config:function(){return{xtype:"label",id:this.id+"-spaces2-label",text:"",width:7}},getStatus:function(){return{xtype:"extensible.staffstatuscombo",itemId:this.id+"-status",name:"statusname",labelWidth:53,disabled:true,width:200}}});Ext.define("Extensible.calendar.form.field.DepartmentCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.departmentcombo",requires:["Ext.data.ArrayStore"],fieldLabel:"部署",labelWidth:10,width:200,queryMode:"local",triggerAction:"all",forceSelection:true,displayField:"desc",valueField:"values",value:-1,editable:false,noneText:"None",reminderValueFormat:"{0} {1} before start",initComponent:function(){this.store=this.store||Ext.create("Ext.data.ArrayStore",{fields:["values","desc"],idIndex:0,data:this.getValueList()});this.callParent(arguments)},getValueList:function(){var e=this;var t=[];Ext.Ajax.request({type:"rest",async:false,url:apiUrl+"schedule/GetSection",success:function(e){t=Ext.decode(e.responseText,true)},failure:function(e,t){return[]},scope:e});return t}});Ext.define("Extensible.calendar.form.field.PlanTypeCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.plantypecombo",id:"cboSchedulePlanType",requires:["Ext.data.ArrayStore"],fieldLabel:"予定タイプ",queryMode:"local",triggerAction:"all",forceSelection:true,displayField:"desc",valueField:"value",value:1,noneText:"None",atStartTimeText:"None",reminderValueFormat:"{0} {1} before start",initComponent:function(){this.store=this.store||Ext.create("Ext.data.ArrayStore",{fields:["value","desc"],idIndex:0,data:this.getValueList()});this.callParent(arguments)},getValueList:function(){var e=this;var t=[];Ext.Ajax.request({type:"rest",async:false,url:apiUrl+"schedule/GetType",success:function(e){t=Ext.decode(e.responseText,true)},failure:function(e,t){return[]},scope:e});return t}});Ext.define("Extensible.calendar.form.field.StaffStatusCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.staffstatuscombo",requires:["Ext.data.ArrayStore"],fieldLabel:"参加予定",queryMode:"local",triggerAction:"all",forceSelection:true,displayField:"desc",valueField:"value",value:1,noneText:"None",anchor:"30%",atStartTimeText:"None",reminderValueFormat:"{0} {1} before start",initComponent:function(){this.store=this.store||Ext.create("Ext.data.ArrayStore",{fields:["value","desc"],idIndex:0,data:this.getValueList()});this.callParent(arguments)},getValueList:function(){var e=this;var t=[];Ext.Ajax.request({type:"rest",async:false,url:apiUrl+"schedule/getStaffStatus",success:function(e){t=Ext.decode(e.responseText,true)},failure:function(e,t){return[]},scope:e});return t}});Ext.define("Extensible.calendar.form.field.RoomCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.roomcombo",requires:["Ext.data.ArrayStore"],id:"cboScheduleRooms",fieldLabel:"会議室",queryMode:"local",triggerAction:"all",forceSelection:true,displayField:"desc",valueField:"value",value:-1,noneText:"None",atStartTimeText:"None",reminderValueFormat:"{0} {1} before start",initComponent:function(){this.store=this.store||Ext.create("Ext.data.ArrayStore",{fields:["value","desc"],idIndex:0,data:this.getValueList()});this.callParent(arguments)},getValueList:function(){var e=this;var t=[];Ext.Ajax.request({type:"rest",async:false,url:apiUrl+"schedule/GetRoom",success:function(e){t=Ext.decode(e.responseText,true)},failure:function(e,t){return[]},scope:e});return t}});Ext.define("Extensible.calendar.form.field.ReminderCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.extensible.remindercombo",requires:["Ext.data.ArrayStore"],fieldLabel:"Reminder",queryMode:"local",triggerAction:"all",forceSelection:true,displayField:"desc",valueField:"value",noneText:"None",atStartTimeText:"At start time",reminderValueFormat:"{0} {1} before start",minutesText:"minutes",hourText:"hour",hoursText:"hours",dayText:"day",daysText:"days",weekText:"week",weeksText:"weeks",initComponent:function(){this.store=this.store||Ext.create("Ext.data.ArrayStore",{fields:["value","desc"],idIndex:0,data:this.getValueList()});this.callParent(arguments)},getValueList:function(){var e=this,t=e.reminderValueFormat,n=Ext.String.format;return[["",e.noneText],["0",e.atStartTimeText],["5",n(t,"5",e.getMinutesText(5))],["15",n(t,"15",e.getMinutesText(15))],["30",n(t,"30",e.getMinutesText(30))],["60",n(t,"1",e.getHoursText(1))],["90",n(t,"1.5",e.getHoursText(1.5))],["120",n(t,"2",e.getHoursText(2))],["180",n(t,"3",e.getHoursText(3))],["360",n(t,"6",e.getHoursText(6))],["720",n(t,"12",e.getHoursText(12))],["1440",n(t,"1",e.getDaysText(1))],["2880",n(t,"2",e.getDaysText(2))],["4320",n(t,"3",e.getDaysText(3))],["5760",n(t,"4",e.getDaysText(4))],["7200",n(t,"5",e.getDaysText(5))],["10080",n(t,"1",e.getWeeksText(1))],["20160",n(t,"2",e.getWeeksText(2))]]},getMinutesText:function(e){return e===1?this.minuteText:this.minutesText},getHoursText:function(e){return e===1?this.hourText:this.hoursText},getDaysText:function(e){return e===1?this.dayText:this.daysText},getWeeksText:function(e){return e===1?this.weekText:this.weeksText},initValue:function(){if(this.value!==undefined){this.setValue(this.value)}else{this.setValue("")}this.originalValue=this.getValue()}});Ext.define("Extensible.calendar.util.ColorPicker",{extend:"Ext.picker.Color",alias:"widget.extensible.calendarcolorpicker",requires:["Ext.XTemplate"],colorCount:32,constructor:function(){this.renderTpl=['<tpl for="colors">','<a href="#" class="x-cal-{.}" hidefocus="on">','<em><span unselectable="on">&#160;</span></em>',"</a>","</tpl>"];this.callParent(arguments)},initComponent:function(){this.callParent(arguments);this.addCls("x-calendar-palette");if(this.handler){this.on("select",this.handler,this.scope||this,{delegate:"a"})}this.colors=[];for(var e=1;e<=this.colorCount;e++){this.colors.push(e)}},handleClick:function(e,t){e.preventDefault();var n=t.className.split(" "),r;Ext.each(n,function(e){if(e.indexOf("x-cal-")>-1){r=e.split("x-cal-")[1];return false}});if(r){this.select(r)}},select:function(e,t){var n=this,r=n.selectedCls,i=n.value;if(!n.rendered){n.value=e;return}if(e!==i||n.allowReselect){var s=n.el;if(n.value){s.down(".x-cal-"+i).removeCls(r)}s.down(".x-cal-"+e).addCls(r);n.value=e;if(t!==true){n.fireEvent("select",n,e)}}}});Ext.define("Extensible.calendar.gadget.CalendarListMenu",{extend:"Ext.menu.Menu",alias:"widget.extensible.calendarlistmenu",requires:["Extensible.calendar.util.ColorPicker"],hideOnClick:true,ignoreParentClicks:true,displayOnlyThisCalendarText:"Display only this calendar",enableScrolling:false,initComponent:function(){this.addEvents("showcalendar","hidecalendar","radiocalendar","colorchange");Ext.apply(this,{plain:true,items:[{text:this.displayOnlyThisCalendarText,iconCls:"extensible-cal-icon-cal-show",handler:Ext.bind(this.handleRadioCalendarClick,this)},"-",{xtype:"extensible.calendarcolorpicker",id:this.id+"-calendar-color-picker",handler:Ext.bind(this.handleColorSelect,this)}]});this.addClass("x-calendar-list-menu");this.callParent(arguments)},afterRender:function(){this.callParent(arguments);this.palette=this.down("#"+this.id+"-calendar-color-picker");if(this.colorId){this.palette.select(this.colorId,true)}},handleRadioCalendarClick:function(e,t){this.fireEvent("radiocalendar",this,this.calendarId)},handleColorSelect:function(e,t){this.fireEvent("colorchange",this,this.calendarId,t,this.colorId);this.colorId=t;this.menuHide()},setCalendar:function(e,t){this.calendarId=e;this.colorId=t;if(this.rendered){this.palette.select(t,true)}return this},menuHide:function(){if(this.hideOnClick){this.hide()}}});Ext.define("Extensible.calendar.gadget.CalendarListPanel",{extend:"Ext.panel.Panel",alias:"widget.extensible.calendarlist",requires:["Ext.XTemplate","Extensible.calendar.gadget.CalendarListMenu"],title:"Calendars",collapsible:true,autoHeight:true,layout:"fit",menuSelector:"em",width:100,initComponent:function(){this.addCls("x-calendar-list");this.callParent(arguments)},afterRender:function(e,t){this.callParent(arguments);if(this.store){this.setStore(this.store,true)}this.refresh();this.body.on("click",this.onClick,this);this.body.on("mouseover",this.onMouseOver,this,{delegate:"li"});this.body.on("mouseout",this.onMouseOut,this,{delegate:"li"})},getListTemplate:function(){if(!this.tpl){this.tpl=!(Ext.isIE||Ext.isOpera)?Ext.create("Ext.XTemplate",'<ul class="x-unselectable">','<tpl for=".">','<li id="{cmpId}" class="ext-cal-evr {colorCls} {hiddenCls}">{title}<em>&#160;</em></li>',"</tpl>","</ul>"):Ext.create("Ext.XTemplate",'<ul class="x-unselectable">','<tpl for=".">','<li id="{cmpId}" class="ext-cal-evo {colorCls} {hiddenCls}">','<div class="ext-cal-evm">','<div class="ext-cal-evi">{title}<em>&#160;</em></div>',"</div>","</li>","</tpl>","</ul>");this.tpl.compile()}return this.tpl},setStore:function(e,t){if(!t&&this.store){this.store.un("load",this.refresh,this);this.store.un("add",this.refresh,this);this.store.un("remove",this.refresh,this);this.store.un("update",this.onUpdate,this);this.store.un("clear",this.refresh,this)}if(e){e.on("load",this.refresh,this);e.on("add",this.refresh,this);e.on("remove",this.refresh,this);e.on("update",this.onUpdate,this);e.on("clear",this.refresh,this)}this.store=e},onUpdate:function(e,t,n){if(n===Ext.data.Record.COMMIT){this.refresh()}},refresh:function(){if(this.skipRefresh){return}var e=[],t=0,n=null,r=Extensible.calendar.data.CalendarMappings,i=this.store.getRange(),s=i.length;for(;t<s;t++){n={cmpId:this.id+"__"+i[t].data[r.CalendarId.name],title:i[t].data[r.Title.name],colorCls:this.getColorCls(i[t].data[r.ColorId.name])};if(i[t].data[r.IsHidden.name]===true){n.hiddenCls="ext-cal-hidden"}e[e.length]=n}this.getListTemplate().overwrite(this.body,e)},getColorCls:function(e){return"x-cal-"+e+"-ad"},toggleCalendar:function(e,t){var n=this.store.findRecord(Extensible.calendar.data.CalendarMappings.CalendarId.name,e),r=Extensible.calendar.data.CalendarMappings,i=n.data[r.IsHidden.name];n.set(r.IsHidden.name,!i);if(t!==false){n.commit()}},showCalendar:function(e,t){var n=this.store.findRecord(Extensible.calendar.data.CalendarMappings.CalendarId.name,e);if(n.data[Extensible.calendar.data.CalendarMappings.IsHidden.name]===true){this.toggleCalendar(e,t)}},hideCalendar:function(e,t){var n=this.store.findRecord(Extensible.calendar.data.CalendarMappings.CalendarId.name,e);if(n.data[Extensible.calendar.data.CalendarMappings.IsHidden.name]!==true){this.toggleCalendar(e,t)}},radioCalendar:function(e){var t=0,n,r=Extensible.calendar.data.CalendarMappings.CalendarId.name,i=this.store.getRange(),s=i.length;for(;t<s;t++){n=i[t].data[r];if(n===e){this.showCalendar(n,false)}else{this.hideCalendar(n,false)}}this.skipRefresh=true;this.store.sync();delete this.skipRefresh;this.refresh()},onMouseOver:function(e,t){Ext.fly(t).addCls("hover")},onMouseOut:function(e,t){Ext.fly(t).removeCls("hover")},getCalendarId:function(e){return e.id.split("__")[1]},getCalendarItemEl:function(e){return Ext.get(this.id+"__"+e)},onClick:function(e,t){var n=e.getTarget(this.menuSelector,3,true);if(n){this.showEventMenu(n,e.getXY())}else{n=e.getTarget("li",3,true);if(n){this.toggleCalendar(this.getCalendarId(n))}}},handleColorChange:function(e,t,n,r){var i=this.store.findRecord(Extensible.calendar.data.CalendarMappings.CalendarId.name,t);i.data[Extensible.calendar.data.CalendarMappings.ColorId.name]=n;i.commit()},handleRadioCalendar:function(e,t){this.radioCalendar(t)},showEventMenu:function(e,t){var n=this.getCalendarId(e.parent("li")),r=this.store.findRecord(Extensible.calendar.data.CalendarMappings.CalendarId.name,n),i=r.data[Extensible.calendar.data.CalendarMappings.ColorId.name];if(!this.menu){this.menu=Ext.create("Extensible.calendar.gadget.CalendarListMenu");this.menu.on("colorchange",this.handleColorChange,this);this.menu.on("radiocalendar",this.handleRadioCalendar,this)}this.menu.setCalendar(n,i);this.menu.showAt(t)}});Ext.define("Extensible.calendar.menu.Event",{extend:"Ext.menu.Menu",alias:"widget.extensible.eventcontextmenu",requires:["Ext.menu.DatePicker"],hideOnClick:true,ignoreParentClicks:true,startDay:0,editDetailsText:"Edit Details",deleteText:"Delete",moveToText:"Move to...",copyToText:"Copy to...",enableScrolling:false,ownerCalendarPanel:{},initComponent:function(){this.addEvents("editdetails","eventdelete","eventmove","eventcopy");this.buildMenu();this.callParent(arguments)},buildMenu:function(){var e=this;if(e.rendered){return}e.dateMenu=Ext.create("Ext.menu.DatePicker",{scope:e,startDay:e.startDay,handler:e.onEventMoveSelected});e.copyMenu=Ext.create("Ext.menu.DatePicker",{scope:e,startDay:e.startDay,handler:e.onEventCopySelected});Ext.apply(e,{items:[{text:e.editDetailsText,iconCls:"extensible-cal-icon-evt-edit",scope:e,handler:function(){e.fireEvent("editdetails",e,e.rec,e.ctxEl)}},{text:e.deleteText,iconCls:"extensible-cal-icon-evt-del",scope:e,handler:function(){e.fireEvent("eventdelete",e,e.rec,e.ctxEl)}},"-",{text:e.moveToText,iconCls:"extensible-cal-icon-evt-move",menu:e.dateMenu},{text:e.copyToText,iconCls:"extensible-cal-icon-evt-copy",menu:e.copyMenu}]})},onEventMoveSelected:function(e,t){this.doCopyOrMove(t,"move")},onEventCopySelected:function(e,t){this.doCopyOrMove(t,"copy")},doCopyOrMove:function(e,t){e=Extensible.Date.copyTime(this.rec.data[Extensible.calendar.data.EventMappings.StartDate.name],e);this.fireEvent("event"+t,this,this.rec,e)},showForEvent:function(e,t,n){var r=this,i=e.data[Extensible.calendar.data.EventMappings.StartDate.name];r.rec=e;r.ctxEl=t;r.dateMenu.picker.setValue(i);r.copyMenu.picker.setValue(i);r.showAt(n)},onHide:function(){this.callParent(arguments)},onDestroy:function(){delete this.ctxEl;this.callParent(arguments)}});Ext.define("Extensible.calendar.form.EventDetails",{extend:"Ext.form.Panel",alias:"widget.extensible.eventeditform",requires:["Extensible.form.field.DateRange","Extensible.calendar.form.field.ReminderCombo","Extensible.calendar.data.EventMappings","Extensible.calendar.form.field.CalendarCombo","Extensible.form.recurrence.Fieldset","Ext.layout.container.Column","Extensible.form.recurrence.RangeEditWindow"],labelWidth:65,labelWidthRightCol:65,colWidthLeft:".95",colWidthRight:".05",fieldAnchor:"100%",title:"Event Form",titleTextAdd:"スケジュールの新規作成 ",titleTextEdit:"Edit Event",titleLabelText:"Title",datesLabelText:"When",reminderLabelText:"Reminder",notesLabelText:"Notes",locationLabelText:"Location",webLinkLabelText:"Web Link",calendarLabelText:"Calendar",repeatsLabelText:"Repeats",saveButtonText:"保存",deleteButtonText:"Delete",cancelButtonText:"キャンセル",bodyStyle:"padding:20px 20px 10px;",border:false,buttonAlign:"center",autoScroll:true,startDay:0,recurrence:false,allowDefaultAdd:true,layout:"column",initComponent:function(){this.addEvents({eventadd:true,eventupdate:true,eventdelete:true,eventcancel:true});this.titleField=Ext.create("Ext.form.field.Text",{fieldLabel:this.titleLabelText,name:Extensible.calendar.data.EventMappings.Title.name,anchor:this.fieldAnchor});this.dateRangeField=Ext.create("Extensible.form.field.DateRange",{fieldLabel:this.datesLabelText,singleLine:false,anchor:this.fieldAnchor,startDay:this.startDay,listeners:{change:Ext.bind(this.onDateChange,this)}});this.reminderField=Ext.create("Extensible.calendar.form.field.ReminderCombo",{name:Extensible.calendar.data.EventMappings.Reminder.name,fieldLabel:this.reminderLabelText,anchor:this.fieldAnchor});this.notesField=Ext.create("Ext.form.field.TextArea",{fieldLabel:this.notesLabelText,name:Extensible.calendar.data.EventMappings.Notes.name,grow:true,growMax:150,anchor:this.fieldAnchor});this.locationField=Ext.create("Ext.form.field.Text",{fieldLabel:this.locationLabelText,name:Extensible.calendar.data.EventMappings.Location.name,anchor:this.fieldAnchor});this.urlField=Ext.create("Ext.form.field.Text",{fieldLabel:this.webLinkLabelText,name:Extensible.calendar.data.EventMappings.Url.name,anchor:this.fieldAnchor});var e=[],t=[this.titleField,this.dateRangeField,this.reminderField,this.notesField,this.locationField,this.urlField];if(this.recurrence){this.recurrenceField=Ext.create("Extensible.form.recurrence.Fieldset",{recurrenceOptions:this.recurrence,name:Extensible.calendar.data.EventMappings.RRule.name,fieldLabel:this.repeatsLabelText,startDay:this.startDay,anchor:this.fieldAnchor,listeners:{startchange:Ext.bind(this.onRecurrenceStartChange,this)}});t.splice(2,0,this.recurrenceField)}if(this.calendarStore){this.calendarField=Ext.create("Extensible.calendar.form.field.CalendarCombo",{store:this.calendarStore,fieldLabel:this.calendarLabelText,name:Extensible.calendar.data.EventMappings.CalendarId.name,anchor:this.fieldAnchor});t.splice(2,0,this.calendarField)}var n=Math.max(this.labelWidthRightCol,this.labelWidth);this.items=[{id:this.id+"-left-col",columnWidth:this.colWidthLeft,layout:"anchor",fieldDefaults:{labelWidth:n},border:false,items:t},{id:this.id+"-right-col",columnWidth:this.colWidthRight,layout:"anchor",fieldDefaults:{labelWidth:n},border:false,items:e}];this.fbar=[{text:this.saveButtonText,scope:this,handler:this.onSave},{itemId:this.id+"-del-btn",text:this.deleteButtonText,scope:this,handler:this.onDelete},{text:this.cancelButtonText,scope:this,handler:this.onCancel}];this.addCls("ext-evt-edit-form");Ext.apply(this.initialConfig,{trackResetOnLoad:true});this.callParent(arguments)},onDateChange:function(e,t){if(this.recurrenceField){this.recurrenceField.setStartDate(t[0])}},onRecurrenceStartChange:function(e,t,n){this.dateRangeField.setValue(t)},loadRecord:function(e){var t=this,n=Extensible.calendar.data.EventMappings;t.form.reset().loadRecord.apply(t.form,arguments);t.activeRecord=e;t.dateRangeField.setValue(e.data);if(t.recurrenceField){var r=e.get(n.RSeriesStartDate.name)||e.get(n.StartDate.name);t.recurrenceField.suspendEvents();t.recurrenceField.setStartDate(r);t.recurrenceField.setValue(e.get(n.RRule.name));t.recurrenceField.resumeEvents();if(!e.data[n.RInstanceStartDate.name]){e.data[n.RInstanceStartDate.name]=e.getStartDate()}}if(t.calendarField){t.calendarField.setValue(e.data[n.CalendarId.name])}if(e.phantom){t.setTitle(t.titleTextAdd);t.down("#"+t.id+"-del-btn").hide()}else{t.setTitle(t.titleTextEdit);t.down("#"+t.id+"-del-btn").show()}t.form.getFields().each(function(e){e.resetOriginalValue()});t.titleField.focus()},updateRecord:function(e){var t=e.fields,n=this.getForm().getValues(),r=Extensible.calendar.data.EventMappings,i,s={};t.each(function(e){i=e.name;if(i in n){s[i]=n[i]}});var o=this.dateRangeField.getValue(),u=s[r.IsAllDay.name]=o[2],a=u?Extensible.Date.clearTime(o[0]):o[0],f=u?Extensible.Date.clearTime(o[1]):o[1],l={days:1};l[Extensible.calendar.data.EventModel.resolution]=-1;s[r.StartDate.name]=a;s[r.EndDate.name]=u?Extensible.Date.add(f,l):f;if(r.Duration){s[r.Duration.name]=Extensible.Date.diff(a,s[r.EndDate.name],Extensible.calendar.data.EventModel.resolution)}e.set(s);return e.dirty||e.phantom&&this.allowDefaultAdd},onCancel:function(){this.cleanup(true);this.fireEvent("eventcancel",this,this.activeRecord)},cleanup:function(e){if(this.activeRecord){this.activeRecord.reject()}delete this.activeRecord;if(this.form.isDirty()){this.form.reset()}},onSave:function(){var e=this,t=e.activeRecord.isRecurring();if(!e.form.isValid()&&!e.allowDefaultAdd){return}if(!e.updateRecord(e.activeRecord)){e.onCancel();return}if(e.activeRecord.phantom){e.fireEvent("eventadd",e,e.activeRecord)}else{if(t&&e.activeRecord.isRecurring()){e.onRecurrenceUpdate()}else{e.fireEvent("eventupdate",e,e.activeRecord)}}},onRecurrenceUpdate:function(){this.rangeEditWin=this.rangeEditWin||Ext.WindowMgr.get("ext-cal-rangeeditwin");if(!this.rangeEditWin){this.rangeEditWin=new Extensible.form.recurrence.RangeEditWindow}this.rangeEditWin.prompt({callback:this.onRecurrenceEditModeSelected,scope:this})},onRecurrenceEditModeSelected:function(e){var t=this;if(e){t.activeRecord.data[Extensible.calendar.data.EventMappings.REditMode.name]=e;t.fireEvent("eventupdate",t,t.activeRecord,t.animateTarget)}},onDelete:function(){this.fireEvent("eventdelete",this,this.activeRecord)}});Ext.define("Extensible.calendar.form.EventWindow",{extend:"Ext.window.Window",alias:"widget.extensible.eventeditwindow",requires:["Ext.form.Panel","Extensible.calendar.data.EventModel","Extensible.calendar.data.EventMappings","Extensible.form.recurrence.RangeEditWindow"],titleTextAdd:"スケジュールの新規作成 ",titleTextEdit:"イベント編集",width:681,height:615,detailsLinkText:"詳細編集...",savingMessage:"Saving changes...",deletingMessage:"Deleting event...",saveButtonText:"保存",deleteButtonText:"削除",cancelButtonText:"キャンセル",titleLabelText:"題名",datesLabelText:"日時",planLabelText:"予定タイプ",roomLabelText:"会議室",personLabelText:"社員",departmentLabelText:"部署",treeLabelText:"プライバシー",treeDepartmentLabelText:"Departments",treeDepartmentPersonLabelText:"プロジェクト･ジョブ",notesLabelText:"備考",startDay:0,closeAction:"hide",modal:false,resizable:false,constrain:true,buttonAlign:"left",editDetailsLinkClass:"edit-dtl-link",enableEditDetails:true,layout:"fit",formPanelConfig:{border:false},allowDefaultAdd:true,initComponent:function(){this.addEvents({eventadd:true,eventupdate:true,eventdelete:true,eventcancel:true,editdetails:true});this.fbar=this.getFooterBarConfig();this.callParent(arguments)},getFooterBarConfig:function(){var e=["->",{text:this.saveButtonText,itemId:this.id+"-save-btn",disabled:false,handler:this.onSave,scope:this},{text:this.deleteButtonText,itemId:this.id+"-delete-btn",disabled:false,handler:this.onDelete,scope:this,hideMode:"offsets"},{text:this.cancelButtonText,itemId:this.id+"-cancel-btn",disabled:false,handler:this.onCancel,scope:this}];if(this.enableEditDetails!==false){e.unshift({xtype:"tbtext",itemId:this.id+"-details-btn",text:""})}return e},onRender:function(e,t){this.formPanel=Ext.create("Ext.form.Panel",Ext.applyIf({fieldDefaults:{labelWidth:this.labelWidth},items:this.getFormItemConfigs()},this.formPanelConfig));this.add(this.formPanel);this.callParent(arguments)},getFormItemConfigs:function(){var e=[{xtype:"textfield",itemId:this.id+"-title",id:"txtScheduleTitle",name:Extensible.calendar.data.EventMappings.Title.name,fieldLabel:this.titleLabelText,labelWidth:80,anchor:"100%"},{xtype:"extensible.daterangefield",itemId:this.id+"-dates",name:"dates",anchor:"100%",singleLine:true,labelWidth:80,startDay:this.startDay,fieldLabel:this.datesLabelText}];e.push({xtype:"extensible.comborangefield",itemId:this.id+"-plancombo",name:"plancombo",anchor:"100%"});e.push({xtype:"extensible.treedepartmentgrouprangefield",itemId:this.id+"-treedepartmentrangefield",name:"treedepartmentrangefield",anchor:"100%",data:MyApp.util.Utilities.userScheduleID});e.push({xtype:"extensible.treerangefield",itemId:this.id+"-treegrouprangefield",anchor:"100%",labelWidth:75,name:"treegrouprangefield",fieldLabel:this.treeLabelText});e.push(Ext.create("Ext.form.field.TextArea",{fieldLabel:this.notesLabelText,labelWidth:35,name:Extensible.calendar.data.EventMappings.Notes.name,grow:true,growMax:200,height:90,anchor:"100%"}));return e},afterRender:function(){this.callParent(arguments);this.el.addCls("ext-cal-event-win");this.initRefs();var e=this.getDockedItems("toolbar")[0].items.items[0];if(e.el.hasCls("x-component-default")){Ext.destroy(e)}},initRefs:function(){this.saveButton=this.down("#"+this.id+"-save-btn");this.deleteButton=this.down("#"+this.id+"-delete-btn");this.cancelButton=this.down("#"+this.id+"-cancel-btn");this.detailsButton=this.down("#"+this.id+"-details-btn");if(this.detailsButton){this.detailsButton.getEl().on("click",this.onEditDetailsClick,this)}this.titleField=this.down("#"+this.id+"-title");this.dateRangeField=this.down("#"+this.id+"-dates");this.comborangefield=this.down("#"+this.id+"-plancombo");this.treedepartmentgrouprangefield=this.down("#"+this.id+"-treedepartmentrangefield");this.treerangefield=this.down("#"+this.id+"-treegrouprangefield");this.calendarField=this.down("#"+this.id+"-calendar")},onEditDetailsClick:function(e){e.stopEvent();this.updateRecord(this.activeRecord,true);this.fireEvent("editdetails",this,this.activeRecord,this.animateTarget)},show:function(e,t){var n=this,r=Extensible.calendar.data.EventMappings,s,o;n.animateTarget=Ext.isIE8&&Ext.isStrict?null:t;n.callParent([n.animateTarget,function(){n.titleField.focus(false,100)},n]);Ext.getCmp("cboScheduleRooms").setValue(-1);Ext.getCmp("chkScheduleEdited").setValue(false);Ext.getCmp("txtScheduleTitle").setValue("");Ext.getCmp("txtScheduleDepartment").setValue("");MyApp.util.Utilities.userScheduleID=Global.authData.userEmpInfo.ACEMP_ID*1;console.log(Global.authData.userEmpInfo.ACEMP_NAME);MyApp.util.Utilities.userScheduleName=Global.authData.userEmpInfo.ACEMP_NAME;Ext.getCmp("txtSchedulePerson").setValue(MyApp.util.Utilities.userScheduleName);console.debug("sau khi gan",Ext.getCmp("txtSchedulePerson").getValue());Ext.getCmp("rdPublic").setValue(true);Ext.getCmp("rdPrivate").setValue(false);s=n.formPanel.form;n.deleteButton[e.data&&e.data[r.EventId.name]?"show":"hide"]();n.setLoading(true,true);Ext.getStore("strpDepartment").load({callback:function(e,t,r){if(r){n.setLoading(false)}}});if(e.data){o=e;n.setTitle(o.phantom?n.titleTextAdd:n.titleTextEdit);s.loadRecord(o)}else{console.debug("Truoc khi load lai",Ext.getCmp("txtSchedulePerson").getValue());n.setTitle(n.titleTextAdd);var u=Extensible.Date.add(e[r.StartDate.name],{hours:8}),a=e[r.EndDate.name]||Extensible.Date.add(u,{hours:1});o=Ext.create("Extensible.calendar.data.EventModel");o.data[r.Title.name]=e[r.Title.name];o.data[r.StartDate.name]=u;o.data[r.EndDate.name]=a;o.data[r.IsAllDay.name]=!!e[r.IsAllDay.name]||u.getDate()!==Extensible.Date.add(a,{millis:1}).getDate();o.data[r.CalendarId.name]=n.calendarStore?n.calendarStore.getAt(0).data[Extensible.calendar.data.CalendarMappings.CalendarId.name]:"";if(r.Duration){o.data[r.Duration.name]=Extensible.Date.diff(u,a,Extensible.calendar.data.EventModel.resolution)}Ext.getStore("strpGroup").load();s.loadRecord(o)}if(r.RInstanceStartDate){o.data[r.RInstanceStartDate.name]=o.getStartDate()}if(!o.phantom){MyApp.util.Utilities.userScheduleID="";MyApp.util.Utilities.userScheduleName="";Ext.Ajax.request({type:"post",params:{scheduleId:parseInt(o.data.EventId)},url:apiUrl+"schedule/GetScheduleByScheduleID",success:function(e){data=Ext.decode(e.responseText,true);o.data.ProjectName=data["schedule"][0]["JOB_ID"];o.data.Url=data["schedule"][0]["JOB_NAME"];o.set("Title",data["schedule"][0]["TITLE"]);o.data.Room=data["schedule"][0]["ROOM_ID"];o.data.ScheduleType=data["schedule"][0]["SCHEDULE_TYPE_ID"];o.data.PrivacySchedule=data["schedule"][0]["OPENED_FLAG"];o.data.EditEnable=data["schedule"][0]["LOCK_FLAG"];var t=data["scheduleStaff"].length;if(0<t){for(i=0;i<t-1;i++){MyApp.util.Utilities.userScheduleID=MyApp.util.Utilities.userScheduleID+parseInt(data["scheduleStaff"][i]["USERID"])+",";MyApp.util.Utilities.userScheduleName=MyApp.util.Utilities.userScheduleName+data["scheduleStaff"][i]["USERNAME"]+","}MyApp.util.Utilities.userScheduleID=MyApp.util.Utilities.userScheduleID+data["scheduleStaff"][t-1]["USERID"];MyApp.util.Utilities.userScheduleName=MyApp.util.Utilities.userScheduleName+data["scheduleStaff"][t-1]["USERNAME"]}n.setLoading(true,true);Ext.getStore("strpGroup").load({callback:function(e,t,r){if(r){var i=MyApp.util.Utilities.userScheduleID.toString().split(",");Ext.getCmp("trpGroup").getView().node.cascadeBy(function(e){var t=i.indexOf(e.get("id"));if(t!=-1){e.set("checked",true);p=e.parentNode;var r=0;p.suspendEvents();p.eachChild(function(e){if(e.get("checked"))r++});if(r==p.childNodes.length){p.set("checked",true)}p.resumeEvents();n.expandParentsNode(e);i.splice(t,1)}});n.setLoading(false)}}});n.titleField.setValue(o.data.Title);Ext.getCmp("cboSchedulePlanType").setValue(parseInt(o.data.ScheduleType));Ext.getCmp("cboScheduleRooms").setValue(parseInt(o.data.Room));Ext.getCmp("txtScheduleDepartment").setValue(o.data.Url);Ext.getCmp("chkScheduleEdited").setValue(parseInt(o.data.EditEnable));Ext.getCmp("txtSchedulePerson").setValue(MyApp.util.Utilities.userScheduleName);n.treedepartmentgrouprangefield.items.items[0].items.items[5].items.items[0].getValue(parseInt(o.data.ProjectName));n.treedepartmentgrouprangefield.items.items[2].items.items[5].items.items[0].setValue(MyApp.util.Utilities.userScheduleID);if(1==parseInt(o.data.PrivacySchedule)){Ext.getCmp("rdPublic").setValue(true);Ext.getCmp("rdPrivate").setValue(false)}else{Ext.getCmp("rdPrivate").setValue(true);Ext.getCmp("rdPublic").setValue(false)}},failure:function(e,t){return},scope:this})}n.dateRangeField.setValue(o.data);n.activeRecord=o;s.getFields().each(function(e){e.resetOriginalValue()});return n},expandParentsNode:function(e){if(e.parentNode!==null){e.expand(false);this.expandParentsNode(e.parentNode)}},roundTime:function(e,t){t=t||15;var n=parseInt(e.getMinutes(),10);return e.add("mi",t-n%t)},onCancel:function(){this.cleanup(true);this.fireEvent("eventcancel",this,this.activeRecord,this.animateTarget)},cleanup:function(e){if(this.activeRecord){this.activeRecord.reject()}delete this.activeRecord;if(e===true){this.hide()}},updateRecord:function(e,t){var n=e.fields,r=this.formPanel.getForm().getValues(),i=Extensible.calendar.data.EventMappings,s,o={},u;n.each(function(e){s=e.name;if(s in r){o[s]=r[s]}});var a=this.dateRangeField.getValue(),f=o[i.IsAllDay.name]=a[2],l=f?Extensible.Date.clearTime(a[0]):a[0],c=f?Extensible.Date.clearTime(a[1]):a[1],h={days:1};h[Extensible.calendar.data.EventModel.resolution]=-1;if(f)l=Extensible.Date.add(l,{days:1});o[i.StartDate.name]=f?Extensible.Date.add(l,{hours:-9}):Extensible.Date.add(l,{hours:7});c=f?Extensible.Date.add(c,h):c;o[i.EndDate.name]=f?Extensible.Date.add(c,{hours:5}):Extensible.Date.add(c,{hours:7});if(i.Duration){o[i.Duration.name]=Extensible.Date.diff(l,o[i.EndDate.name],Extensible.calendar.data.EventModel.resolution)}var p=this.comborangefield.items.items;o[i.ScheduleType.name]=p[0].getValue();o[i.Room.name]=p[2].getValue();o[i.ScheduleStatus.name]=p[4].getValue();var d=this.treedepartmentgrouprangefield.items.items;o[i.ProjectName.name]=d[0].items.items[5].items.items[0].getValue();o[i.EditEnable.name]=d[2].items.items[0].items.items[0].getValue()?1:0;o[i.MemberSchedule.name]=d[2].items.items[5].items.items[0].getValue();var v=this.treerangefield.items.items;o[i.PrivacySchedule.name]=v[0].items.items[0].items.items[0].getValue()?1:0;e.beginEdit();e.set(o);if(!t||!u){e.endEdit()}return e.dirty||e.phantom&&this.allowDefaultAdd},onSave:function(){var e=this,t=e.formPanel.form,n=e.activeRecord.isRecurring();if(!t.isDirty()&&!e.allowDefaultAdd){e.onCancel();return}if(!t.isValid()){return}if(!e.updateRecord(e.activeRecord)){e.onCancel();return}if(""===e.activeRecord.data.Title.trim()){Ext.MessageBox.show({title:MessageCommon.ScheduleNoteTitle,msg:MessageCommon.MissingScheduleTitle,icon:Ext.MessageBox.INFO,buttons:Ext.Msg.OK});return}if(e.activeRecord.phantom){e.fireEvent("eventadd",e,e.activeRecord,e.animateTarget)}else{if(n&&e.activeRecord.isRecurring()){e.onRecurrenceUpdate()}else{e.fireEvent("eventupdate",e,e.activeRecord,e.animateTarget)}}},onRecurrenceUpdate:function(){this.rangeEditWin=this.rangeEditWin||Ext.WindowMgr.get("ext-cal-rangeeditwin");if(!this.rangeEditWin){this.rangeEditWin=new Extensible.form.recurrence.RangeEditWindow}this.rangeEditWin.prompt({callback:this.onRecurrenceEditModeSelected,scope:this})},onRecurrenceEditModeSelected:function(e){var t=this;if(e){t.activeRecord.data[Extensible.calendar.data.EventMappings.REditMode.name]=e;t.fireEvent("eventupdate",t,t.activeRecord,t.animateTarget)}},onDelete:function(){this.fireEvent("eventdelete",this,this.activeRecord,this.animateTarget)}});Ext.define("Extensible.calendar.view.AbstractCalendar",{extend:"Ext.Component",requires:["Ext.CompositeElement","Extensible.calendar.form.EventDetails","Extensible.calendar.form.EventWindow","Extensible.calendar.menu.Event","Extensible.calendar.dd.DragZone","Extensible.calendar.dd.DropZone","Extensible.form.recurrence.RangeEditWindow"],recurrence:false,recurrenceOptions:{expansionMode:"remote",expansionParam:{name:"singleEvents",value:true}},startDay:0,spansHavePriority:false,trackMouseOver:true,enableFx:true,enableAddFx:true,enableUpdateFx:false,enableRemoveFx:true,enableDD:true,enableContextMenus:true,suppressBrowserContextMenu:false,monitorResize:true,todayText:"Today",ddCreateEventText:"Create event for {0}",ddCopyEventText:"Copy event to {0}",ddMoveEventText:"Move event to {0}",ddResizeEventText:"Update event to {0}",defaultEventTitleText:"(No title)",dateParamStart:"startDate",dateParamEnd:"endDate",dateParamFormat:"Y-m-d",editModal:false,enableEditDetails:true,weekendCls:"ext-cal-day-we",prevMonthCls:"ext-cal-day-prev",nextMonthCls:"ext-cal-day-next",todayCls:"ext-cal-day-today",hideMode:"offsets",notifyOnExceptionTitle:"Server Error",notifyOnExceptionText:"The action failed with the following response:",notifyOnExceptionDefaultMessage:"An unknown error occurred",weekCount:1,dayCount:1,eventSelector:".ext-cal-evt",eventSelectorDepth:10,eventOverClass:"ext-evt-over",eventElIdDelimiter:"-evt-",dayElIdDelimiter:"-day-",recurringInstanceIdDelimiter:"-rid-",getEventBodyMarkup:Ext.emptyFn,getEventTemplate:Ext.emptyFn,initComponent:function(){this.setStartDate(MyApp.util.Utilities.dateSelected);this.callParent(arguments);if(this.readOnly===true){this.addCls("ext-cal-readonly")}this.addEvents({eventsrendered:true,eventclick:true,eventover:true,eventout:true,beforedatechange:true,datechange:true,rangeselect:true,beforeeventcopy:true,eventcopy:true,beforeeventmove:true,eventmove:true,initdrag:true,dayover:true,dayout:true,editdetails:true,eventadd:true,eventupdate:true,eventcancel:true,beforeeventdelete:true,eventdelete:true,eventexception:true})},afterRender:function(){this.callParent(arguments);this.renderTemplate();if(this.store){this.setStore(this.store,true);if(this.store.deferLoad){this.reloadStore(this.store.deferLoad);delete this.store.deferLoad}else{this.store.initialParams=this.getStoreParams()}}if(this.calendarStore){this.setCalendarStore(this.calendarStore,true)}this.on("resize",this.onResize,this);this.el.on({mouseover:this.onMouseOver,mouseout:this.onMouseOut,dblclick:this.onClick,scope:this});if(this.enableContextMenus&&this.readOnly!==true){this.el.on("contextmenu",this.onContextMenu,this)}this.el.unselectable();if(this.enableDD&&this.readOnly!==true&&this.initDD){this.initDD()}this.on("eventsrendered",this.onEventsRendered);Ext.defer(this.forceSize,100,this)},getStoreDateParams:function(){var e={};e[this.dateParamStart]=Ext.Date.format(this.viewStart,this.dateParamFormat);e[this.dateParamEnd]=Ext.Date.format(this.viewEnd,this.dateParamFormat);return e},getStoreParams:function(){var e=this.getStoreDateParams();return e},reloadStore:function(e){var t=this.recurrenceOptions;e=Ext.isObject(e)?e:{};e.params=e.params||{};Ext.apply(e.params,this.getStoreParams());if(this.recurrence&&t.expansionParam&&t.expansionMode==="remote"){e.params[t.expansionParam.name]=t.expansionParam.value}this.store.load(e)},onEventsRendered:function(){this.forceSize()},forceSize:function(){var e=this.el;if(e&&e.down){var t=e.down(".ext-cal-hd-ct"),n=e.down(".ext-cal-body-ct");if(!n||!t){return}var r=t.getHeight(),i=e.parent().getSize();n.setHeight(i.height-r)}},refresh:function(e){if(!this.isActiveView()){Extensible.log("refresh (AbstractCalendar), skipped for non-active view ("+this.id+")");return}Extensible.log("refresh (AbstractCalendar), reload = "+e);if(e===true){this.reloadStore()}else{this.prepareData();this.renderTemplate();this.renderItems()}},getWeekCount:function(){var e=Extensible.Date.diffDays(this.viewStart,this.viewEnd);return Math.ceil(e/this.dayCount)},prepareData:function(){var e=Ext.Date.getLastDateOfMonth(this.startDate),t=0,n=0,r=0,i=Ext.Date.clone(this.viewStart),s=this.weekCount<1?6:this.weekCount;this.eventGrid=[[]];this.allDayGrid=[[]];this.evtMaxCount=[];var o=this.store.queryBy(function(e){return this.isEventVisible(e.data)},this);var u=function(e){var r=Extensible.calendar.data.EventMappings,s=Ext.Date.clearTime(e.data[r.StartDate.name],true),o=i.getTime()===s.getTime(),u=t===0&&n===0&&i>e.data[r.StartDate.name];return o||u};for(;t<s;t++){this.evtMaxCount[t]=this.evtMaxCount[t]||0;if(this.weekCount===-1&&i>e){break}this.eventGrid[t]=this.eventGrid[t]||[];this.allDayGrid[t]=this.allDayGrid[t]||[];for(n=0;n<this.dayCount;n++){if(o.getCount()>0){var a=o.filterBy(u,this);this.sortEventRecordsForDay(a);this.prepareEventGrid(a,t,n)}i=Extensible.Date.add(i,{days:1})}}this.currentWeekCount=t},prepareEventGrid:function(e,t,n){var r=this,i=0,s=Ext.Date.clone(r.viewStart),o;e.each(function(e){var s=Extensible.calendar.data.EventMappings;if(Extensible.Date.diffDays(e.data[s.StartDate.name],e.data[s.EndDate.name])>0){var o=Extensible.Date.diffDays(Extensible.Date.max(r.viewStart,e.data[s.StartDate.name]),Extensible.Date.min(r.viewEnd,e.data[s.EndDate.name]))+1;r.prepareEventGridSpans(e,r.eventGrid,t,n,o);r.prepareEventGridSpans(e,r.allDayGrid,t,n,o,true)}else{i=r.findEmptyRowIndex(t,n);r.eventGrid[t][n]=r.eventGrid[t][n]||[];r.eventGrid[t][n][i]=e;if(e.data[s.IsAllDay.name]){i=r.findEmptyRowIndex(t,n,true);r.allDayGrid[t][n]=r.allDayGrid[t][n]||[];r.allDayGrid[t][n][i]=e}}r.setMaxEventsForDay(t,n);return true},r)},setMaxEventsForDay:function(e,t){var n=this.maxEventsPerDay+1||999;var r=this[this.isHeaderView?"allDayGrid":"eventGrid"][e][t]||[];this.evtMaxCount[e]=this.evtMaxCount[e]||0;if(r.length&&this.evtMaxCount[e]<r.length){this.evtMaxCount[e]=Math.min(n,r.length)}},prepareEventGridSpans:function(e,t,n,r,i,s){var o=n,u=r,a=this.findEmptyRowIndex(n,r,s),f=Ext.Date.clone(this.viewStart);var l={event:e,isSpan:true,isSpanStart:true,spanLeft:false,spanRight:r===6};t[n][r]=t[n][r]||[];t[n][r][a]=l;this.setMaxEventsForDay(n,r);while(--i){f=Extensible.Date.add(f,{days:1});if(f>this.viewEnd){break}if(++u>6){u=0;o++;a=this.findEmptyRowIndex(o,0)}t[o]=t[o]||[];t[o][u]=t[o][u]||[];t[o][u][a]={event:e,isSpan:true,isSpanStart:u===0,spanLeft:o>n&&u%7===0,spanRight:u===6&&i>1};this.setMaxEventsForDay(o,u)}},findEmptyRowIndex:function(e,t,n){var r=n?this.allDayGrid:this.eventGrid,i=r[e]?r[e][t]||[]:[],s=0,o=i.length;for(;s<o;s++){if(!i[s]){return s}}return o},renderTemplate:function(){if(this.tpl){this.tpl.overwrite(this.el,this.getTemplateParams());this.lastRenderStart=Ext.Date.clone(this.viewStart);this.lastRenderEnd=Ext.Date.clone(this.viewEnd)}},getTemplateParams:function(){return{viewStart:this.viewStart,viewEnd:this.viewEnd,startDate:this.startDate,dayCount:this.dayCount,weekCount:this.weekCount,weekendCls:this.weekendCls,prevMonthCls:this.prevMonthCls,nextMonthCls:this.nextMonthCls,todayCls:this.todayCls}},disableStoreEvents:function(){this.monitorStoreEvents=false;return this},enableStoreEvents:function(e){this.monitorStoreEvents=true;if(e===true){this.refresh()}return this},onResize:function(){this.refresh(false)},onInitDrag:function(){this.fireEvent("initdrag",this)},onEventDrop:function(e,t,n){this[(n||"move")+"Event"](e,t)},onCalendarEndDrag:function(e,t,n){this.dragPending=true;var r={},i=Ext.bind(this.onCalendarEndDragComplete,this,[n]);r[Extensible.calendar.data.EventMappings.StartDate.name]=e;r[Extensible.calendar.data.EventMappings.EndDate.name]=t;if(this.fireEvent("rangeselect",this,r,i)!==false){this.showEventEditor(r,null);if(this.editWin){this.editWin.on("hide",i,this,{single:true})}else{i()}}else{this.onCalendarEndDragComplete(i)}},onCalendarEndDragComplete:function(e){e();this.dragPending=false},refreshAfterEventChange:function(e,t){var n=Extensible.calendar.data.EventMappings.RInstanceStartDate,r=n&&!!t.records[0].get(n.name),i=(t.records[0].isRecurring()||r)&&!t.wasStoreReloadTriggered;if(i){t.wasStoreReloadTriggered=true}this.refresh(i)},onUpdate:function(e,t,n){if(this.hidden===true||this.ownerCt.hidden===true||this.monitorStoreEvents===false){return}if(n===Ext.data.Record.COMMIT){Extensible.log("onUpdate");this.dismissEventEditor();this.refreshAfterEventChange("update",t);var r=t.records[0];if(this.enableFx&&this.enableUpdateFx){this.doUpdateFx(this.getEventEls(r.data[Extensible.calendar.data.EventMappings.EventId.name]),{scope:this})}}},doUpdateFx:function(e,t){this.highlightEvent(e,null,t)},onAdd:function(e,t){var n=t.records[0];if(this.hidden===true||this.ownerCt.hidden===true||this.monitorStoreEvents===false){return}Extensible.log("onAdd");this.dismissEventEditor();this.refreshAfterEventChange("create",t)},doAddFx:function(e,t){e.fadeIn(Ext.apply(t,{duration:2e3}))},onRemove:function(e,t){if(this.hidden===true||this.ownerCt.hidden===true||this.monitorStoreEvents===false){return}Extensible.log("onRemove");this.dismissEventEditor();var n=t.records[0];if(this.enableFx&&this.enableRemoveFx){this.doRemoveFx(this.getEventEls(n.data[Extensible.calendar.data.EventMappings.EventId.name]),{remove:true,scope:this,callback:Ext.bind(this.refreshAfterEventChange,this,["delete",t])})}else{this.getEventEls(n.data[Extensible.calendar.data.EventMappings.EventId.name]).remove();this.refreshAfterEventChange("delete",t)}},doRemoveFx:function(e,t){if(e.getCount()===0&&Ext.isFunction(t.callback)){t.callback.call(t.scope||this)}else{e.fadeOut(t)}},highlightEvent:function(e,t,n){if(this.enableFx){if(Ext.isIE||Ext.isOpera){var r;e.each(function(e){e.highlight(t,Ext.applyif({attr:"color"},n));var r=e.down(".ext-cal-evm");if(r){r.highlight(t,n)}},this)}else{e.highlight(t,n)}}},getEventIdFromEl:function(e){e=Ext.get(e);var t,n="",r,i=e.dom.className.split(" ");Ext.each(i,function(e){t=e.split(this.eventElIdDelimiter);if(t.length>1){n=t[1];return false}},this);return n},getEventId:function(e){if(e===undefined&&this.tempEventId){e=this.tempEventId}return e},getEventSelectorCls:function(e,t){var n=t?".":"",r=this.getEventId(e),i=n+this.id+this.eventElIdDelimiter+r;return i},getEventEls:function(e){var t=this.el.select(this.getEventSelectorCls(this.getEventId(e),true),false);return Ext.create("Ext.CompositeElement",t)},isToday:function(){var e=Ext.Date.clearTime(new Date).getTime();return this.viewStart.getTime()<=e&&this.viewEnd.getTime()>=e},isEventVisible:function(e){var t=Extensible.calendar.data.EventMappings,n=Extensible.calendar.data.CalendarMappings,r=e.data||e,i=this.calendarStore?this.calendarStore.findRecord(n.CalendarId.name,e[t.CalendarId.name]):null;if(i&&i.data[n.IsHidden.name]===true){return false}var s=this.viewStart.getTime(),o=this.viewEnd.getTime(),u=r[t.StartDate.name].getTime(),a=r[t.EndDate.name].getTime();return Extensible.Date.rangesOverlap(s,o,u,a)},isOverlapping:function(e,t){var n=e.data?e.data:e,r=t.data?t.data:t,i=Extensible.calendar.data.EventMappings,s=n[i.StartDate.name].getTime(),o=Extensible.Date.add(n[i.EndDate.name],{seconds:-1}).getTime(),u=r[i.StartDate.name].getTime(),a=Extensible.Date.add(r[i.EndDate.name],{seconds:-1}).getTime(),f=Extensible.Date.diff(n[i.StartDate.name],r[i.StartDate.name],"m");if(o<s){o=s}if(a<u){a=u}var l=Extensible.Date.rangesOverlap(s,o,u,a),c=this.minEventDisplayMinutes||0,h=c>0&&f>-c&&f<c;return l||h},isEventSpanning:function(e){var t=Extensible.calendar.data.EventMappings,n=e.data||e,r;r=Extensible.Date.diffDays(n[t.StartDate.name],n[t.EndDate.name]);return r>0},getDayEl:function(e){return Ext.get(this.getDayId(e))},getDayId:function(e){if(Ext.isDate(e)){e=Ext.Date.format(e,"Ymd")}return this.id+this.dayElIdDelimiter+e},getStartDate:function(){return this.startDate},setStartDate:function(e,t){var n=this;var r=Ext.Date.format(e,"Y-m-d");Extensible.log("setStartDate (base) "+r);e=new Date(e);var i=Ext.Date.clone,s=n.startDate?i(n.startDate):null,o=i(e),u=n.viewStart?i(n.viewStart):null,a=n.viewEnd?i(n.viewEnd):null;if(n.fireEvent("beforedatechange",n,s,o,u,a)!==false){n.startDate=Ext.Date.clearTime(e);n.setViewBounds(e);if(n.ownerCalendarPanel&&n.ownerCalendarPanel.startDate!==n.startDate){n.ownerCalendarPanel.startDate=n.startDate}if(n.rendered){n.refresh(t)}n.fireEvent("datechange",n,i(n.startDate),i(n.viewStart),i(n.viewEnd))}},setViewBounds:function(e){var t=this,n=e||t.startDate,r=n.getDay()-t.startDay,i=Extensible.Date;if(r<0){r+=7}switch(this.weekCount){case 0:case 1:t.viewStart=t.dayCount<7&&!t.startDayIsStatic?n:i.add(n,{days:-r,clearTime:true});t.viewEnd=i.add(t.viewStart,{days:t.dayCount||7,seconds:-1});return;case-1:n=Ext.Date.getFirstDateOfMonth(n);r=n.getDay()-t.startDay;if(r<0){r+=7}t.viewStart=i.add(n,{days:-r,clearTime:true});var s=i.add(n,{months:1,seconds:-1});r=t.startDay;if(r>s.getDay()){r-=7}t.viewEnd=i.add(s,{days:6-s.getDay()+r});return;default:t.viewStart=i.add(n,{days:-r,clearTime:true});t.viewEnd=i.add(t.viewStart,{days:t.weekCount*7,seconds:-1})}},getViewBounds:function(){return{start:this.viewStart,end:this.viewEnd}},sortEventRecordsForDay:function(e){if(e.length<2){return}e.sortBy(Ext.bind(function(e,t){var n=e.data,r=t.data,i=Extensible.calendar.data.EventMappings;if(n[i.IsAllDay.name]){return-1}else if(r[i.IsAllDay.name]){return 1}if(this.spansHavePriority){var s=Extensible.Date.diffDays;if(s(n[i.StartDate.name],n[i.EndDate.name])>0){if(s(r[i.StartDate.name],r[i.EndDate.name])>0){if(n[i.StartDate.name].getTime()===r[i.StartDate.name].getTime()){return r[i.EndDate.name].getTime()-n[i.EndDate.name].getTime()}return n[i.StartDate.name].getTime()-r[i.StartDate.name].getTime()}return-1}else if(s(r[i.StartDate.name],r[i.EndDate.name])>0){return 1}return n[i.StartDate.name].getTime()-r[i.StartDate.name].getTime()}else{return n[i.StartDate.name].getTime()-r[i.StartDate.name].getTime()}},this))},moveTo:function(e,t){var n=Ext.Date.format(e,"Y-m-d");Extensible.log("setStartDate (base) "+n);Ext.getStore("StScheduleStoreId").getProxy().setExtraParam("currDate",n);if(Ext.isDate(e)){this.setStartDate(e,t);return this.startDate}return e},moveNext:function(e){return this.moveTo(Extensible.Date.add(this.viewEnd,{days:1}),e)},movePrev:function(e){var t=Extensible.Date.diffDays(this.viewStart,this.viewEnd)+1;return this.moveDays(-t,e)},moveMonths:function(e,t){return this.moveTo(Extensible.Date.add(this.startDate,{months:e}),t)},moveWeeks:function(e,t){return this.moveTo(Extensible.Date.add(this.startDate,{days:e*7}),t)},moveDays:function(e,t){return this.moveTo(Extensible.Date.add(this.startDate,{days:e}),t)},moveToday:function(e){return this.moveTo(new Date,e)},setStore:function(e,t){var n=this.store;if(!t&&n){n.un("load",this.onEventStoreLoad,this);n.un("clear",this.refresh,this);n.un("write",this.onWrite,this);n.getProxy().un("exception",this.onException,this)}if(e){e.on("load",this.onEventStoreLoad,this);e.on("clear",this.refresh,this);e.on("write",this.onWrite,this);e.getProxy().on("exception",this.onException,this)}this.store=e},onEventStoreLoad:function(e,t,n){Extensible.log("AbstractCalendar.onEventStoreLoad: store loaded");this.refresh(false)},onDataChanged:this.onEventStoreLoad,onException:function(e,t,n){Ext.each(n.records,function(e){if(e.dirty){if(e.phantom){e.unjoin(this.eventStore)}else{e.reject()}}},this);if(this.fireEvent("eventexception",this,t,n)!==false){this.notifyOnException(t,n)}},getExceptionMessage:function(e,t){var n="";if(e.responseText){n+="<br><b>responseText</b>: "+e.responseText}if(e.message){n+="<br><b>message</b>: "+e.message}if(e.status){n+="<br><b>status</b>: "+e.status}if(e.statusText){n+="<br><b>statusText</b>: "+e.statusText}if(t.error&&t.error.length){n+="<br><b>processing error</b>: "+t.error}return n||"<br>"+this.notifyOnExceptionDefaultMessage},notifyOnException:function(e,t){Ext.Msg.alert(this.notifyOnExceptionTitle,this.notifyOnExceptionText+"<br>"+this.getExceptionMessage(e,t))},setCalendarStore:function(e,t){if(!t&&this.calendarStore){this.calendarStore.un("datachanged",this.refresh,this);this.calendarStore.un("add",this.refresh,this);this.calendarStore.un("remove",this.refresh,this);this.calendarStore.un("update",this.refresh,this)}if(e){e.on("datachanged",this.refresh,this);e.on("add",this.refresh,this);e.on("remove",this.refresh,this);e.on("update",this.refresh,this)}this.calendarStore=e},getEventRecord:function(e){var t=this.store.find(Extensible.calendar.data.EventMappings.EventId.name,e,0,false,true,true);return this.store.getAt(t)},getEventRecordFromEl:function(e){return this.getEventRecord(this.getEventIdFromEl(e))},getEventEditor:function(){this.editWin=this.editWin||Ext.WindowMgr.get("ext-cal-editwin");if(!this.editWin){this.editWin=Ext.create("Extensible.calendar.form.EventWindow",{id:"ext-cal-editwin",calendarStore:this.calendarStore,modal:this.editModal,enableEditDetails:this.enableEditDetails,startDay:this.startDay,listeners:{eventadd:{fn:function(e,t,n,r){e.currentView.onEventEditorAdd(null,t,r)},scope:this},eventupdate:{fn:function(e,t,n,r){e.currentView.onEventEditorUpdate(null,t,r)},scope:this},eventdelete:{fn:function(e,t,n,r){e.currentView.onEventEditorDelete(null,t,r)},scope:this},editdetails:{fn:function(e,t,n,r){e.animateTarget=null;e.hide();e.currentView.fireEvent("editdetails",e.currentView,t)},scope:this},eventcancel:{fn:function(e,t,n){this.dismissEventEditor(null,n);e.currentView.onEventEditorCancel()},scope:this}}})}this.editWin.currentView=this;return this.editWin},showEventEditor:function(e,t){this.getEventEditor().show(e,t,this);return this},dismissEventEditor:function(e,t){if(this.newRecord&&this.newRecord.phantom){this.store.remove(this.newRecord)}delete this.newRecord;var n=Ext.WindowMgr.get("ext-cal-editwin");if(n){n[e?e:"hide"](t)}return this},save:function(e,t){var n=e.Room*1;var r=true;console.debug("data for adding schedule",e);if(0<n){Ext.Ajax.request({type:"rest",async:false,params:{arrayScheduleInfo:JSON.stringify(e)},url:apiUrl+"schedule/CheckRoom",success:function(e){r=Ext.decode(e.responseText,true);console.debug("a",r)},failure:function(){}})}if(r){if(0==t){console.log(t);Ext.Ajax.request({type:"rest",async:false,url:apiUrl+"schedule/AddSchedule",params:{arrayScheduleInfo:JSON.stringify(e)},success:function(e){},failure:function(e,t){Ext.MessageBox.show({title:MessageCommon.ScheduleErrorTitle,msg:MessageCommon.ScheduleError,icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});return},scope:this})}else if(1==t){Ext.Ajax.request({type:"rest",url:apiUrl+"schedule/EditSchedule",params:{arrayScheduleInfo:JSON.stringify(e)},success:function(e){},failure:function(e,t){Ext.MessageBox.show({title:MessageCommon.ScheduleErrorTitle,msg:MessageCommon.ScheduleError,icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});return},scope:this})}}else{Ext.MessageBox.show({title:MessageCommon.ScheduleErrorTitle,msg:"■指定の会議室は予約が入っています",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});return}if(2==t){Ext.Ajax.request({type:"rest",url:apiUrl+"schedule/DeleteSchedule",params:{arrayScheduleInfo:JSON.stringify(e)},success:function(e){},failure:function(e,t){Ext.MessageBox.show({title:MessageCommon.ScheduleErrorTitle,msg:MessageCommon.ScheduleError,icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK});return},scope:this})}if(!this.store.autoSync){this.store.sync()}},onWrite:function(e,t){if(t.wasSuccessful()){switch(t.action){case"create":this.onAdd(e,t);break;case"update":this.onUpdate(e,t,Ext.data.Record.COMMIT);break;case"destroy":this.onRemove(e,t);break}}},onEventEditorAdd:function(e,t){this.newRecord=t;if(this.store.indexOf(t)===-1){this.store.add(t)}console.log("data for adding schedule",t.data);this.save(t.data,0);this.fireEvent("eventadd",this,t)},onEventEditorUpdate:function(e,t){this.save(t.data,1);this.fireEvent("eventupdate",this,t)},onEventEditorDelete:function(e,t){t._deleting=true;this.deleteEvent(t)},onEventEditorCancel:function(e,t){this.fireEvent("eventcancel",this,t)},onDayClick:function(e,t,n){if(this.readOnly===true||0<Extensible.Date.diffDays(e,new Date)){return}if(this.fireEvent("dayclick",this,Ext.Date.clone(e),t,n)!==false){var r=Extensible.calendar.data.EventMappings,i={};if(null===n)i[r.StartDate.name]=Extensible.Date.add(e,{hours:-8});else i[r.StartDate.name]=e;i[r.IsAllDay.name]=t;this.showEventEditor(i,n)}},showEventMenu:function(e,t){var n=this;if(!n.eventMenu){n.eventMenu=Ext.create("Extensible.calendar.menu.Event",{startDay:n.startDay,ownerCalendarPanel:n,listeners:{editdetails:Ext.bind(n.onEditDetails,n),eventdelete:Ext.bind(n.onDeleteEvent,n),eventmove:Ext.bind(n.onMoveEvent,n),eventcopy:Ext.bind(n.onCopyEvent,n)}})}n.eventMenu.showForEvent(n.getEventRecordFromEl(e),e,t);n.menuActive=true},onCopyEvent:function(e,t,n){this.menuActive=false;this.shiftEvent(t,n,"copy")},onMoveEvent:function(e,t,n){this.menuActive=false;this.shiftEvent(t,n,"move")},copyEvent:function(e,t){this.shiftEvent(e,t,"copy")},moveEvent:function(e,t){this.shiftEvent(e,t,"move")},shiftEvent:function(e,t,n){var r=this,i;if(n==="move"){if(Extensible.Date.compare(e.getStartDate(),t)===0){return}i=e}else{i=e.clone()}if(r.fireEvent("beforeevent"+n,r,i,Ext.Date.clone(t))!==false){if(i.isRecurring()){r.onRecurrenceEditModeSelected("single",i,t,n)}else{r.doShiftEvent(i,t,n)}}},onRecurrenceEditModeSelected:function(e,t,n,r){var i=Extensible.calendar.data.EventMappings;if(e){if(r==="copy"){t.clearRecurrence()}t.data[i.REditMode.name]=e;t.data[i.RInstanceStartDate.name]=t.getStartDate();this.doShiftEvent(t,n,r)}},doShiftEvent:function(e,t,n){var r=Extensible.calendar.data.EventMappings,i=t.getTime()-e.getStartDate().getTime(),s={};s[r.StartDate.name]=t;s[r.EndDate.name]=Extensible.Date.add(e.getEndDate(),{millis:i});e.set(s);if(e.phantom){this.store.add(e)}this.save();this.fireEvent("event"+n,this,e)},onEditDetails:function(e,t,n){this.fireEvent("editdetails",this,t,n);this.menuActive=false},onDeleteEvent:function(e,t,n){t._deleting=true;this.deleteEvent(t,n);this.menuActive=false},deleteEvent:function(e,t){var n=this;if(n.fireEvent("beforeeventdelete",n,e,t)!==false){if(e.isRecurring()){this.rangeEditWin=this.rangeEditWin||Ext.WindowMgr.get("ext-cal-rangeeditwin");if(!this.rangeEditWin){this.rangeEditWin=new Extensible.form.recurrence.RangeEditWindow}this.rangeEditWin.prompt({callback:Ext.bind(n.onRecurrenceDeleteModeSelected,n,[e,t],true),scope:n})}else{n.doDeleteEvent(e,t)}}},onRecurrenceDeleteModeSelected:function(e,t,n){if(e){t.data[Extensible.calendar.data.EventMappings.REditMode.name]=e;t.data[Extensible.calendar.data.EventMappings.RInstanceStartDate.name]=t.getStartDate();this.doDeleteEvent(t,n)}},doDeleteEvent:function(e,t){this.store.remove(e);this.save(e.data,2);this.fireEvent("eventdelete",this,e,t)},onContextMenu:function(e,t){var n=e.getTarget(this.eventSelector,5,true),r=false;if(n){this.dismissEventEditor().showEventMenu(n,e.getXY());r=true}if(r||this.suppressBrowserContextMenu===true){e.preventDefault()}},onClick:function(e,t){var n=this,r=e.getTarget(n.eventSelector,5);if(n.dropZone){n.dropZone.clearShims()}if(n.menuActive===true){n.menuActive=false;return true}if(r){var i=n.getEventIdFromEl(r),s=n.getEventRecord(i);if(s&&n.fireEvent("eventclick",n,s,r)!==false){if(n.readOnly!==true&&0<=Extensible.Date.diffDays(new Date,s.data.StartDate)){n.showEventEditor(s,r)}}return true}},onMouseOver:function(e,t){if(this.trackMouseOver!==false&&(this.dragZone===undefined||!this.dragZone.dragging)){if(!this.handleEventMouseEvent(e,t,"over")){this.handleDayMouseEvent(e,t,"over")}}},onMouseOut:function(e,t){if(this.trackMouseOver!==false&&(this.dragZone===undefined||!this.dragZone.dragging)){if(!this.handleEventMouseEvent(e,t,"out")){this.handleDayMouseEvent(e,t,"out")}}},handleEventMouseEvent:function(e,t,n){var r=e.getTarget(this.eventSelector,this.eventSelectorDepth,true);if(r){var i=Ext.get(e.getRelatedTarget());if(r===i||r.contains(i)){return true}var s=this.getEventIdFromEl(r);if(this.eventOverClass!==""){var o=this.getEventEls(s);o[n==="over"?"addCls":"removeCls"](this.eventOverClass)}this.fireEvent("event"+n,this,this.getEventRecord(s),r);return true}return false},getDateFromId:function(e,t){var n=e.split(t);return n[n.length-1]},handleDayMouseEvent:function(e,t,n){t=e.getTarget("td",3);if(t){if(t.id&&t.id.indexOf(this.dayElIdDelimiter)>-1){var r=this.getDateFromId(t.id,this.dayElIdDelimiter),i=Ext.get(e.getRelatedTarget()),s,o;if(i){s=i.is("td")?i:i.up("td",3);o=s&&s.id?this.getDateFromId(s.id,this.dayElIdDelimiter):""}if(!i||r!==o){var u=this.getDayEl(r);if(u&&!Ext.isEmpty(this.dayOverClass)){u[n==="over"?"addCls":"removeCls"](this.dayOverClass)}this.fireEvent("day"+n,this,Ext.Date.parseDate(r,"Ymd"),u)}}}},renderItems:function(){throw"This method must be implemented by a subclass"},isActiveView:function(){var e=this.ownerCalendarPanel;return e&&e.getActiveView().id===this.id},destroy:function(){this.callParent(arguments);if(this.el){this.el.un("contextmenu",this.onContextMenu,this)}Ext.destroy(this.editWin,this.eventMenu,this.dragZone,this.dropZone)}});Ext.define("Extensible.calendar.view.MonthDayDetail",{extend:"Ext.Component",alias:"widget.extensible.monthdaydetailview",requires:["Ext.XTemplate","Extensible.calendar.view.AbstractCalendar"],initComponent:function(){this.callParent(arguments);this.addEvents({eventsrendered:true})},afterRender:function(){this.tpl=this.getTemplate();this.callParent(arguments);this.el.on({click:this.view.onClick,mouseover:this.view.onMouseOver,mouseout:this.view.onMouseOut,scope:this.view})},getTemplate:function(){if(!this.tpl){this.tpl=Ext.create("Ext.XTemplate",'<div class="ext-cal-mdv x-unselectable">','<table class="ext-cal-mvd-tbl" cellpadding="0" cellspacing="0">',"<tbody>",'<tpl for=".">','<tr><td class="ext-cal-ev">{markup}</td></tr>',"</tpl>","</tbody>","</table>","</div>")}this.tpl.compile();return this.tpl},update:function(e){this.date=e;this.refresh()},refresh:function(){if(!this.rendered){return}var e=this.view.getEventTemplate(),t=[];var n=this.store.queryBy(function(e){var t=Ext.Date.clearTime(this.date,true).getTime(),n=Extensible.calendar.data.EventMappings,r=Ext.Date.clearTime(e.data[n.StartDate.name],true).getTime(),i=t===r,s=false,o=e.data[n.CalendarId.name],u=this.calendarStore?this.calendarStore.getById(o):null;if(u&&u.data[Extensible.calendar.data.CalendarMappings.IsHidden.name]===true){return false}if(!i){var a=Ext.Date.clearTime(e.data[n.EndDate.name],true).getTime();s=r<t&&a>=t}return i||s},this);Extensible.calendar.view.AbstractCalendar.prototype.sortEventRecordsForDay.call(this,n);n.each(function(n){var r=n.data,i=Extensible.calendar.data.EventMappings;r._renderAsAllDay=r[i.IsAllDay.name]||Extensible.Date.diffDays(r[i.StartDate.name],r[i.EndDate.name])>0;r.spanLeft=Extensible.Date.diffDays(r[i.StartDate.name],this.date)>0;r.spanRight=Extensible.Date.diffDays(this.date,r[i.EndDate.name])>0;r.spanCls=r.spanLeft?r.spanRight?"ext-cal-ev-spanboth":"ext-cal-ev-spanleft":r.spanRight?"ext-cal-ev-spanright":"";t.push({markup:e.apply(this.getTemplateEventData(r))})},this);this.tpl.overwrite(this.el,t);this.fireEvent("eventsrendered",this,this.date,n.getCount())},getTemplateEventData:function(e){var t=this.view.getTemplateEventData(e);t._elId="dtl-"+t._elId;return t}});Ext.define("Extensible.calendar.view.Month",{extend:"Extensible.calendar.view.AbstractCalendar",alias:"widget.extensible.monthview",requires:["Ext.XTemplate","Ext.TaskManager","Extensible.calendar.template.Month","Extensible.calendar.util.WeekEventRenderer","Extensible.calendar.view.MonthDayDetail"],moreText:"+{0} more...",detailsTitleDateFormat:"F j",showTime:true,showTodayText:true,showHeader:false,showWeekLinks:false,showWeekNumbers:false,weekLinkOverClass:"ext-week-link-over",morePanelMinWidth:220,daySelector:".ext-cal-day",moreSelector:".ext-cal-ev-more",weekLinkSelector:".ext-cal-week-link",weekCount:-1,dayCount:7,moreElIdDelimiter:"-more-",weekLinkIdDelimiter:"ext-cal-week-",initComponent:function(){this.callParent(arguments);this.addEvents({dayclick:true,weekclick:true,dayover:true,dayout:true})},initDD:function(){var e={view:this,createText:this.ddCreateEventText,copyText:this.ddCopyEventText,moveText:this.ddMoveEventText,ddGroup:this.ddGroup||this.id+"-MonthViewDD"};this.dragZone=Ext.create("Extensible.calendar.dd.DragZone",this.el,e);this.dropZone=Ext.create("Extensible.calendar.dd.DropZone",this.el,e)},onDestroy:function(){Ext.destroy(this.ddSelector);Ext.destroy(this.dragZone);Ext.destroy(this.dropZone);this.callParent(arguments)},afterRender:function(){if(!this.tpl){this.tpl=Ext.create("Extensible.calendar.template.Month",{id:this.id,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime,showHeader:this.showHeader,showWeekLinks:this.showWeekLinks,showWeekNumbers:this.showWeekNumbers});this.tpl.compile()}this.addCls("ext-cal-monthview ext-cal-ct");this.callParent(arguments)},onResize:function(){if(this.monitorResize){this.maxEventsPerDay=this.getMaxEventsPerDay();this.refresh(false)}},forceSize:function(){if(this.showWeekLinks&&this.el){var e=this.el.down(".ext-cal-hd-days-tbl"),t=this.el.select(".ext-cal-bg-tbl"),n=this.el.select(".ext-cal-evt-tbl"),r=this.el.down(".ext-cal-week-link").getWidth(),i=this.el.getWidth()-r;e.setWidth(i);t.setWidth(i);n.setWidth(i)}this.callParent(arguments)},initClock:function(){if(Ext.fly(this.id+"-clock")!==null){this.prevClockDay=(new Date).getDay();if(this.clockTask){Ext.util.TaskManager.stop(this.clockTask)}this.clockTask=Ext.util.TaskManager.start({run:function(){var e=Ext.fly(this.id+"-clock"),t=new Date;if(t.getDay()===this.prevClockDay){if(e){e.update(Ext.Date.format(t,Extensible.Date.use24HourTime?"G:i":"g:ia"))}}else{this.prevClockDay=t.getDay();this.moveTo(t)}},scope:this,interval:1e3})}},getMoreText:function(e){return this.moreText},getEventBodyMarkup:function(){if(!this.eventBodyMarkup){this.eventBodyMarkup=["{Title}",'<tpl if="_isReminder">','<i class="ext-cal-ic ext-cal-ic-rem">&#160;</i>',"</tpl>",'<tpl if="_isRecurring">','<i class="ext-cal-ic ext-cal-ic-rcr">&#160;</i>',"</tpl>",'<tpl if="spanLeft">','<i class="ext-cal-spl">&#160;</i>',"</tpl>",'<tpl if="spanRight">','<i class="ext-cal-spr">&#160;</i>',"</tpl>"].join("")}return this.eventBodyMarkup},getEventTemplate:function(){if(!this.eventTpl){var e,t=this.getEventBodyMarkup();e=!(Ext.isIE||Ext.isOpera)?Ext.create("Ext.XTemplate",'<div class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evr">',t,"</div>"):Ext.create("Ext.XTemplate",'<tpl if="_renderAsAllDay">','<div class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evo">','<div class="ext-cal-evm">','<div class="ext-cal-evi">',"</tpl>",'<tpl if="!_renderAsAllDay">','<div class="{_extraCls} ext-cal-evt ext-cal-evr">',"</tpl>",t,'<tpl if="_renderAsAllDay">',"</div>","</div>","</tpl>","</div>");e.compile();this.eventTpl=e}return this.eventTpl},getTemplateEventData:function(e){var t=Extensible.calendar.data.EventMappings,n=[this.getEventSelectorCls(e[t.EventId.name])],r={},i="x-cal-default",s=e[t.Title.name],o=Extensible.Date.use24HourTime?"G:i ":"g:ia ",u;if(this.calendarStore&&e[t.CalendarId.name]){u=this.calendarStore.findRecord(Extensible.calendar.data.CalendarMappings.CalendarId.name,e[t.CalendarId.name]);if(u){i="x-cal-"+u.get(Extensible.calendar.data.CalendarMappings.ColorId.name)}}i+=e._renderAsAllDay?"-ad":"";n.push(i);if(e._renderAsAllDay){n.push("ext-evt-block")}if(this.getEventClass){u=this.getEventRecord(e[t.EventId.name]);var a=this.getEventClass(u,!!e._renderAsAllDay,r,this.store);n.push(a)}r._extraCls=n.join(" ");r._isRecurring=t.RRule&&!!e[t.RRule.name];r._isReminder=e[t.Reminder.name]&&e[t.Reminder.name]!=="";r.Title=(e[t.IsAllDay.name]?"":Ext.Date.format(e[t.StartDate.name],o))+(e[t.IsAllDay.name]?"":"- "+Ext.Date.format(e[t.EndDate.name],o))+(!s||s.length===0?this.defaultEventTitleText:s);return Ext.applyIf(r,e)},refresh:function(e){Extensible.log("refresh (MonthView)");if(this.detailPanel){this.detailPanel.hide()}if(!this.isHeaderView){this.maxEventsPerDay=this.getMaxEventsPerDay()}this.callParent(arguments);if(this.showTime!==false){this.initClock()}},renderItems:function(){Extensible.calendar.util.WeekEventRenderer.render({eventGrid:this.allDayOnly?this.allDayGrid:this.eventGrid,viewStart:this.viewStart,tpl:this.getEventTemplate(),maxEventsPerDay:this.maxEventsPerDay,viewId:this.id,templateDataFn:Ext.bind(this.getTemplateEventData,this),evtMaxCount:this.evtMaxCount,weekCount:this.weekCount,dayCount:this.dayCount,getMoreText:Ext.bind(this.getMoreText,this)});this.fireEvent("eventsrendered",this)},getDayEl:function(e){return Ext.get(this.getDayId(e))},getDayId:function(e){if(Ext.isDate(e)){e=Ext.Date.format(e,"Ymd")}return this.id+this.dayElIdDelimiter+e},getWeekIndex:function(e){var t=this.getDayEl(e).up(".ext-cal-wk-ct");return parseInt(t.id.split("-wk-")[1],10)},getDaySize:function(e){var t=this.el.getBox(),n=this.getViewPadding(),r=(t.width-n.width)/this.dayCount,i=(t.height-n.height)/this.getWeekCount();if(e){var s=this.el.select(".ext-cal-dtitle").last().parent("tr");i=s?i-s.getHeight(true):i}return{height:i,width:r}},getEventHeight:function(){if(!this.eventHeight){var e=this.el.select(".ext-cal-evt").first();if(e){this.eventHeight=e.parent("td").getHeight()}else{return 16}}return this.eventHeight},getMaxEventsPerDay:function(){var e=this.getDaySize(true).height,t=this.getEventHeight(),n=Math.max(Math.floor((e-t)/t),0);return n},getViewPadding:function(e){e=e||"tlbr";var t=e.indexOf("t")>-1,n=e.indexOf("l")>-1,r=e.indexOf("r")>-1,i=this.showHeader&&t?this.el.select(".ext-cal-hd-days-tbl").first().getHeight():0,s=0;if(this.isHeaderView){if(n){s=this.el.select(".ext-cal-gutter").first().getWidth()}if(r){s+=this.el.select(".ext-cal-gutter-rt").first().getWidth()}}else if(this.showWeekLinks&&n){s=this.el.select(".ext-cal-week-link").first().getWidth()}return{height:i,width:s}},getDayAt:function(e,t){var n=this.el.getBox(),r=this.getViewPadding("tl"),i=this.getDaySize(),s=Math.floor((e-n.x-r.width)/i.width),o=Math.floor((t-n.y-r.height)/i.height),u=o*7+s,a=Extensible.Date.add(this.viewStart,{days:u});return{date:a,el:this.getDayEl(a)}},moveNext:function(){return this.moveMonths(1,true)},movePrev:function(){return this.moveMonths(-1,true)},onInitDrag:function(){this.callParent(arguments);Ext.select(this.daySelector).removeCls(this.dayOverClass);if(this.detailPanel){this.detailPanel.hide()}},onMoreClick:function(e){if(!this.detailPanel){this.detailPanel=Ext.create("Ext.Panel",{id:this.id+"-details-panel",title:Ext.Date.format(e,this.detailsTitleDateFormat),layout:"fit",floating:true,renderTo:Ext.getBody(),hideMode:"offsets",tools:[{type:"close",handler:function(e,t,n){n.ownerCt.hide()}}],items:{xtype:"extensible.monthdaydetailview",id:this.id+"-details-view",date:e,view:this,store:this.store,calendarStore:this.calendarStore,listeners:{eventsrendered:Ext.bind(this.onDetailViewUpdated,this)}}});if(this.enableContextMenus&&this.readOnly!==true){this.detailPanel.body.on("contextmenu",this.onContextMenu,this)}}else{this.detailPanel.setTitle(Ext.Date.format(e,this.detailsTitleDateFormat))}this.detailPanel.getComponent(this.id+"-details-view").update(e)},onDetailViewUpdated:function(e,t,n){var r=this.detailPanel,i=this.getDayEl(t),s=i.getBox(),o=r.el.down(".ext-cal-mdv").getHeight(),u=r.getDockedItems("header")[0],a=r.frameSize||{top:0,bottom:0},f=a.top+a.bottom+u.getHeight(),l=o+f+5,c=Ext.getBody().getHeight()-20,h=Math.min(l,c);if(h===c){r.body.addCls("ext-cal-overflow-y")}else{r.body.removeCls("ext-cal-overflow-y")}r.setWidth(Math.max(s.width,this.morePanelMinWidth));r.setHeight(h);r.show();r.getPositionEl().alignTo(i,"t-t?")},onHide:function(){this.callParent(arguments);if(this.detailPanel){this.detailPanel.hide()}},onClick:function(e,t){if(this.detailPanel){this.detailPanel.hide()}var n=e.getTarget(this.moreSelector,3),r;if(n){r=n.id.split(this.moreElIdDelimiter)[1];this.onMoreClick(Ext.Date.parseDate(r,"Ymd"));return}n=e.getTarget(this.weekLinkSelector,3);if(n){r=n.id.split(this.weekLinkIdDelimiter)[1];this.fireEvent("weekclick",this,Ext.Date.parseDate(r,"Ymd"));return}if(Extensible.calendar.view.Month.superclass.onClick.apply(this,arguments)){return}n=e.getTarget("td",3);if(n){if(n.id&&n.id.indexOf(this.dayElIdDelimiter)>-1){var i=n.id.split(this.dayElIdDelimiter);r=i[i.length-1];this.onDayClick(Ext.Date.parseDate(r,"Ymd"),false,Ext.get(this.getDayId(r)));return}}},handleDayMouseEvent:function(e,t,n){var r=e.getTarget(this.weekLinkSelector,3,true);if(r){r[n==="over"?"addCls":"removeCls"](this.weekLinkOverClass);return}this.callParent(arguments)},destroy:function(){this.callParent(arguments);if(this.detailsPanel){this.detailPanel.body.un("contextmenu",this.onContextMenu,this)}}});Ext.define("Extensible.calendar.view.DayHeader",{extend:"Extensible.calendar.view.Month",alias:"widget.extensible.dayheaderview",requires:["Extensible.calendar.template.DayHeader"],weekCount:1,dayCount:1,allDayOnly:true,monitorResize:false,isHeaderView:true,afterRender:function(){if(!this.tpl){this.tpl=Ext.create("Extensible.calendar.template.DayHeader",{id:this.id,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime})}this.tpl.compile();this.addCls("ext-cal-day-header");this.callParent(arguments)},forceSize:Ext.emptyFn,refresh:function(e){Extensible.log("refresh (DayHeaderView)");this.callParent(arguments);this.recalcHeaderBox()},recalcHeaderBox:function(){var e=this.el.down(".ext-cal-evt-tbl"),t=e.getHeight();this.el.setHeight(t+7);this.el.down(".ext-cal-hd-ad-inner").setHeight(t+5);this.el.down(".ext-cal-bg-tbl").setHeight(t+5)},moveNext:function(){return this.moveDays(this.dayCount,false)},movePrev:function(){return this.moveDays(-this.dayCount,false)},onClick:function(e,t){var n=e.getTarget("td",3);if(n){if(n.id&&n.id.indexOf(this.dayElIdDelimiter)>-1){var r=n.id.split(this.dayElIdDelimiter),i=r[r.length-1];this.onDayClick(Ext.Date.parseDate(i,"Ymd"),true,Ext.get(this.getDayId(i,true)));return}}this.callParent(arguments)},isActiveView:function(){var e=this.ownerCalendarPanel;return e&&e.getActiveView().isDayView}});Ext.define("Extensible.calendar.view.DayBody",{extend:"Extensible.calendar.view.AbstractCalendar",alias:"widget.extensible.daybodyview",requires:["Ext.XTemplate","Extensible.calendar.template.DayBody","Extensible.calendar.data.EventMappings","Extensible.calendar.dd.DayDragZone","Extensible.calendar.dd.DayDropZone"],dayColumnElIdDelimiter:"-day-col-",hourIncrement:60,initComponent:function(){this.callParent(arguments);if(this.readOnly===true){this.enableEventResize=false}this.incrementsPerHour=this.hourIncrement/this.ddIncrement;this.minEventHeight=this.minEventDisplayMinutes/(this.hourIncrement/this.hourHeight);this.addEvents({beforeeventresize:true,eventresize:true,dayclick:true})},initDD:function(){var e={view:this,createText:this.ddCreateEventText,copyText:this.ddCopyEventText,moveText:this.ddMoveEventText,resizeText:this.ddResizeEventText,ddIncrement:this.ddIncrement,ddGroup:this.ddGroup||this.id+"-DayViewDD"};this.el.ddScrollConfig={vthresh:Ext.isIE||Ext.isOpera?100:40,hthresh:-1,frequency:50,increment:100,ddGroup:this.ddGroup||this.id+"-DayViewDD"};this.dragZone=Ext.create("Extensible.calendar.dd.DayDragZone",this.el,Ext.apply({},e));this.dropZone=Ext.create("Extensible.calendar.dd.DayDropZone",this.el,e)},refresh:function(e){Extensible.log("refresh (DayBodyView)");var t=this.el.getScroll().top;this.callParent(arguments);if(this.scrollReady){this.scrollTo(t)}},scrollTo:function(e,t){t=t||Ext.isIE||Ext.isOpera;if(t){Ext.defer(function(){this.el.scrollTo("top",e);this.scrollReady=true},10,this)}else{this.el.scrollTo("top",e);this.scrollReady=true}},afterRender:function(){if(!this.tpl){this.tpl=Ext.create("Extensible.calendar.template.DayBody",{id:this.id,dayCount:this.dayCount,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime,showHourSeparator:this.showHourSeparator,viewStartHour:this.viewStartHour,viewEndHour:this.viewEndHour,hourIncrement:this.hourIncrement,hourHeight:this.hourHeight,ddIncrement:this.ddIncrement})}this.tpl.compile();this.addCls("ext-cal-body-ct");this.callParent(arguments);var e=Math.max(this.scrollStartHour,this.viewStartHour),t=Math.max(0,e-this.viewStartHour);if(t>0){this.scrollTo(t*this.hourHeight)}},forceSize:Ext.emptyFn,onEventResize:function(e,t){var n=this,r=Extensible.calendar.data.EventMappings,i=Extensible.Date.compare;if(i(e.getStartDate(),t[r.StartDate.name])===0&&i(e.getEndDate(),t[r.EndDate.name])===0){return}if(n.fireEvent("beforeeventresize",n,e,t)!==false){if(e.isRecurring()){if(n.recurrenceOptions.editSingleOnResize){n.onRecurrenceResizeModeSelected("single",e,t)}else{this.rangeEditWin=this.rangeEditWin||Ext.WindowMgr.get("ext-cal-rangeeditwin");if(!this.rangeEditWin){this.rangeEditWin=new Extensible.form.recurrence.RangeEditWindow}this.rangeEditWin.prompt({callback:Ext.bind(n.onRecurrenceResizeModeSelected,n,[e,t],true),scope:n})}}else{n.doEventResize(e,t)}}},onRecurrenceResizeModeSelected:function(e,t,n){var r=Extensible.calendar.data.EventMappings;if(e){t.data[r.REditMode.name]=e;t.data[r.RInstanceStartDate.name]=t.getStartDate();this.doEventResize(t,n)}},doEventResize:function(e,t){var n=Extensible.calendar.data.EventMappings,r=n.StartDate.name,i=n.EndDate.name,s={};s[r]=t[r];s[i]=t[i];if(n.Duration){s[n.Duration.name]=Extensible.Date.diff(t[r],t[i],Extensible.calendar.data.EventModel.resolution)}e.set(s);this.save();this.fireEvent("eventupdate",this,e);this.fireEvent("eventresize",this,e)},getEventBodyMarkup:function(){if(!this.eventBodyMarkup){this.eventBodyMarkup=["{Title}",'<tpl if="_isReminder">','<i class="ext-cal-ic ext-cal-ic-rem">&#160;</i>',"</tpl>",'<tpl if="_isRecurring">','<i class="ext-cal-ic ext-cal-ic-rcr">&#160;</i>',"</tpl>"].join("")}return this.eventBodyMarkup},getEventTemplate:function(){if(!this.eventTpl){this.eventTpl=!(Ext.isIE||Ext.isOpera)?Ext.create("Ext.XTemplate",'<div id="{_elId}" class="{_extraCls} ext-cal-evt ext-cal-evr" ','style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">','<div class="ext-evt-bd">',this.getEventBodyMarkup(),"</div>",this.enableEventResize?'<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>':"","</div>"):Ext.create("Ext.XTemplate",'<div id="{_elId}" class="ext-cal-evt {_extraCls}" ','style="left: {_left}%; width: {_width}%; top: {_top}px;">','<div class="ext-cal-evb">&#160;</div>','<dl style="height: {_height}px;" class="ext-cal-evdm">','<dd class="ext-evt-bd">',this.getEventBodyMarkup(),"</dd>",this.enableEventResize?'<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>':"","</dl>",'<div class="ext-cal-evb">&#160;</div>',"</div>");this.eventTpl.compile()}return this.eventTpl},getEventAllDayTemplate:function(){if(!this.eventAllDayTpl){var e,t=this.getEventBodyMarkup();e=!(Ext.isIE||Ext.isOpera)?Ext.create("Ext.XTemplate",'<div class="{_extraCls} {spanCls} ext-cal-evt ext-cal-evr" ','style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">',t,"</div>"):Ext.create("Ext.XTemplate",'<div class="ext-cal-evt" ','style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">','<div class="{_extraCls} {spanCls} ext-cal-evo">','<div class="ext-cal-evm">','<div class="ext-cal-evi">',t,"</div>","</div>","</div>","</div>");e.compile();this.eventAllDayTpl=e}return this.eventAllDayTpl},getTemplateEventData:function(e){var t=Extensible.calendar.data.EventMappings,n=[this.getEventSelectorCls(e[t.EventId.name])],r={},i="x-cal-default",s=e[t.Title.name],o=Extensible.Date.use24HourTime?"G:i ":"g:ia ",u;this.getTemplateEventBox(e);if(this.calendarStore&&e[t.CalendarId.name]){u=this.calendarStore.findRecord(Extensible.calendar.data.CalendarMappings.CalendarId.name,e[t.CalendarId.name]);if(u){i="x-cal-"+u.data[Extensible.calendar.data.CalendarMappings.ColorId.name]}}i+=(e._renderAsAllDay?"-ad":"")+(Ext.isIE||Ext.isOpera?"-x":"");n.push(i);n.push("ext-evt-block");if(this.getEventClass){u=this.getEventRecord(e[t.EventId.name]);var a=this.getEventClass(u,!!e._renderAsAllDay,r,this.store);n.push(a)}r._extraCls=n.join(" ");r._isRecurring=t.RRule&&e[t.RRule.name]&&e[t.RRule.name]!=="";r._isReminder=e[t.Reminder.name]&&e[t.Reminder.name]!=="";r.Title=(e[t.IsAllDay.name]?"":Ext.Date.format(e[t.StartDate.name],o))+(!s||s.length===0?this.defaultEventTitleText:s);return Ext.applyIf(r,e)},getEventPositionOffsets:function(){return{top:0,height:-1}},getTemplateEventBox:function(e){var t=this.hourHeight/this.hourIncrement,n=e[Extensible.calendar.data.EventMappings.StartDate.name],r=e[Extensible.calendar.data.EventMappings.EndDate.name],i=Math.max(n.getHours()-this.viewStartHour,0),s=Math.min(r.getHours()-this.viewStartHour,this.viewEndHour-this.viewStartHour),o=i*this.hourIncrement,u=s*this.hourIncrement,a=Extensible.Date.add(Ext.Date.clone(r),{hours:this.viewEndHour,clearTime:true}),f=this.getEventPositionOffsets();if(n.getHours()>=this.viewStartHour){o+=n.getMinutes()}if(r<=a){u+=r.getMinutes()}e._left=0;e._width=100;e._top=o*t+f.top;e._height=Math.max((u-o)*t,this.minEventHeight)+f.height},renderItems:function(){var e=0,t,n=[];for(;e<this.dayCount;e++){var r=0,i=0,s=0,o=this.eventGrid[0][e],u=o?o.length:0;for(;r<u;r++){t=o[r];if(!t){continue}var a=t.data||t.event.data,f=Extensible.calendar.data.EventMappings,l=a[f.IsAllDay.name]===true,c=this.isEventSpanning(t.event||t),h=l||c;if(h){continue}Ext.apply(a,{cls:"ext-cal-ev",_positioned:true});n.push({data:this.getTemplateEventData(a),date:Extensible.Date.add(this.viewStart,{days:e})})}}var p=0,d=0,v=[],m=n.length,g,y,b;for(;p<m;p++){t=n[p].data;y=null;b=t[Extensible.calendar.data.EventMappings.StartDate.name].getDate();for(d=0;d<m;d++){if(p===d){continue}y=n[d].data;if(this.isOverlapping(t,y)){t._overlap=t._overlap===undefined?1:t._overlap+1;if(p<d){if(t._overcol===undefined){t._overcol=0}y._overcol=t._overcol+1;v[b]=v[b]?Math.max(v[b],y._overcol):y._overcol}}}}for(p=0;p<m;p++){t=n[p].data;b=t[Extensible.calendar.data.EventMappings.StartDate.name].getDate();if(t._overlap!==undefined){var w=100/(v[b]+1),E=100-w*t._overlap;t._width=w;t._left=w*t._overcol}var S=this.getEventTemplate().apply(t),x=this.id+"-day-col-"+Ext.Date.format(n[p].date,"Ymd");Ext.DomHelper.append(x,S)}this.fireEvent("eventsrendered",this)},getDayEl:function(e){return Ext.get(this.getDayId(e))},getDayId:function(e){if(Ext.isDate(e)){e=Ext.Date.format(e,"Ymd")}return this.id+this.dayColumnElIdDelimiter+e},getDaySize:function(){var e=this.el.down(".ext-cal-day-col-inner").getBox();return{height:e.height,width:e.width}},getDayAt:function(e,t){var n=".ext-cal-body-ct",r=this.el.down(".ext-cal-day-times").getWidth(),i=this.el.getBox(),s=this.getDaySize(false),o=e-i.x-r,u=Math.floor(o/s.width),a=this.el.getScroll(),f=this.el.down(".ext-cal-bg-row"),l=f.getHeight()/this.incrementsPerHour,c=t-i.y-l+a.top,h=Math.max(0,Math.ceil(c/l)),p=h*(this.hourIncrement/this.incrementsPerHour),d=Extensible.Date.add(this.viewStart,{days:u,minutes:p,hours:this.viewStartHour}),v=this.getDayEl(d),m=e;if(v){m=v.getLeft()}return{date:d,el:v,timeBox:{x:m,y:h*this.hourHeight/this.incrementsPerHour+i.y-a.top,width:s.width,height:l}}},onClick:function(e,t){if(this.dragPending||Extensible.calendar.view.DayBody.superclass.onClick.apply(this,arguments)){return}if(e.getTarget(".ext-cal-day-times",3)!==null){return}var n=e.getTarget("td",3);if(n){if(n.id&&n.id.indexOf(this.dayElIdDelimiter)>-1){var r=this.getDateFromId(n.id,this.dayElIdDelimiter);this.onDayClick(Ext.Date.parseDate(r,"Ymd"),true,Ext.get(this.getDayId(r)));return}}var i=this.getDayAt(e.getX(),e.getY());if(i&&i.date){this.onDayClick(i.date,false,null)}},isActiveView:function(){var e=this.ownerCalendarPanel;return e&&e.getActiveView().isDayView}});Ext.define("Extensible.calendar.view.Day",{extend:"Ext.container.Container",alias:"widget.extensible.dayview",requires:["Extensible.calendar.view.AbstractCalendar","Extensible.calendar.view.DayHeader","Extensible.calendar.view.DayBody"],showTime:true,showTodayText:true,dayCount:1,enableEventResize:true,ddIncrement:30,minEventDisplayMinutes:30,showHourSeparator:true,viewStartHour:8,viewEndHour:22,scrollStartHour:7,hourHeight:42,hideMode:"offsets",minBodyHeight:150,isDayView:true,initComponent:function(){this.ddCreateEventText=this.ddCreateEventText||Extensible.calendar.view.AbstractCalendar.prototype.ddCreateEventText;this.ddMoveEventText=this.ddMoveEventText||Extensible.calendar.view.AbstractCalendar.prototype.ddMoveEventText;this.dayCount=this.dayCount>7?7:this.dayCount<1?1:this.dayCount;var e=Ext.apply({},this.initialConfig);e.showTime=this.showTime;e.showTodayText=this.showTodayText;e.todayText=this.todayText;e.dayCount=this.dayCount;e.weekCount=1;e.readOnly=this.readOnly;e.ddIncrement=this.ddIncrement;e.minEventDisplayMinutes=this.minEventDisplayMinutes;var t=Ext.applyIf({xtype:"extensible.dayheaderview",id:this.id+"-hd",ownerCalendarPanel:this.ownerCalendarPanel},e);var n=Ext.applyIf({xtype:"extensible.daybodyview",enableEventResize:this.enableEventResize,showHourSeparator:this.showHourSeparator,viewStartHour:this.viewStartHour,viewEndHour:this.viewEndHour,scrollStartHour:this.scrollStartHour,hourHeight:this.hourHeight,id:this.id+"-bd",ownerCalendarPanel:this.ownerCalendarPanel},e);this.items=[t,n];this.addCls("ext-cal-dayview ext-cal-ct");this.callParent(arguments)},afterRender:function(){this.callParent(arguments);this.header=Ext.getCmp(this.id+"-hd");this.body=Ext.getCmp(this.id+"-bd");this.body.on("eventsrendered",this.forceSize,this);this.on("resize",this.onResize,this)},refresh:function(e){Extensible.log("refresh (DayView)");if(e===undefined){e=false}this.header.refresh(e);this.body.refresh(e)},forceSize:function(){var e=this;Ext.defer(function(){var t=e.el.up(".x-panel-body"),n=e.el.down(".ext-cal-day-header"),r=t?t.getHeight()-n.getHeight():false;if(r){if(r<e.minBodyHeight){r=e.minBodyHeight;e.addCls("ext-cal-overflow-y")}else{e.removeCls("ext-cal-overflow-y")}e.el.down(".ext-cal-body-ct").setHeight(r-1)}},Ext.isIE?1:0,e)},onResize:function(){this.forceSize();Ext.defer(this.refresh,Ext.isIE?1:0,this)},doHide:function(){this.header.doHide.apply(this,arguments);this.body.doHide.apply(this,arguments)},getViewBounds:function(){return this.header.getViewBounds()},getStartDate:function(){return this.header.getStartDate()},setStartDate:function(e){this.header.setStartDate(e,false);this.body.setStartDate(e,true)},renderItems:function(){this.header.renderItems();this.body.renderItems()},isToday:function(){return this.header.isToday()},moveTo:function(e){e=this.header.moveTo(e,false);this.body.moveTo(e,true);this.forceSize();return e},moveNext:function(){var e=this.header.moveNext(false);this.body.moveNext(true);this.forceSize();return e},movePrev:function(e){var t=this.header.movePrev(false);this.body.movePrev(true);this.forceSize();return t},moveDays:function(e){var t=this.header.moveDays(e,false);this.body.moveDays(e,true);this.forceSize();return t},moveToday:function(){var e=this.header.moveToday(false);this.body.moveToday(true);this.forceSize();return e},showEventEditor:function(e,t){return Extensible.calendar.view.AbstractCalendar.prototype.showEventEditor.apply(this,arguments)},dismissEventEditor:function(e){return Extensible.calendar.view.AbstractCalendar.prototype.dismissEventEditor.apply(this,arguments)}});Ext.define("Extensible.calendar.view.MultiDay",{extend:"Extensible.calendar.view.Day",alias:"widget.extensible.multidayview",dayCount:3,startDayIsStatic:false,moveNext:function(e){return this.moveDays(this.startDayIsStatic?7:this.dayCount,e)},movePrev:function(e){return this.moveDays(this.startDayIsStatic?-7:-this.dayCount,e)}});Ext.define("Extensible.calendar.view.Week",{extend:"Extensible.calendar.view.MultiDay",alias:"widget.extensible.weekview",dayCount:7});Ext.define("Extensible.calendar.view.MultiWeek",{extend:"Extensible.calendar.view.Month",alias:"widget.extensible.multiweekview",weekCount:2,moveNext:function(){return this.moveWeeks(this.weekCount,true)},movePrev:function(){return this.moveWeeks(-this.weekCount,true)}});Ext.define("Extensible.calendar.CalendarPanel",{extend:"Ext.panel.Panel",alias:"widget.extensible.calendarpanel",requires:["Ext.layout.container.Card","Extensible.calendar.view.Day","Extensible.calendar.view.Week","Extensible.calendar.view.Month","Extensible.calendar.view.MultiDay","Extensible.calendar.view.MultiWeek"],recurrence:false,showDayView:true,showMultiDayView:false,showWeekView:true,showMultiWeekView:true,showMonthView:true,showNavBar:true,todayText:"本日",showTodayText:true,showTime:true,readOnly:false,showNavToday:true,showNavJump:true,showNavNextPrev:true,jumpToText:"移動",goText:"時間切り",dayText:"日",multiDayText:"{0} Days",weekText:"週",multiWeekText:"{0} Weeks",monthText:"月",editModal:false,enableEditDetails:true,startDay:0,layout:{type:"card",deferredRender:true},startDate:new Date,initComponent:function(){this.tbar={cls:"ext-cal-toolbar",border:true,items:[]};if(MyApp.util.Utilities.dateSelected.toString().length>10){var e=MyApp.util.Utilities.dateSelected.getDate();var t=MyApp.util.Utilities.dateSelected.getMonth()+1;var n=MyApp.util.Utilities.dateSelected.getFullYear();if(e<10){e="0"+e}if(t<10){t="0"+t}startDate=n+"-"+t+"-"+e}else startDate=MyApp.util.Utilities.dateSelected;this.viewCount=0;var r,i=this.multiDayViewCfg&&this.multiDayViewCfg.dayCount||3,s=this.multiWeekViewCfg&&this.multiWeekViewCfg.weekCount||2;if(this.showNavToday){this.tbar.items.push({id:this.id+"-tb-today",text:this.todayText,handler:this.onTodayClick,scope:this})}if(this.showNavNextPrev){this.tbar.items.push({id:this.id+"-tb-prev",handler:this.onPrevClick,scope:this,iconCls:"x-tbar-page-prev"});this.tbar.items.push({id:this.id+"-tb-next",handler:this.onNextClick,scope:this,iconCls:"x-tbar-page-next"})}var o=Ext.create("Ext.data.Store",{fields:["abbr","name"],data:[{abbr:"10",name:"10 分"},{abbr:"15",name:"15 分"},{abbr:"30",name:"30 分"}]});if(this.showNavJump){this.tbar.items.push(this.jumpToText);this.tbar.items.push({itemId:"dateItemId",id:this.id+"-tb-jump-dt",xtype:"datefield",value:new Date(MyApp.util.Utilities.dateSelected),format:"Y/m/d",width:120,showToday:false,startDay:this.startDay,listeners:{change:{fn:function(){this.onJumpClick()},scope:this}}});this.tbar.items.push({id:this.id+"-tb-emptyLabel-dt",xtype:"label",text:"",labelWidth:150});this.tbar.items.push({itemId:"segmentItemId",id:this.id+"-tb-combo-dt",xtype:"combobox",disabled:2<MyApp.util.Utilities.activeViewValue?true:false,valueField:"abbr",displayField:"name",value:"30 分",store:o,width:120,listeners:{change:{fn:function(e){var t=Ext.getCmp(this.id+"-tb-combo-dt").getValue();if(MyApp.util.Utilities.segmentTime!==t){MyApp.util.Utilities.segmentTime=t;MyApp.app.common.callbackSchedule(MyApp.util.Utilities.segmentTime,Ext.getCmp(this.id+"-tb-combo-dt").getItemId(),Ext.getCmp(this.id+"-tb-jump-dt").getValue(),Ext.getCmp(this.id+"-tb-jump-dt").getItemId(),MyApp.util.Utilities.activeViewValue)}},scope:this}},scope:this})}this.tbar.items.push("->");if(this.showDayView){this.tbar.items.push({id:this.id+"-tb-day",text:this.dayText,handler:this.onDayNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showMultiDayView){r=Ext.String.format(this.getMultiDayText(i),i);this.tbar.items.push({id:this.id+"-tb-multiday",text:r,handler:this.onMultiDayNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showWeekView){this.tbar.items.push({id:this.id+"-tb-week",text:this.weekText,handler:this.onWeekNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showMultiWeekView){r=Ext.String.format(this.getMultiWeekText(s),s);this.tbar.items.push({id:this.id+"-tb-multiweek",text:r,handler:this.onMultiWeekNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++}if(this.showMonthView||this.viewCount===0){this.tbar.items.push({id:this.id+"-tb-month",text:this.monthText,handler:this.onMonthNavClick,scope:this,toggleGroup:this.id+"-tb-views"});this.viewCount++;this.showMonthView=true}var u=this.viewCount-1;this.activeItem=this.activeItem===undefined?u:this.activeItem>u?u:this.activeItem;if(this.showNavBar===false){delete this.tbar;this.addCls("x-calendar-nonav")}this.callParent(arguments);this.addEvents({eventadd:true,eventupdate:true,beforeeventdelete:true,eventdelete:true,eventcancel:true,viewchange:true,editdetails:true});this.addCls("x-cal-panel");if(this.eventStore){this.store=this.eventStore;delete this.eventStore}this.setStore(this.store);var a={showToday:this.showToday,todayText:this.todayText,showTodayText:this.showTodayText,showTime:this.showTime,readOnly:this.readOnly,recurrence:this.recurrence,store:this.store,calendarStore:this.calendarStore,editModal:this.editModal,enableEditDetails:this.enableEditDetails,startDay:this.startDay,ownerCalendarPanel:this};if(this.showDayView){var f=Ext.apply({xtype:"extensible.dayview",title:this.dayText},a);f=Ext.apply(Ext.apply(f,this.viewConfig),this.dayViewCfg);f.id=this.id+"-day";this.initEventRelay(f);this.add(f)}if(this.showMultiDayView){var l=Ext.apply({xtype:"extensible.multidayview",title:this.getMultiDayText(i)},a);l=Ext.apply(Ext.apply(l,this.viewConfig),this.multiDayViewCfg);l.id=this.id+"-multiday";this.initEventRelay(l);this.add(l)}if(this.showWeekView){var c=Ext.applyIf({xtype:"extensible.weekview",title:this.weekText},a);c=Ext.apply(Ext.apply(c,this.viewConfig),this.weekViewCfg);c.id=this.id+"-week";this.initEventRelay(c);this.add(c)}if(this.showMultiWeekView){var h=Ext.applyIf({xtype:"extensible.multiweekview",title:this.getMultiWeekText(s)},a);h=Ext.apply(Ext.apply(h,this.viewConfig),this.multiWeekViewCfg);h.id=this.id+"-multiweek";this.initEventRelay(h);this.add(h)}if(this.showMonthView){var p=Ext.applyIf({xtype:"extensible.monthview",title:this.monthText,listeners:{weekclick:{fn:function(e,t){this.showWeek(t)},scope:this}}},a);p=Ext.apply(Ext.apply(p,this.viewConfig),this.monthViewCfg);p.id=this.id+"-month";this.initEventRelay(p);this.add(p)}this.add(Ext.applyIf({xtype:"extensible.eventeditform",id:this.id+"-edit",calendarStore:this.calendarStore,recurrence:this.recurrence,startDay:this.startDay,listeners:{eventadd:{scope:this,fn:this.onEventAdd},eventupdate:{scope:this,fn:this.onEventUpdate},eventdelete:{scope:this,fn:this.onEventDelete},eventcancel:{scope:this,fn:this.onEventCancel}}},this.editViewCfg))},initEventRelay:function(e){e.listeners=e.listeners||{};e.listeners.afterrender={fn:function(e){this.relayEvents(e,["eventsrendered","eventclick","dayclick","eventover","eventout","beforedatechange","datechange","rangeselect","beforeeventcopy","eventcopy","beforeeventmove","eventmove","initdrag","dayover","dayout","beforeeventresize","eventresize","eventadd","eventupdate","beforeeventdelete","eventdelete","eventcancel","eventexception"]);e.on("editdetails",this.onEditDetails,this)},scope:this,single:true}},afterRender:function(){this.callParent(arguments);this.body.addCls("x-cal-body");this.updateNavState();this.setActiveView()},getMultiDayText:function(e){return this.multiDayText},getMultiWeekText:function(e){return this.multiWeekText},setStore:function(e,t){var n=this.store;if(!t&&n){n.un("write",this.onWrite,this)}if(e){e.on("write",this.onWrite,this)}this.store=e},onStoreAdd:function(e,t,n){this.hideEditForm()},onStoreUpdate:function(e,t,n){if(n===Ext.data.Record.COMMIT){this.hideEditForm()}},onStoreRemove:function(e,t){this.hideEditForm()},onWrite:function(e,t){var n=t.records[0];switch(t.action){case"create":this.onStoreAdd(e,n);break;case"update":this.onStoreUpdate(e,n,Ext.data.Record.COMMIT);break;case"destroy":this.onStoreRemove(e,n);break}},onEditDetails:function(e,t,n){if(this.fireEvent("editdetails",this,e,t,n)!==false){this.showEditForm(t)}},save:function(){if(!this.store.autoSync){this.store.sync()}},onEventAdd:function(e,t){if(!t.store){this.store.add(t);this.save()}this.fireEvent("eventadd",this,t)},onEventUpdate:function(e,t){this.save();this.fireEvent("eventupdate",this,t)},onEventDelete:function(e,t){this.store.remove(t);this.save();this.fireEvent("eventdelete",this,t)},onEventCancel:function(e,t){this.hideEditForm();this.fireEvent("eventcancel",this,t)},showEditForm:function(e){this.preEditView=this.layout.getActiveItem().id;this.setActiveView(this.id+"-edit");this.layout.getActiveItem().loadRecord(e);return this},hideEditForm:function(){if(this.preEditView){this.setActiveView(this.preEditView);delete this.preEditView}return this},setActiveView:function(e,t){var n=this,r=n.layout,i=n.id+"-edit",s;if(t){n.startDate=t}if(e!==r.getActiveItem().id){s=n.getDockedItems("toolbar")[0];if(s){s[e===i?"hide":"show"]()}r.setActiveItem(e||n.activeItem);n.doComponentLayout();n.activeView=r.getActiveItem();if(e!==i){if(e&&e!==n.preEditView){r.activeItem.setStartDate(n.startDate,true)}n.updateNavState()}n.fireViewChange()}},fireViewChange:function(){if(this.layout&&this.layout.getActiveItem){var e=this.layout.getActiveItem(),t=Ext.Date.clone;if(e){var n;if(e.getViewBounds){var r=e.getViewBounds();n={viewStart:t(r.start),viewEnd:t(r.end),activeDate:t(e.getStartDate())}}if(e.dismissEventEditor){e.dismissEventEditor()}this.fireEvent("viewchange",this,e,n)}}},updateNavState:function(){var e=this,t=e.layout.activeItem;if(t&&e.showNavBar!==false){var n=t.id.split(e.id+"-")[1],r=Ext.getCmp(e.id+"-tb-"+n);if(e.showNavToday){Ext.getCmp(e.id+"-tb-today").setDisabled(t.isToday())}r.toggle(true)}},setStartDate:function(e){Extensible.log("setStartDate (CalendarPanel");this.startDate=e;this.layout.activeItem.setStartDate(e,true);this.updateNavState();this.fireViewChange();return this},showWeek:function(e){this.setActiveView(this.id+"-week",e)},onTodayClick:function(){if(Ext.getCmp(this.id+"-tb-jump-dt").getValue())Ext.getCmp(this.id+"-tb-jump-dt").setValue("");this.startDate=this.layout.activeItem.moveToday(true);this.updateNavState();this.fireViewChange()},onJumpClick:function(){var e=Ext.getCmp(this.id+"-tb-jump-dt").getValue();if(e!==""){MyApp.util.Utilities.dateSelected=MyApp.app.common.getScheduleToday(e);this.startDate=this.layout.activeItem.moveTo(e,true);this.updateNavState();this.fireViewChange()}},onPrevClick:function(){this.startDate=this.layout.activeItem.movePrev(true);this.updateNavState();this.fireViewChange()},onNextClick:function(){this.startDate=this.layout.activeItem.moveNext(true);this.updateNavState();this.fireViewChange()},onDayNavClick:function(){MyApp.util.Utilities.activeViewValue=0;Ext.getCmp(this.id+"-tb-combo-dt").enable();this.setActiveView(this.id+"-day")},onMultiDayNavClick:function(){this.setActiveView(this.id+"-multiday")},onWeekNavClick:function(){MyApp.util.Utilities.activeViewValue=1;Ext.getCmp(this.id+"-tb-combo-dt").enable();this.setActiveView(this.id+"-week")},onMultiWeekNavClick:function(){this.setActiveView(this.id+"-multiweek")},onMonthNavClick:function(){MyApp.util.Utilities.activeViewValue=2;Ext.getCmp(this.id+"-tb-combo-dt").disable();this.setActiveView(this.id+"-month")},getActiveView:function(){return this.layout.activeItem}})